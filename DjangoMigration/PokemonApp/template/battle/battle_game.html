{% extends "base.html" %}
{% load static %}

{% block title %}
<title>Combat - {{ battle.player_pokemon.species.name }} VS {{ battle.opponent_pokemon.species.name }}</title>
{% endblock title %}

{% block content %}
<style>
  /* Masquer le container par défaut pour le mode plein écran */
/* .battle-arena {
    background-image: url('{% static "img/background.png" %}');
    background-size: cover; 
    background-position: center bottom; 
    background-repeat: no-repeat;
    position: relative;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    height: 60vh;
    width: 100%;
}

  .battle-ground {
    position: relative;
    height: 60vh;
  }
  .pokemon-sprite-player {
    position: absolute;
    left: 10vw;
    width: 35vh;
    height: 35vh;
    filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.5));
    animation: bounce 2s ease-in-out infinite;
  }

  .pokemon-sprite-opponent {
    position: absolute;
    right: 10vw;
    width: 35vh;
    height: 35vh;
    filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.5));
    animation: float 3s ease-in-out infinite;
  }

  .pokemon-info-player {
    position: absolute;
    bottom: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.95);
    border: 3px solid #333;
    border-radius: 10px;
    padding: 15px;
    min-width: 300px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  }

  .pokemon-info-opponent {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.95);
    border: 3px solid #333;
    border-radius: 10px;
    padding: 15px;
    min-width: 300px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  } */


.battle-arena {
  background-image: url('{% static "img/background.png" %}');
  background-size: cover;
  background-position: center bottom;
  background-repeat: no-repeat;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  height: 60vh;
  width: 100%;
  position: relative;
}

.battle-ground {
  display: flex;
  justify-content: space-between;
  align-items: flex-start; 
  height: 100%;
  padding: 20px;
  box-sizing: border-box;
}

.pokemon-sprite-opponent,
.pokemon-sprite-player {
  width: 35vh;
  height: 35vh;
  filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.5));
  
}

.pokemon-sprite-player {
    transform: scaleX(-1) translateY(0); /* Combine les transformations */ /* Retourne horizontalement le sprite */
    animation: bounce-flipped 2s ease-in-out infinite; /* Animation adaptée */

}

.opponent-container {
  order: 2; /* Place l'adversaire à droite */
  align-items: flex-end;
  margin-bottom: 25vh;
  margin-right: 10vw
}

.player-container {
  order: 1; /* Place le joueur à gauche */
  align-items: flex-start;
  margin-top: 25vh;
  margin-left: 10vw;
}

.pokemon-sprite-opponent {
  animation: bounce 2s ease-in-out infinite;
  animation-name: float;
  animation-duration: 3s;
}

/* Boîte d'info de l'adversaire : en haut à gauche */
.pokemon-info-opponent {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(255, 255, 255, 0.8);
  padding: 10px;
  border-radius: 5px;
  text-align: left;
  z-index: 10;
}

/* Boîte d'info du joueur : en bas à droite */
.pokemon-info-player {
  position: absolute;
  bottom: 10px;
  right: 10px;
  background: rgba(255, 255, 255, 0.8);
  padding: 10px;
  border-radius: 5px;
  text-align: left;
  z-index: 10;
}

/* Effet de boîte */
.pokemon-info-opponent,
.pokemon-info-player {
    text-align: center;
    background: rgba(255, 255, 255, 0.95);
    border: 3px solid #333;
    border-radius: 10px;
    padding: 15px;
    min-width: 300px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}



  @keyframes bounce-flipped {
    0%, 100% {
      transform: translateY(0) scaleX(-1); /* Combine translation et rotation */
    }
    50% {
      transform: translateY(-15px) scaleX(-1);
    }
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  @keyframes float {
    0%, 100% { transform: translateY(0) translateX(0); }
    50% { transform: translateY(-15px) translateX(5px); }
  }


  .hp-bar-battle {
    height: 20px;
    background: #e0e0e0;
    border: 2px solid #333;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
  }

  .hp-bar-fill-battle {
    height: 100%;
    transition: width 0.5s ease;
    position: relative;
  }

  .hp-bar-fill-battle::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, rgba(255,255,255,0.3) 0%, transparent 50%, rgba(0,0,0,0.2) 100%);
  }

  /* Battle Menu */
  .battle-menu {
    background: rgba(255, 255, 255, 0.98);
    border: 3px solid #333;
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  }

  .battle-action-btn {
    font-size: 1.1rem;
    font-weight: bold;
    text-transform: uppercase;
    border: 3px solid;
    transition: all 0.3s ease;
  }

  .battle-action-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }

  .move-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: #5568d3;
    color: white;
    margin: 5px;
    min-width: 45%;
    padding: 15px;
  }

  .move-btn:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    color: white;
  }

  .move-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Battle Log */
  .battle-log-box {
    background: rgba(0, 0, 0, 0.8);
    color: white;
    border-radius: 10px;
    padding: 15px;
    min-height: 100px;
    max-height: 150px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.95rem;
    margin-top: 10px;
  }

  .battle-log-box p {
    margin-bottom: 5px;
    animation: fadeIn 0.5s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Damage Animation */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
  }

  .taking-damage {
    animation: shake 0.5s ease;
  }

  /* Status Icons */
  .status-icon {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 0.75rem;
    font-weight: bold;
    margin-left: 5px;
  }

  .status-paralysis { background: #f39c12; color: white; }
  .status-poison { background: #9b59b6; color: white; }
  .status-burn { background: #e74c3c; color: white; }
  .status-freeze { background: #3498db; color: white; }
  .status-sleep { background: #95a5a6; color: white; }

  /* Victory/Defeat Modal */
  .battle-result-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 1s ease;
  }

  .battle-result-content {
    background: white;
    padding: 50px;
    border-radius: 20px;
    text-align: center;
    box-shadow: 0 10px 50px rgba(0,0,0,0.5);
  }
</style>

<!-- Battle Arena -->
<div class="battle-arena">
  <div class="battle-ground">
    <!-- Conteneur pour l'adversaire -->
    <div class="pokemon-container opponent-container">

      <!-- Pokemon Sprite -->
      <img id="opponent-sprite"
           src="{% static 'img/sprites_gen1/' %}{{ battle.opponent_pokemon.species.name }}.png"
           alt="{{ battle.opponent_pokemon.species.name }}"
           class="pokemon-sprite-opponent"
           onerror="this.src='{% static 'img/pokeball.png' %}'">

      <!-- Opponent Info Box -->
      <div class="pokemon-info-opponent">
        <h5 class="mb-2">
          <span id="opponent-name">{{ battle.opponent_pokemon.species.name }}</span>
          <span id="opponent-status"></span>
        </h5>
        <small class="text-muted" id="opponent-level">Niv. {{ battle.opponent_pokemon.level }}</small>
        <div class="hp-bar-battle mt-2">
          <div id="opponent-hp-bar" class="hp-bar-fill-battle hp-high" 
              style="width: {% widthratio battle.opponent_pokemon.current_hp battle.opponent_pokemon.max_hp 100 %}%"></div>
        </div>
        <small class="d-block mt-1">
          HP: <span id="opponent-hp-text" data-current-hp="{{ battle.opponent_pokemon.current_hp }}">{{ battle.opponent_pokemon.current_hp }}</span>/{{ battle.opponent_pokemon.max_hp }}
        </small>
      </div>


    </div>

    <!-- Conteneur pour le joueur -->
    <div class="pokemon-container player-container">

      <!-- Player Info Box -->
      <div class="pokemon-info-player">
        <h5 class="mb-2">
          <span id="player-name">
            {% if battle.player_pokemon.nickname %}
              {{ battle.player_pokemon.nickname }}
            {% else %}
              {{ battle.player_pokemon.species.name }}
            {% endif %}
          </span>
          <span id="player-status">
            {% if battle.player_pokemon.status_condition %}
            <span class="status-icon status-{{ battle.player_pokemon.status_condition }}">
              {{ battle.player_pokemon.get_status_condition_display|upper }}
            </span>
            {% endif %}
          </span>
        </h5>
        <small class="text-muted" id="player-level">Niv. {{ battle.player_pokemon.level }}</small>
        <div class="hp-bar-battle mt-2">
          <div id="player-hp-bar" class="hp-bar-fill-battle hp-high" 
              style="width: {% widthratio battle.player_pokemon.current_hp battle.player_pokemon.max_hp 100 %}%"></div>
        </div>
        <small class="d-block mt-1">
          HP: <span id="player-hp-text" data-current-hp="{{ battle.player_pokemon.current_hp }}">{{ battle.player_pokemon.current_hp }}</span>/{{ battle.player_pokemon.max_hp }}
        </small>
      </div>

      <!-- Pokemon Sprite -->
      <img id="player-sprite"
        src="{% static 'img/sprites_gen1/' %}{{ battle.player_pokemon.species.name }}.png"
        alt="{{ battle.player_pokemon.species.name }}"
        class="pokemon-sprite-player"
        onerror="this.src='{% static 'img/pokeball.png' %}'">

    </div>
  </div>
</div>

<!-- Battle Controls -->
<div class="battle-menu">
  <div class="row">
    <div class="col-12">
      <h5 class="mb-3">Que doit faire {{ battle.player_pokemon.species.name }} ?</h5>
    </div>
  </div>

  <div id="main-menu" class="row">
    <div class="col-md-6 mb-3">
      <button class="btn battle-action-btn btn-primary btn-block" onclick="showMoves()">
        <i class="fas fa-bolt"></i> ATTAQUE
      </button>
    </div>
    <div class="col-md-6 mb-3">
      <button class="btn battle-action-btn btn-info btn-block" onclick="showItems()">
        <i class="fas fa-shopping-bag"></i> SAC
      </button>
    </div>
    <div class="col-md-6 mb-3">
      <button class="btn battle-action-btn btn-success btn-block" onclick="showTeam()">
        <i class="fas fa-users"></i> POKÉMON
      </button>
    </div>
    <div class="col-md-6 mb-3">
      <button class="btn battle-action-btn btn-warning btn-block" onclick="tryRun()">
        <i class="fas fa-running"></i> FUITE
      </button>
    </div>
  </div>

  <!-- Moves Menu -->
  <div id="moves-menu" style="display: none;">
    <div class="row">
      {% for move_instance in battle.player_pokemon.pokemonmoveinstance_set.all %}
      <div class="col-md-6">
        <button class="btn move-btn btn-block" 
                onclick="useMove({{ move_instance.move.id }})"
                {% if move_instance.current_pp == 0 %}disabled{% endif %}>
          <div class="d-flex justify-content-between align-items-center">
            <span>{{ move_instance.move.name }}</span>
            <span class="badge badge-light">
              <span class="badge badge-type-{{ move_instance.move.type.name }}">{{ move_instance.move.type.name }}</span>
            </span>
          </div>
          <small class="d-block mt-1">
            PP: {{ move_instance.current_pp }}/{{ move_instance.move.pp }} | 
            {% if move_instance.move.power %}Puis: {{ move_instance.move.power }}{% else %}—{% endif %} | 
            Préc: {{ move_instance.move.accuracy }}%
          </small>
        </button>
      </div>
      {% endfor %}
    </div>
    <button class="btn btn-secondary mt-3" onclick="showMainMenu()">
      <i class="fas fa-arrow-left"></i> Retour
    </button>
  </div>

  <!-- Items Menu -->
  <div id="items-menu" style="display: none;">
    <div class="alert alert-info">
      <i class="fas fa-info-circle"></i> Sélectionnez un objet à utiliser
    </div>
    <div id="items-list">
      <!-- Items will be loaded here via AJAX -->
      <p class="text-center text-muted">Chargement...</p>
    </div>
    <button class="btn btn-secondary mt-3" onclick="showMainMenu()">
      <i class="fas fa-arrow-left"></i> Retour
    </button>
  </div>

  <!-- Team Menu -->
  <div id="team-menu" style="display: none;">
    <div class="alert alert-info">
      <i class="fas fa-info-circle"></i> Choisissez un Pokémon
    </div>
    <div id="team-list">
      <!-- Team will be loaded here -->
      <p class="text-center text-muted">Chargement...</p>
    </div>
    <button class="btn btn-secondary mt-3" onclick="showMainMenu()">
      <i class="fas fa-arrow-left"></i> Retour
    </button>
  </div>

  <!-- Battle Log -->
  <div class="battle-log-box" id="battle-log">
    {% for log_entry in battle.battle_log|slice:"-5:" reversed %}
    <p><strong>Tour {{ log_entry.turn }}:</strong> {{ log_entry.message }}</p>
    {% empty %}
    <p>Le combat commence !</p>
    {% endfor %}
  </div>
</div>

<!-- Victory/Defeat Modal (hidden by default) -->
{% if not battle.is_active %}
<div class="battle-result-overlay">
  <div class="battle-result-content">
    {% if battle.winner == battle.player_trainer %}
    <i class="fas fa-trophy fa-5x text-warning mb-4"></i>
    <h1 class="display-3 text-success">VICTOIRE !</h1>
    <p class="lead">{{ battle.player_pokemon.species.name }} a gagné le combat !</p>
    {% else %}
    <i class="fas fa-times-circle fa-5x text-danger mb-4"></i>
    <h1 class="display-3 text-danger">DÉFAITE</h1>
    <p class="lead">{{ battle.player_pokemon.species.name }} a été vaincu...</p>
    {% endif %}
    <a href="{% url 'BattleDetailView' battle.id %}" class="btn btn-primary btn-lg mt-4">
      Voir les Détails
    </a>
    <a href="{% url 'home' %}" class="btn btn-secondary btn-lg mt-4">
      Retour au Dashboard
    </a>
  </div>
</div>
{% endif %}
{% endblock content %}

{% block js %}
{{ block.super }}

<script>
  // Menu Navigation
  function showMainMenu() {
    $('#main-menu').show();
    $('#moves-menu, #items-menu, #team-menu').hide();
  }

  function showMoves() {
    $('#main-menu').hide();
    $('#moves-menu').show();
  }

  function showItems() {
    $('#main-menu').hide();
    $('#items-menu').show();
    loadItems();
  }

  function showTeam() {
    $('#main-menu').hide();
    $('#team-menu').show();
    loadTeam();
  }

  // ============================================================================
  // ACTIONS DE COMBAT
  // ============================================================================
  
  function useMove(moveId) {
    // Disable all buttons
    $('button').prop('disabled', true);
    
    // AJAX call to execute move
    $.post('{% url "BattleActionView" battle.id %}', {
      action: 'attack',
      move_id: moveId,
      csrfmiddlewaretoken: '{{ csrf_token }}'
    })
    .done(function(data) {
      updateBattle(data);
    })
    .fail(function(xhr) {
      console.error('Attack failed:', xhr);
      addLog('Erreur lors de l\'attaque');
      $('button').prop('disabled', false);
    });
  }

  function switchPokemon(pokemonId) {
    if (!confirm('Changer de Pokémon ?')) {
      return;
    }
    
    // Disable buttons
    $('button').prop('disabled', true);
    
    $.post('{% url "BattleActionView" battle.id %}', {
      action: 'switch',
      pokemon_id: pokemonId,
      csrfmiddlewaretoken: '{{ csrf_token }}'
    })
    .done(function(data) {
      updateBattle(data);
    })
    .fail(function(xhr) {
      console.error('Switch failed:', xhr);
      addLog('Erreur lors du changement');
      $('button').prop('disabled', false);
    });
  }

  function useItem(itemId) {
    // Disable buttons
    $('button').prop('disabled', true);
    
    $.post('{% url "BattleActionView" battle.id %}', {
      action: 'item',
      item_id: itemId,
      csrfmiddlewaretoken: '{{ csrf_token }}'
    })
    .done(function(data) {
      updateBattle(data);
      
      // Recharger la liste des objets après utilisation
      if (!data.battle_ended) {
        loadItems();
      }
    })
    .fail(function(xhr) {
      console.error('Item use failed:', xhr);
      addLog('Erreur lors de l\'utilisation de l\'objet');
      $('button').prop('disabled', false);
    });
  }

  function tryRun() {
    if (!confirm('Voulez-vous vraiment fuir le combat ?')) {
      return;
    }
    
    $.post('{% url "BattleActionView" battle.id %}', {
      action: 'flee',
      csrfmiddlewaretoken: '{{ csrf_token }}'
    })
    .done(function(data) {
      if (data.fled) {
        addLog('Vous avez fui le combat !');
        setTimeout(() => {
          window.location.href = '{% url "home" %}';
        }, 2000);
      } else {
        addLog('Impossible de fuir !');
        updateBattle(data);
      }
    })
    .fail(function(xhr) {
      console.error('Flee failed:', xhr);
      addLog('Erreur');
    });
  }

  // ============================================================================
  // CHARGEMENT DES DONNÉES
  // ============================================================================
  
  function loadItems() {
    $('#items-list').html('<p class="text-center"><i class="fas fa-spinner fa-spin"></i> Chargement...</p>');
    
    $.get('{% url "GetTrainerItems" %}', {
      trainer_id: '{{ battle.player_trainer.id }}'
    })
    .done(function(data) {
      if (!data.items || data.items.length === 0) {
        $('#items-list').html('<p class="text-center text-muted">Aucun objet disponible</p>');
        return;
      }
      
      let html = '<div class="row">';
      data.items.forEach(item => {
        html += `
          <div class="col-md-6 mb-2">
            <button class="btn btn-outline-primary btn-block" onclick="useItem(${item.id})">
              <div class="d-flex justify-content-between">
                <span>${item.name}</span>
                <span class="badge badge-secondary">x${item.quantity}</span>
              </div>
            </button>
          </div>
        `;
      });
      html += '</div>';
      
      $('#items-list').html(html);
    })
    .fail(function() {
      $('#items-list').html('<p class="text-center text-danger">Erreur de chargement</p>');
    });
  }

  function loadTeam() {
    $('#team-list').html('<p class="text-center"><i class="fas fa-spinner fa-spin"></i> Chargement...</p>');
    
    $.get('{% url "GetTrainerTeam" %}', {
      trainer_id: '{{ battle.player_trainer.id }}',
      exclude_pokemon_id: '{{ battle.player_pokemon.id }}'
    })
    .done(function(data) {
      if (!data.team || data.team.length === 0) {
        $('#team-list').html('<p class="text-center text-muted">Aucun autre Pokémon disponible</p>');
        return;
      }
      
      let html = '<div class="list-group">';
      data.team.forEach(pokemon => {
        const hpPercent = (pokemon.current_hp / pokemon.max_hp) * 100;
        const hpClass = hpPercent > 50 ? 'success' : (hpPercent > 20 ? 'warning' : 'danger');
        const isKO = pokemon.current_hp === 0;
        
        html += `
          <button class="list-group-item list-group-item-action ${isKO ? 'disabled' : ''}" 
                  onclick="switchPokemon(${pokemon.id})"
                  ${isKO ? 'disabled' : ''}>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">${pokemon.nickname || pokemon.species.name}</h6>
                <small>Niv. ${pokemon.level}</small>
              </div>
              <div class="text-right">
                <div class="progress" style="width: 100px; height: 10px;">
                  <div class="progress-bar bg-${hpClass}" style="width: ${hpPercent}%"></div>
                </div>
                <small>${pokemon.current_hp}/${pokemon.max_hp} HP</small>
              </div>
            </div>
          </button>
        `;
      });
      html += '</div>';
      
      $('#team-list').html(html);
    })
    .fail(function() {
      $('#team-list').html('<p class="text-center text-danger">Erreur de chargement</p>');
    });
  }

  // ============================================================================
  // MISE À JOUR DE L'INTERFACE APRÈS ACTION
  // ============================================================================
  
  function updateBattle(data) {
    console.log('Update battle with:', data);
    
    // Vérifier si le switch a changé le Pokémon
    if (data.player_pokemon) {
      updatePokemon('player', data.player_pokemon);
    } else {
      // Backward compatibility
      updateHP('player', data.player_hp, data.player_max_hp);
    }
    
    if (data.opponent_pokemon) {
      updatePokemon('opponent', data.opponent_pokemon);
    } else {
      // Backward compatibility
      updateHP('opponent', data.opponent_hp, data.opponent_max_hp);
    }
    
    // Add battle log
    if (data.log && data.log.length > 0) {
      data.log.forEach(msg => addLog(msg));
    }
    
    // Check if battle ended
    if (data.battle_ended) {
      setTimeout(() => {
        location.reload();
      }, 2000);
    } else {
      // Re-enable buttons
      $('button').prop('disabled', false);
      showMainMenu();
    }
  }

  function updatePokemon(side, pokemonData) {
    /**
     * Met à jour complètement un Pokémon (sprite, nom, HP, niveau)
     * Appelé après un switch ou une action
     */
    const prefix = side; // 'player' ou 'opponent'
    
    // Mettre à jour le sprite
    const newSpriteSrc = "{% static 'img/sprites_gen1/' %}" + pokemonData.species_name + ".png";
    $(`#${prefix}-sprite`).attr('src', newSpriteSrc)
      .on('error', function() {
        $(this).attr('src', "{% static 'img/pokeball.png' %}");
      });
    
    // Mettre à jour le nom et le niveau
    $(`#${prefix}-name`).text(pokemonData.name);
    $(`#${prefix}-level`).text('Niv. ' + pokemonData.level);
    
    // Mettre à jour le statut (si présent)
    if (pokemonData.status) {
      $(`#${prefix}-status`).html(`
        <span class="status-icon status-${pokemonData.status}">
          ${pokemonData.status.toUpperCase()}
        </span>
      `);
    } else {
      $(`#${prefix}-status`).html('');
    }
    
    // Mettre à jour la HP
    updateHP(prefix, pokemonData.current_hp, pokemonData.max_hp);
  }

  function updateHP(side, current, max) {
    const percent = (current / max) * 100;
    const bar = $(`#${side}-hp-bar`);
    const text = $(`#${side}-hp-text`);
    
    // Animate HP change
    bar.css('width', percent + '%');
    text.text(current);
    
    // Update color
    bar.removeClass('hp-high hp-medium hp-low');
    if (percent > 50) {
      bar.addClass('hp-high');
    } else if (percent > 20) {
      bar.addClass('hp-medium');
    } else {
      bar.addClass('hp-low');
    }
    
    // Shake sprite if taking damage (compare avec valeur actuelle)
    const currentHP = parseInt(text.data('current-hp') || max);
    if (current < currentHP) {
      $(`#${side}-sprite`).addClass('taking-damage');
      setTimeout(() => $(`#${side}-sprite`).removeClass('taking-damage'), 500);
    }
    
    // Sauvegarder la valeur actuelle pour la prochaine comparaison
    text.data('current-hp', current);
  }

  function addLog(message) {
    const logBox = $('#battle-log');
    const timestamp = new Date().toLocaleTimeString();
    logBox.prepend(`<p><small class="text-muted">[${timestamp}]</small> ${message}</p>`);
    
    // Limit to last 15 messages
    if (logBox.children().length > 15) {
      logBox.children().last().remove();
    }
  }

  // ============================================================================
  // RACCOURCIS CLAVIER
  // ============================================================================
  
  $(document).keydown(function(e) {
    if ($('#main-menu').is(':visible')) {
      switch(e.key) {
        case '1': showMoves(); break;
        case '2': showItems(); break;
        case '3': showTeam(); break;
        case '4': tryRun(); break;
        case 'Escape': showMainMenu(); break;
      }
    } else if ($('#moves-menu').is(':visible') || $('#items-menu').is(':visible') || $('#team-menu').is(':visible')) {
      if (e.key === 'Escape') {
        showMainMenu();
      }
    }
  });

  // ============================================================================
  // INITIALISATION
  // ============================================================================
  
  $(document).ready(function() {
    console.log('Battle interface ready');
    
    // Sauvegarder les HP initiaux pour la détection de dégâts
    $('#player-hp-text').data('current-hp', '{{ battle.player_pokemon.current_hp }}');
    $('#opponent-hp-text').data('current-hp', '{{ battle.opponent_pokemon.current_hp }}');
    
    // Log d'initialisation
    addLog('Le combat commence !');
  });
</script>

{% endblock js %}