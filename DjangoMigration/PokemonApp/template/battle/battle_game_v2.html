{% extends "base.html" %}
{% load static %} {% load custom_filters %}

{% block title %}
<title>Combat - {{ battle.player_pokemon.species.name }} VS {{ battle.opponent_pokemon.species.name }}</title>
{% endblock title %}

{% block content %}

{% if battle.battle_type == 'trainer' or battle.battle_type == 'gym' %}
<!-- ╔══════════════════════════════════════════════════════╗
     ║        TRAINER INTRO OVERLAY                        ║
     ╚══════════════════════════════════════════════════════╝ -->
<div id="trainer-intro-overlay" class="trainer-intro-overlay">

  <!-- Animated background stripes (game-style) -->
  <div class="trainer-intro-bg">
    <div class="trainer-intro-stripes"></div>
  </div>

  <!-- VS Flash -->
  <div class="trainer-intro-vs-flash" id="trainer-vs-flash">VS</div>

  <!-- Trainer sprite (slides in from right) -->
  <div class="trainer-intro-sprite-wrap" id="trainer-intro-sprite-wrap">
    <img id="trainer-intro-sprite"
         class="trainer-intro-sprite"
         src="{% static 'img/trainer_sprites/' %}{{ battle.opponent_trainer|trainer_sprite_path }}"
         alt="{{ battle.opponent_trainer.get_full_title }}"
         onerror="this.style.display='none'; document.getElementById('trainer-intro-fallback').style.display='flex'">
    <!-- Fallback if no sprite found -->
    <div id="trainer-intro-fallback" style="display:none;" class="trainer-intro-fallback">
      <i class="fas fa-user-circle"></i>
    </div>
  </div>

  <!-- Nameplate (slides up from bottom) -->
  <div class="trainer-intro-nameplate" id="trainer-intro-nameplate">
    {% if battle.opponent_trainer.npc_class %}
    <span class="trainer-intro-class">{{ battle.opponent_trainer.npc_class }}</span>
    {% endif %}
    <span class="trainer-intro-name">{{ battle.opponent_trainer.username }}</span>
  </div>

  <!-- Dialogue box -->
  <div class="trainer-intro-dialogue" id="trainer-intro-dialogue">
    <div class="trainer-dialogue-box">
      <p id="trainer-intro-text" class="trainer-dialogue-text">
        {% if battle.opponent_trainer.intro_text %}
          {{ battle.opponent_trainer.intro_text }}
        {% else %}
          {% if battle.battle_type == 'gym' %}
            Je suis le Champion de cette Arène ! Préparez-vous au combat !
          {% else %}
            Dresseur veut se battre !
          {% endif %}
        {% endif %}
      </p>
      <span class="trainer-dialogue-continue">▼</span>
    </div>
  </div>

</div>
{% endif %}

<!-- Battle Scene Container -->
<!-- Options: grass, water, cave -->
<!-- ══ BATTLE WRAPPER (letterbox) ══════════════════════════════ -->
<div class="battle-wrapper" id="battle-wrapper">
<div class="battle-scene" data-terrain="{{ battle_terrain|default:'grass' }}">
  
  <!-- Background Layer -->
  <div class="battle-background" style="background-image: url('{{ battle_bg_png }}'); background-color: {{ battle_bg_fallback }};">
    <div class="weather-effect" id="weather-container"></div>
    <div class="particles-background" id="particles-bg"></div>
  </div>


  <!-- Zone de combat — layout 100% absolu, zoom-stable -->
  <div class="battlefield">

    <!-- ADVERSAIRE : info haut-gauche, sprite haut-droite -->
    <div class="opponent-row">
      <div class="info-bar opponent-bar">
          <div class="info-content">
            <div class="name-level-row">
              <span class="pokemon-name" id="opponent-name">
                {% if battle.opponent_pokemon.nickname %}
                  {{ battle.opponent_pokemon.nickname }}
                {% else %}
                  {{ battle.opponent_pokemon.species.name }}
                {% endif %}
                {% if battle.opponent_pokemon.is_shiny %}<span class="shiny-indicator" title="Chromatique !">✨</span>{% endif %}
              </span>
              <span class="pokemon-gender">♂</span>
              <span class="pokemon-level" id="opponent-level">Niv.{{ battle.opponent_pokemon.level }}</span>
            </div>
            
            <!-- HP Bar -->
            <div class="hp-section">
              <div class="hp-label">HP</div>
              <div class="hp-bar-wrapper">
                <div class="hp-bar">
                  {% widthratio battle.opponent_pokemon.current_hp battle.opponent_pokemon.max_hp 100 as opp_hp_percent %}
                  {% with opp_hp_percent_int=opp_hp_percent|default:0|add:0 %}
                  <div class="hp-bar-fill {% if opp_hp_percent_int > 50 %}hp-high{% elif opp_hp_percent_int > 20 %}hp-medium{% else %}hp-low{% endif %}" 
                      id="opponent-hp-bar"
                      style="width: {{ opp_hp_percent }}%">
                    <div class="hp-bar-shine"></div>
                  </div>
                  {% endwith %}
                </div>
              </div>
            </div>

            <!-- Météo -->
            <div id="weather-banner"></div>

            <!-- Badges volatiles adversaire -->
            <div id="opponent-volatile-badges" style="display:flex;flex-wrap:wrap;gap:2px;"></div>
            <span id="opponent-light-screen"></span>
            <span id="opponent-reflect"></span>

            <!-- Stat stages adversaire -->
            <div class="stat-stages-container" id="opponent-stat-stages"></div>

            <!-- Status Icon -->
            <div class="status-container" id="opponent-status">
              {% if battle.opponent_pokemon.status_condition %}
              <span class="status-badge status-{{ battle.opponent_pokemon.status_condition }}">
                {{ battle.opponent_pokemon.get_status_condition_display|upper }}
              </span>
              {% endif %}
            </div>
          </div>
      </div>

      <!-- Sprite Adversaire (droite) -->
      <div class="battle-side opponent-side">
          <div class="pokemon-platform opponent-platform"></div>
          <div class="pokemon-container opponent-container" id="opponent-container">
            <div class="pokemon-shadow"></div>
            <img class="pokemon-sprite opponent-sprite"
                id="opponent-sprite"
                src="{% static 'img/sprites_gen5/' %}{% if battle.opponent_pokemon.is_shiny %}shiny{% else %}normal{% endif %}/{{ battle.opponent_pokemon.species.name|lowerPokemonFileNames }}.png"
                alt="{{ battle.opponent_pokemon.species.name }}"
                onerror="this.src='{% static 'img/pokeball.png' %}'">
          </div>
      </div>
    </div>

    <!-- JOUEUR : sprite bas-gauche, info bas-droite -->
    <div class="player-row">
      <!-- Sprite Joueur (gauche) -->
      <div class="battle-side player-side">
          <div class="pokemon-platform player-platform"></div>
          <div class="pokemon-container player-container" id="player-container">
            <div class="pokemon-shadow player-pokemon-shadow"></div>
            <img class="pokemon-sprite player-sprite"
                id="player-sprite"
                src="{% static 'img/sprites_gen5/' %}{% if battle.player_pokemon.is_shiny %}back-shiny{% else %}back{% endif %}/{{ battle.player_pokemon.species.name|lowerPokemonFileNames }}.png"
                alt="{{ battle.player_pokemon.species.name }}"
                onerror="this.src='{% static 'img/pokeball.png' %}'">
          </div>
      </div>

      <!-- Info Joueur (droite) -->
      <div class="info-bar player-bar">
          <div class="info-content">
            <div class="name-level-row">
              <span class="pokemon-name" id="player-name">
                {% if battle.player_pokemon.nickname %}
                  {{ battle.player_pokemon.nickname }}
                {% else %}
                  {{ battle.player_pokemon.species.name }}
                {% endif %}
                {% if battle.player_pokemon.is_shiny %}<span class="shiny-indicator" title="Chromatique !">✨</span>{% endif %}
              </span>
              <span class="pokemon-gender">♂</span>
              <span class="pokemon-level" id="player-level" data-level="{{ battle.player_pokemon.level }}">Niv.{{ battle.player_pokemon.level }}</span>
            </div>
            
            <!-- HP Bar -->
            <div class="hp-section">
              <div class="hp-label">HP</div>
              <div class="hp-bar-wrapper">
                <div class="hp-bar">
                  {% widthratio battle.player_pokemon.current_hp battle.player_pokemon.max_hp 100 as player_hp_percent %}
                  {% with player_hp_percent_int=player_hp_percent|default:0|add:0 %}
                  <div class="hp-bar-fill {% if player_hp_percent_int > 50 %}hp-high{% elif player_hp_percent_int > 20 %}hp-medium{% else %}hp-low{% endif %}" 
                      id="player-hp-bar"
                      style="width: {{ player_hp_percent }}%">
                    <div class="hp-bar-shine"></div>
                  </div>
                  {% endwith %}
                </div>
                <div class="hp-text">
                  <span id="player-hp-current">{{ battle.player_pokemon.current_hp }}</span>/<span id="player-hp-max">{{ battle.player_pokemon.max_hp }}</span>
                </div>
              </div>
            </div>

            <!-- EXP Bar (Player only) -->
            <div class="exp-section">
              <div class="exp-bar">
                <div class="exp-bar-fill" style="width: {{ initial_exp_percent|default:0 }}%" data-exp-percent="{{ initial_exp_percent|default:0 }}"></div>
              </div>
            </div>

            <!-- Badges volatiles joueur -->
            <div id="player-volatile-badges" style="display:flex;flex-wrap:wrap;gap:2px;margin-top:2px;"></div>
            <span id="player-light-screen"></span>
            <span id="player-reflect"></span>

            <!-- Stat stages joueur -->
            <div class="stat-stages-container" id="player-stat-stages"></div>

            <!-- Status Icon -->
            <div class="status-container" id="player-status">
              {% if battle.player_pokemon.status_condition %}
              <span class="status-badge status-{{ battle.player_pokemon.status_condition }}">
                {{ battle.player_pokemon.get_status_condition_display|upper }}
              </span>
              {% endif %}
            </div>


          </div>
      </div>
    </div>

    <!-- Calque des effets (par-dessus tout) -->
    <div class="effects-layer" id="effects-layer">
      <canvas id="attack-canvas" width="800" height="600"></canvas>
    </div>
  </div>

</div><!-- /battle-scene -->
</div><!-- /battle-wrapper -->

<!-- ══ ACTION PANEL (hors scène, non scalé) ═══════════════════════ -->
<!-- UI Layer (log déplacé hors scène) -->
  <div class="battle-ui">
    <div class="action-panel" id="action-panel">
      
      <!-- Main Menu -->
      <div class="menu-container" id="main-menu">
        <div class="menu-grid">
          <button class="action-btn action-fight" onclick="showMoves()">
            <i class="fas fa-fist-raised"></i>
            <span>Combat</span>
          </button>
          <button class="action-btn action-pokemon" onclick="showTeam()">
            <i class="fas fa-users"></i>
            <span>Pokémon</span>
          </button>
          <button class="action-btn action-bag" onclick="showItems()">
            <i class="fas fa-shopping-bag"></i>
            <span>Sac</span>
          </button>
          <button class="action-btn action-run" onclick="tryRun()">
            <i class="fas fa-running"></i>
            <span>Fuite</span>
          </button>
        </div>
      </div>

      <!-- Moves Menu -->
      <div class="menu-container" id="moves-menu" style="display: none;">
        <div class="menu-header">
          <h4>Choisissez une attaque</h4>
          <button class="btn-back" onclick="showMainMenu()">
            <i class="fas fa-arrow-left"></i> Retour
          </button>
        </div>
        <div class="moves-grid">
          {% for move_instance in battle.player_pokemon.pokemonmoveinstance_set.all %}
          <button class="move-btn move-type-{{ move_instance.move.type.name }}" 
                  onclick="useMove('{{ move_instance.move.id }}')"
                  {% if move_instance.current_pp == 0 %}disabled{% endif %}>
            <div class="move-header">
              <span class="move-name">{{ move_instance.move.name }}</span>
              <span class="move-pp">PP: {{ move_instance.current_pp }}/{{ move_instance.move.pp }}</span>
            </div>
            <div class="move-footer">
              <span class="move-type-badge type-{{ move_instance.move.type.name }}">
                {{ move_instance.move.type.name|upper }}
              </span>
              <img src="{% static 'img/movesTypesSprites/move-'|add:move_instance.move.category|add:'.png' %}"
                   alt="{{ move_instance.move.category }}"
                   title="{{ move_instance.move.get_category_display }}"
                   style="width:18px;height:18px;object-fit:contain;vertical-align:middle;">
              <span class="move-power">
                {% if move_instance.move.power %}PWR: {{ move_instance.move.power }}{% else %}—{% endif %}
              </span>
              <span class="move-accuracy" style="font-size:0.75em;color:#aaa;">
                {% if move_instance.move.accuracy %}PREC: {{ move_instance.move.accuracy }}%{% else %}∞{% endif %}
              </span>
            </div>
          </button>
          {% empty %}
          <p class="text-muted">Aucune attaque disponible</p>
          {% endfor %}
        </div>
      </div>

      <!-- Items Menu -->
      <div class="menu-container" id="items-menu" style="display: none;">
        <div class="menu-header">
          <h4>Choisissez un objet</h4>
          <button class="btn-back" onclick="showMainMenu()">
            <i class="fas fa-arrow-left"></i> Retour
          </button>
        </div>
        <div class="items-list" id="items-list">
          <p class="text-center"><i class="fas fa-spinner fa-spin"></i> Chargement...</p>
        </div>
      </div>

      <!-- Team Menu -->
      <div class="menu-container" id="team-menu" style="display: none;">
        <div class="menu-header">
          <h4>Choisissez un Pokémon</h4>
          <button class="btn-back" onclick="showMainMenu()">
            <i class="fas fa-arrow-left"></i> Retour
          </button>
        </div>
        <div class="team-list" id="team-list">
          <p class="text-center"><i class="fas fa-spinner fa-spin"></i> Chargement...</p>
        </div>
      </div>

    </div>
  </div>


<!-- ══ BATTLE LOG — en dehors de la scène, toujours visible ══════════════ -->
<div class="battle-log-compact" id="battle-log-compact">
  <div class="log-messages" id="log-messages"></div>
</div>

<!-- Modal de Switch Forcé (quand Pokemon KO) -->
<div class="modal fade" id="forced-switch-modal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle"></i> Pokémon K.O. !
        </h5>
      </div>
      <div class="modal-body">
        <p class="text-center mb-3">
          <strong id="fainted-pokemon-name"></strong> est K.O. !<br>
          Choisissez un Pokémon pour le remplacer.
        </p>
        <div id="forced-switch-list">
          <!-- Team list will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Victoire -->
<div class="modal fade" id="victory-modal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-success">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="fas fa-trophy"></i> VICTOIRE !
        </h5>
      </div>
      <div class="modal-body text-center">
        <i class="fas fa-trophy fa-5x text-warning mb-3"></i>
        <h4>Vous avez gagné le combat !</h4>
        <p id="victory-exp-message"></p>
      </div>
      <div class="modal-footer">
        {% if battle.battle_type == 'trainer' or battle.battle_type == 'gym' %}
        <button type="button" class="btn btn-success" 
                onclick="window.location.href='{% url 'battle_trainer_complete' battle.id %}'">
          <i class="fas fa-check"></i> Voir les récompenses
        </button>
        {% else %}
        <button type="button" class="btn btn-success" 
                onclick="window.location.href='{% if current_zone %}{% url 'zone_detail' current_zone.id %}{% else %}{% url 'home' %}{% endif %}'">
          <i class="fas fa-map-marker-alt"></i> Retour à la zone
        </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Modal de Défaite -->
<div class="modal fade" id="defeat-modal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="fas fa-times-circle"></i> DÉFAITE
        </h5>
      </div>
      <div class="modal-body text-center">
        <i class="fas fa-times-circle fa-5x text-danger mb-3"></i>
        <h4>Vous avez perdu le combat...</h4>
        <p>Tous vos Pokémon sont K.O. Vous êtes transporté au Centre Pokémon.</p>
      </div>
      <div class="modal-footer">
        {% if battle.battle_type == 'trainer' or battle.battle_type == 'gym' %}
        <button type="button" class="btn btn-warning"
                onclick="window.location.href='{% url 'battle_trainer_complete' battle.id %}'">
          <i class="fas fa-hospital"></i> Voir le résultat
        </button>
        {% else %}
        <button type="button" class="btn btn-secondary" onclick="window.location.href='{% if current_zone %}{% url 'zone_detail' current_zone.id %}{% else %}{% url 'home' %}{% endif %}'">
          <i class="fas fa-map-marker-alt"></i> Retour à la zone
        </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Modal de Fuite -->
<div class="modal fade" id="fled-modal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-warning">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">
          <i class="fas fa-running"></i> FUITE
        </h5>
      </div>
      <div class="modal-body text-center">
        <i class="fas fa-running fa-5x text-warning mb-3"></i>
        <h4>Vous avez fui le combat !</h4>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-warning" onclick="window.location.href='{% if current_zone %}{% url 'zone_detail' current_zone.id %}{% else %}{% url 'home' %}{% endif %}'">
          <i class="fas fa-map-marker-alt"></i> Retour à la zone
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ╔══════════════════════════════════════════════════════╗
     ║          MODAL D'ÉVOLUTION                          ║
     ╚══════════════════════════════════════════════════════╝ -->
<div class="modal fade" id="evolution-modal" tabindex="-1" role="dialog"
     data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content evolution-modal-content">

      <!-- Phase 1 : annonce -->
      <div id="evo-phase-announce" class="evo-phase text-center py-4 px-3">
        <p class="evo-subtitle mb-2">Quoi ?!</p>
        <h3 class="evo-title" id="evo-from-name"></h3>
        <p class="evo-subtitle">commence à évoluer !</p>
      </div>

      <!-- Phase 2 : animation des sprites -->
      <div id="evo-phase-anim" class="evo-phase d-none py-3">
        <div class="evo-arena">
          <!-- Sprite AVANT -->
          <div class="evo-sprite-wrap" id="evo-before-wrap">
            <img id="evo-sprite-before" class="evo-sprite" src="" alt="">
            <div class="evo-glow" id="evo-glow"></div>
          </div>
          <!-- Sprite APRÈS (caché au début) -->
          <div class="evo-sprite-wrap d-none" id="evo-after-wrap">
            <img id="evo-sprite-after" class="evo-sprite evo-sprite-reveal" src="" alt="">
          </div>
        </div>
        <div class="evo-flash-overlay" id="evo-flash"></div>
      </div>

      <!-- Phase 3 : résultat + stats -->
      <div id="evo-phase-result" class="evo-phase d-none text-center py-4 px-4">
        <div class="d-flex justify-content-center align-items-center mb-3 gap-3">
          <img id="evo-result-before-sprite" class="evo-result-sprite" src="" alt="">
          <i class="fas fa-arrow-right fa-2x text-warning"></i>
          <img id="evo-result-after-sprite" class="evo-result-sprite evo-result-after-bounce" src="" alt="">
        </div>
        <h4 class="text-warning mb-1">
          <i class="fas fa-star"></i>
          <span id="evo-from-name-2"></span> évolue en
          <strong id="evo-to-name"></strong> !
        </h4>
        <!-- Tableau de comparaison des stats -->
        <div class="evo-stats-table mt-3" id="evo-stats-table"></div>
        <button class="btn btn-warning btn-lg mt-3 px-5" id="evo-confirm-btn" onclick="confirmEvolution()">
          <i class="fas fa-check-circle"></i> Super !
        </button>
      </div>

    </div>
  </div>
</div>
<div class="modal fade" id="learn-move-modal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content border-warning">
      <div class="modal-header" style="background: linear-gradient(135deg, #f5a623, #e67e22); color: white;">
        <h5 class="modal-title">
          <i class="fas fa-bolt"></i> Nouvelle Capacité !
        </h5>
      </div>
      <div class="modal-body">
        <p class="text-center mb-3" id="learn-move-intro">
          <strong id="learn-move-pokemon-name"></strong> veut apprendre
          <strong id="learn-move-new-name" class="text-warning"></strong> !<br>
          <small class="text-muted">Mais il connaît déjà 4 capacités. Quelle capacité voulez-vous oublier ?</small>
        </p>

        <!-- Info sur la nouvelle capacité -->
        <div class="card mb-3 border-warning" id="new-move-card">
          <div class="card-header bg-warning text-white py-1">
            <strong>Nouvelle capacité : <span id="new-move-display-name"></span></strong>
          </div>
          <div class="card-body py-2 d-flex gap-3">
            <span class="badge badge-secondary" id="new-move-type-badge"></span>
            <span class="text-muted" id="new-move-power-display"></span>
            <span class="text-muted" id="new-move-pp-display"></span>
          </div>
        </div>

        <!-- Moves actuels à choisir -->
        <p class="font-weight-bold mb-2">Choisissez la capacité à oublier :</p>
        <div class="row" id="current-moves-list">
          <!-- rempli dynamiquement -->
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-secondary" onclick="skipLearnMove()">
          <i class="fas fa-times"></i> Ne pas apprendre
        </button>
        <small class="text-muted">Cliquez sur une capacité pour l'oublier et apprendre la nouvelle</small>
      </div>
    </div>
  </div>
</div>

<!-- Audio Elements (preload)
     muted + autoplay = TOUJOURS autorisé par les navigateurs.
     AudioManager récupère cet élément et le désilence au premier clic. -->
{% if battle.battle_type == 'gym' %}
  {% with track="battle_gym" %}
<audio id="bgm-battle" loop preload="auto" muted autoplay>
  <source src="{% static 'sounds/bgm/' %}{{ track }}.mp3" type="audio/mpeg">
</audio>
  {% endwith %}
{% elif is_rival %}
<audio id="bgm-battle" loop preload="auto" muted autoplay>
  <source src="{% static 'sounds/bgm/battle_rival.mp3' %}" type="audio/mpeg">
</audio>
{% elif battle.battle_type == 'trainer' %}
<audio id="bgm-battle" loop preload="auto" muted autoplay>
  <source src="{% static 'sounds/bgm/battle_trainer.mp3' %}" type="audio/mpeg">
</audio>
{% else %}
<audio id="bgm-battle" loop preload="auto" muted autoplay>
  <source src="{% static 'sounds/bgm/battle_wild.mp3' %}" type="audio/mpeg">
</audio>
{% endif %}



<!-- ── ── Battle BGM Player ───────────────────────────────────────────────────── -->
<div id="battle-bgm-player" class="zone-bgm-widget" title="Musique de combat">
  <button id="bgm-toggle" class="bgm-btn" aria-label="Lecture / Pause">
    <i class="fas fa-music" id="bgm-icon"></i>
  </button>
  <div class="bgm-info">
    <span id="bgm-zone-name" class="bgm-zone-name">Combat</span>
    <div class="bgm-progress-wrap">
      <div id="bgm-progress-bar" class="bgm-progress-bar"></div>
    </div>
  </div>
  <input id="bgm-volume" type="range" min="0" max="100" value="30"
         class="bgm-volume" title="Volume" aria-label="Volume">
</div>


{% endblock content %}


{% block css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/battle-animations.css' %}">
<link rel="stylesheet" href="{% static 'css/capture-animation.css' %}">
<link rel="stylesheet" href="{% static 'css/battle-ui.css' %}">
{% endblock css %}

{% block js %}
{{ block.super }}
<script src="{% static 'js/battle-effects.js' %}"></script>
<script src="{% static 'js/audio-manager.js' %}"></script>
<script src="{% static 'js/capture-system.js' %}"></script>
<script src="{% static 'js/battle-volatile-states.js' %}"></script>

{# ── BATTLE_CONFIG — toutes les valeurs dynamiques lues par battle-game.js ── #}
<script>
window.BATTLE_CONFIG = {
  battleId:         {{ battle.id }},
  battleType:       '{{ battle.battle_type }}',
  isRival:          {{ is_rival|yesno:"true,false" }},
  csrfToken:        '{{ csrf_token }}',
  playerPokemonId:   {{ battle.player_pokemon.id }},
  playerTrainerId:   '{{ battle.player_trainer.id }}',
  opponentPokemonId: {{ battle.opponent_pokemon.id }},
  opponentSpeciesId: '{{ battle.opponent_pokemon.species.id }}',
  playerSpeciesId:   '{{ battle.player_pokemon.species.id }}',

  urls: {
    action:     '{% url "BattleActionView" battle.id %}',
    learnMove:  '{% url "BattleLearnMoveView" battle.id %}',
    getItems:   '{% url "GetTrainerItems" %}',
    getTeam:    '{% url "GetTrainerTeam" %}',
    returnZone: '{% if current_zone %}{% url "zone_detail" current_zone.id %}{% else %}{% url "home" %}{% endif %}',
    myTeam:     '{% url "MyTeamView" %}',
  },

  static: {
    spritesGen5:    '{% static "img/sprites_gen5/" %}',
    spritesNormal:  '{% static "img/sprites_gen5/normal/" %}',
    spritesBack:    '{% static "img/sprites_gen5/back/" %}',
    spritesShiny:   '{% static "img/sprites_gen5/shiny/" %}',
    spritesBackShiny: '{% static "img/sprites_gen5/back-shiny/" %}',
    itemsSprites:   '{% static "img/items_sprites/" %}',
    pokeball:       '{% static "img/pokeball.png" %}',
    evoSound:       '{% static "sounds/pokemon-evolution-sound-effect.mp3" %}',
  },
};
// Activer la garde anti-quitter pendant le combat
window.__battleInProgress = true;
</script>
<script src="{% static 'js/battle-game.js' %}"></script>

<style>
/* ── Keyboard shortcuts hint ──────────────────────────────────────────── */
#kbd-hint {
  position: fixed;
  bottom: 70px;
  right: 12px;
  background: rgba(0,0,0,.72);
  color: rgba(255,255,255,.9);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: .72rem;
  line-height: 1.7;
  z-index: 900;
  pointer-events: none;
  backdrop-filter: blur(4px);
  border: 1px solid rgba(255,255,255,.1);
  transition: opacity .6s ease;
  max-width: 220px;
}
#kbd-hint kbd {
  display: inline-block;
  background: rgba(255,255,255,.15);
  border: 1px solid rgba(255,255,255,.3);
  border-radius: 3px;
  padding: 0 5px;
  font-size: .7rem;
  font-family: monospace;
  margin: 0 1px;
}
#kbd-hint .hint-row { display: flex; align-items: center; gap: 6px; }
#kbd-hint .hint-action { color: rgba(255,255,255,.55); font-size: .68rem; }
</style>

<div id="kbd-hint" style="right: 5em; max-width: 50em;">
  <div style="font-weight:600; margin-bottom:1em; opacity:.6; font-size:.65rem; letter-spacing:.05em;">⌨️ RACCOURCIS</div>
  <div class="hint-row"><kbd>Z</kbd> <span class="hint-action">Attaquer</span></div>
  <div class="hint-row"><kbd>&</kbd><kbd>é</kbd><kbd>"</kbd><kbd>'</kbd> <span class="hint-action">ou</span> <kbd>1</kbd><kbd>2</kbd><kbd>3</kbd><kbd>4</kbd></div>
  <div class="hint-row" style="padding-left:1em; font-size:.65rem; color:rgba(255,255,255,.45);">→ Capacité 1–4</div>
  <div class="hint-row"><kbd>X</kbd> <span class="hint-action">Retour menu</span></div>
  <div class="hint-row"><kbd>Q</kbd> <span class="hint-action">Objets</span></div>
  <div class="hint-row"><kbd>E</kbd> <span class="hint-action">Équipe</span></div>
  <div class="hint-row"><kbd>R</kbd> <span class="hint-action">Fuir</span></div>
</div>

<script>
// ── Raccourcis clavier (AZERTY + QWERTY) ──────────────────────────────────
// Menu principal :
//   Z / Entrée     → Attaquer
//   Q              → Objets
//   E              → Équipe
//   R              → Fuir
// Menu capacités (quand ouvert) :
//   & / 1          → Capacité 1
//   é / 2          → Capacité 2
//   " / 3          → Capacité 3
//   ' / 4          → Capacité 4
//   X / Échap      → Retour menu principal
// Tous menus :
//   X / Échap      → Retour menu principal
(function () {
  // AZERTY row-1 → capacités 1-4
  const MOVE_KEYS = {
    '&': 0, '1': 0,
    'é': 1, '2': 1, 'É': 1,
    '"': 2, '3': 2,
    "'": 3, '4': 3,
  };

  function activeMenu() {
    const ids = ['main-menu', 'moves-menu', 'items-menu', 'team-menu'];
    for (const id of ids) {
      const el = document.getElementById(id);
      if (el && el.style.display !== 'none') return id;
    }
    return null;
  }

  document.addEventListener('keydown', function (e) {
    if (document.querySelector('.modal.show')) return;
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
    if (window.__animationLock) return;

    const menu = activeMenu();
    const key  = e.key;

    // ── Menu principal ───────────────────────────────────────────────────
    if (menu === 'main-menu') {
      if (key === 'z' || key === 'Z' || key === 'Enter') {
        e.preventDefault(); document.querySelector('.action-fight')?.click();
      } else if (key === 'r' || key === 'R') {
        e.preventDefault(); document.querySelector('.action-run')?.click();
      } else if (key === 'q' || key === 'Q') {
        e.preventDefault(); document.querySelector('.action-bag')?.click();
      } else if (key === 'e' || key === 'E') {
        e.preventDefault(); document.querySelector('.action-pokemon')?.click();
      }
    }

    // ── Menu capacités ───────────────────────────────────────────────────
    if (menu === 'moves-menu') {
      if (key === 'x' || key === 'X' || key === 'Escape') {
        e.preventDefault();
        if (typeof showMainMenu === 'function') showMainMenu();
      }
      if (key in MOVE_KEYS) {
        e.preventDefault();
        const idx  = MOVE_KEYS[key];
        const btns = document.querySelectorAll('.moves-grid .move-btn');
        if (btns[idx] && !btns[idx].disabled) btns[idx].click();
      }
    }

    // ── Autres menus : Échap pour retour ─────────────────────────────────
    if (menu === 'items-menu' || menu === 'team-menu') {
      if (key === 'x' || key === 'X' || key === 'Escape') {
        e.preventDefault();
        if (typeof showMainMenu === 'function') showMainMenu();
      }
    }

    // ── Si aucun menu ouvert + touche numéro : ouvre menu + sélectionne ──
    if (!menu && key in MOVE_KEYS) {
      const fightBtn = document.querySelector('.action-fight');
      if (fightBtn) {
        e.preventDefault();
        fightBtn.click();
        // Wait one tick for moves-menu to show then click the move
        setTimeout(() => {
          const idx  = MOVE_KEYS[key];
          const btns = document.querySelectorAll('.moves-grid .move-btn');
          if (btns[idx] && !btns[idx].disabled) btns[idx].click();
        }, 50);
      }
    }
  });

  // ── Auto-masquage du hint après 12s, réapparition au hover ──────────────
  const hint = document.getElementById('kbd-hint');
  if (hint) {
    let hideTimer = setTimeout(() => hint.style.opacity = '0', 12000);
    hint.addEventListener('mouseenter', () => {
      clearTimeout(hideTimer);
      hint.style.opacity = '1';
    });
    hint.addEventListener('mouseleave', () => {
      hideTimer = setTimeout(() => hint.style.opacity = '0', 3000);
    });
    // Show hint briefly when moves menu opens
    document.addEventListener('click', function(e) {
      if (e.target.closest('.action-fight')) {
        hint.style.opacity = '1';
        clearTimeout(hideTimer);
        hideTimer = setTimeout(() => hint.style.opacity = '0', 5000);
      }
    });
  }
})();
</script>

{% endblock js %}
<script>
/* ════════════════════════════════════════════════════════════════
   WEATHER VIDEO LOADER — Pokemon Showdown assets
   Appelle window.updateBattleWeather('rain'|'sun'|'sandstorm'|'hail')
   depuis le JS de combat pour changer la météo dynamiquement.
   ════════════════════════════════════════════════════════════════ */
(function () {
  const BASE = '/static/img/battle_backgrounds/weather/';
  const WEATHER_MAP = {
    'sun':        { file: 'weather-gen6-sunnyday',  cls: 'weather-sunny' },
    'sun_harsh':  { file: 'weather-gen6-sunnyday',  cls: 'weather-sunny' },
    'rain':       { file: 'weather-gen6-raindance', cls: '' },
    'rain_heavy': { file: 'weather-gen6-raindance', cls: '' },
    'sandstorm':  { file: 'weather-gen6-sandstorm', cls: '' },
    'hail':       { file: 'weather-gen6-hail',      cls: '' },
    'snow':       { file: 'weather-gen6-hail',      cls: '' },
  };

  function loadWeatherVideo(weatherName) {
    const container = document.getElementById('weather-container');
    if (!container) return;
    const entry = WEATHER_MAP[weatherName];
    if (!entry) { container.innerHTML = ''; return; }

    const video = document.createElement('video');
    video.className  = 'weather-video ' + entry.cls;
    video.autoplay   = true;
    video.loop       = true;
    video.muted      = true;
    video.playsInline = true;

    ['.webm', '.mp4'].forEach(ext => {
      const s = document.createElement('source');
      s.src  = BASE + entry.file + ext;
      s.type = ext === '.webm' ? 'video/webm' : 'video/mp4';
      video.appendChild(s);
    });

    container.innerHTML = '';
    container.appendChild(video);
    video.play().catch(() => {});
  }

  // Expose globalement pour le JS de combat
  window.updateBattleWeather = loadWeatherVideo;

  // Auto-init si data-weather présent sur la scène
  document.addEventListener('DOMContentLoaded', function() {
    const scene = document.querySelector('.battle-scene');
    const w = scene && scene.dataset.weather;
    if (w) loadWeatherVideo(w);
  });
})();
</script>

<script>
/* ════════════════════════════════════════════════════════════════════
   BATTLE SCENE SCALER
   - Canvas fixe 1280×540px, scaled uniformément
   - Sous 1280px : scale < 1, letterbox noire
   - Classes CSS ajoutées selon la largeur réelle pour adapter
     le panel d'action hors-scène (log + menus)
   ════════════════════════════════════════════════════════════════════ */
(function () {
  const SCENE_W = 1280;
  const SCENE_H = 540;

  function scaleBattle() {
    const wrapper = document.getElementById('battle-wrapper');
    const scene   = wrapper ? wrapper.querySelector('.battle-scene') : null;
    if (!wrapper || !scene) return;

    const availW  = wrapper.clientWidth;
    const scale   = availW / SCENE_W;
    const scaledH = Math.round(SCENE_H * scale);

    scene.style.transform = `scale(${scale})`;
    wrapper.style.height  = scaledH + 'px';

    // Classes responsive sur le body selon largeur réelle disponible
    const body = document.body;
    body.classList.toggle('battle-sm',  availW < 768);
    body.classList.toggle('battle-md',  availW >= 768 && availW < 1280);
    body.classList.toggle('battle-lg',  availW >= 1280);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', scaleBattle);
  } else {
    scaleBattle();
  }
  window.addEventListener('resize', scaleBattle);
  setTimeout(scaleBattle, 200);
})();
</script>