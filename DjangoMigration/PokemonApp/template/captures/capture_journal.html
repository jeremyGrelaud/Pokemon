{% extends "base.html" %}
{% load static %} {% load custom_filters %}

{% block title %}<title>Journal de Captures</title>{% endblock title %}

{% block content %}

<!-- Header -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h3 mb-1">
      <i class="fas fa-book me-2 text-success"></i>Journal de Captures
    </h1>
    <p class="text-muted mb-0 small">Historique complet de vos captures</p>
  </div>
</div>

<!-- Statistiques -->
<div class="row mb-4">

  <div class="col-6 col-md-3 mb-3">
    <div class="card shadow-sm h-100 stat-card-captures">
      <div class="card-body py-3 px-4">
        <div class="stat-label-sm fw-bold text-warning text-uppercase mb-1">Captures totales</div>
        <div class="d-flex align-items-center justify-content-between">
          <span class="h3 mb-0 fw-bold">{{ stats.total_captures }}</span>
          <i class="fas fa-trophy fa-2x text-warning opacity-25"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3 mb-3">
    <div class="card shadow-sm h-100 stat-card-species">
      <div class="card-body py-3 px-4">
        <div class="stat-label-sm fw-bold text-info text-uppercase mb-1">Esp√®ces uniques</div>
        <div class="d-flex align-items-center justify-content-between">
          <span class="h3 mb-0 fw-bold">{{ stats.unique_species }}</span>
          <i class="fas fa-star fa-2x text-info opacity-25"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3 mb-3">
    <div class="card shadow-sm h-100 stat-card-rate">
      <div class="card-body py-3 px-4">
        <div class="stat-label-sm fw-bold text-success text-uppercase mb-1">Taux de r√©ussite</div>
        <div class="d-flex align-items-center justify-content-between">
          <span class="h3 mb-0 fw-bold">{{ stats.success_rate }}<span class="fs-6 fw-normal">%</span></span>
          <i class="fas fa-chart-line fa-2x text-success opacity-25"></i>
        </div>
        <!-- Mini barre de progression -->
        <div class="progress mt-2" style="height:4px;">
          <div class="progress-bar bg-success" style="width:{{ stats.success_rate }}%;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3 mb-3">
    <div class="card shadow-sm h-100 stat-card-critical">
      <div class="card-body py-3 px-4">
        <div class="stat-label-sm fw-bold text-danger text-uppercase mb-1">Captures critiques</div>
        <div class="d-flex align-items-center justify-content-between">
          <span class="h3 mb-0 fw-bold">{{ stats.critical_catches }}</span>
          <i class="fas fa-fire fa-2x text-danger opacity-25"></i>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Filtres live -->
<div class="card shadow mb-4">
  <div class="card-body py-3">
    <div class="row g-2 align-items-center">

      <!-- Recherche -->
      <div class="col-md-5">
        <div class="input-group input-group-sm">
          <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
          <input type="text" id="live-search" class="form-control"
                 placeholder="Rechercher un Pok√©mon‚Ä¶" autocomplete="off">
        </div>
      </div>

      <!-- Filtre badge -->
      <div class="col-md-3">
        <select id="filter-badge" class="form-select form-select-sm">
          <option value="">Tous les types</option>
          <option value="premier">‚≠ê Premier captur√©</option>
          <option value="critique">‚ö° Capture critique</option>
          <option value="shiny">üíé Shiny</option>
        </select>
      </div>

      <!-- Tri -->
      <div class="col-md-2">
        <select id="filter-sort" class="form-select form-select-sm">
          <option value="date-desc">Plus r√©cent</option>
          <option value="date-asc">Plus ancien</option>
          <option value="level-desc">Niveau ‚Üì</option>
          <option value="level-asc">Niveau ‚Üë</option>
        </select>
      </div>

      <!-- Reset -->
      <div class="col-md-2">
        <button id="clear-filters" class="btn btn-sm btn-light w-100">
          <i class="fas fa-times me-1"></i>R√©initialiser
        </button>
      </div>

    </div>
    <div class="mt-2">
      <small class="text-muted" id="filter-count-label"></small>
    </div>
  </div>
</div>

<!-- Tableau des captures -->
<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex align-items-center justify-content-between">
    <h6 class="m-0 fw-bold text-success">
      <i class="fas fa-list me-2"></i>Captures r√©centes
    </h6>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="captureTable">
        <thead class="table-light">
          <tr>
            <th class="ps-3">Pok√©mon</th>
            <th>Niveau</th>
            <th>Ball utilis√©e</th>
            <th>Date</th>
            <th>Tentatives</th>
            <th class="text-center">Distinctions</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in captures %}
          <tr class="capture-row">
            <td class="ps-3">
              <div class="d-flex align-items-center gap-2">
                <img src="{% static 'img/sprites_gen5/' %}{% if entry.pokemon.is_shiny %}shiny{% else %}normal{% endif %}/{{ entry.pokemon.species.name|lowerPokemonFileNames }}.png"
                     style="width:40px;height:40px;object-fit:contain;"
                     onerror="this.src='{% static 'img/pokeball.png' %}'">
                <div>
                  <span class="fw-semibold">{{ entry.pokemon.species.name }}</span>
                  <div class="d-flex gap-1 mt-1 flex-wrap">
                    {% if entry.is_first_catch %}
                    <span class="badge bg-warning text-dark" style="font-size:.65rem;">
                      <i class="fas fa-star me-1"></i>Premier
                    </span>
                    {% endif %}
                    {% if entry.is_critical_catch %}
                    <span class="badge bg-danger" style="font-size:.65rem;">
                      <i class="fas fa-bolt me-1"></i>Critique
                    </span>
                    {% endif %}
                    {% if entry.pokemon.is_shiny %}
                    <span class="badge bg-info text-dark" style="font-size:.65rem;">
                      <i class="fas fa-gem me-1"></i>Shiny
                    </span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </td>
            <td>
              <span class="badge bg-secondary">Niv. {{ entry.level_at_capture }}</span>
            </td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <img src="{% static 'img/items_sprites/ball/' %}{{ entry.ball_used.name|lower|cut:' ball' }}.png"
                     style="width:28px;height:28px;object-fit:contain;"
                     onerror="this.src='{% static 'img/pokeball.png' %}'">
                <small>{{ entry.ball_used.name }}</small>
              </div>
            </td>
            <td class="text-nowrap text-muted small">{{ entry.captured_at|date:"d/m/Y H:i" }}</td>
            <td>
              <span class="badge {% if entry.attempts_before_success <= 1 %}bg-success{% elif entry.attempts_before_success <= 3 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                {{ entry.attempts_before_success }} essai{{ entry.attempts_before_success|pluralize }}
              </span>
            </td>
            <td class="text-center" style="font-size:1.1rem; letter-spacing:4px;">
              {% if entry.is_first_catch %}<i class="fas fa-star text-warning" title="Premier captur√©"></i>{% endif %}
              {% if entry.is_critical_catch %}<i class="fas fa-bolt text-danger" title="Capture critique"></i>{% endif %}
              {% if entry.pokemon.is_shiny %}<i class="fas fa-gem text-info" title="Shiny"></i>{% endif %}
              {% if not entry.is_first_catch and not entry.is_critical_catch and not entry.pokemon.is_shiny %}
              <span class="text-muted">‚Äî</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center text-muted py-5">
              <i class="fas fa-box-open fa-2x mb-2 d-block"></i>
              Aucune capture pour le moment.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Graphique √©volution -->
<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 fw-bold text-primary">
      <i class="fas fa-chart-line me-2"></i>√âvolution des captures
    </h6>
  </div>
  <div class="card-body">
    <canvas id="capturesChart" height="80"></canvas>
  </div>
</div>

{% endblock %}

{% block css %}
{{ block.super }}
<style>
/* Bordures color√©es gauche sur les cartes stats */
.stat-card-captures,
.stat-card-species,
.stat-card-rate,
.stat-card-critical {
  border-left: 4px solid transparent;
  transition: transform .15s, box-shadow .15s;
}
.stat-card-captures { border-left-color: #ffc107; }
.stat-card-species  { border-left-color: #0dcaf0; }
.stat-card-rate     { border-left-color: #198754; }
.stat-card-critical { border-left-color: #dc3545; }

.stat-card-captures:hover,
.stat-card-species:hover,
.stat-card-rate:hover,
.stat-card-critical:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 14px rgba(0,0,0,.1) !important;
}

/* Label de stat */
.stat-label-sm { font-size: .7rem; letter-spacing: .04em; }

/* Ligne de capture */
.capture-row:hover td { background-color: #f8f9fc !important; }
</style>
{% endblock %}

{% block js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3"></script>
<script>
// ‚îÄ‚îÄ Graphique ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ctx = document.getElementById('capturesChart').getContext('2d');
new Chart(ctx, {
  type: 'line',
  data: {
    labels:   {{ chart_labels|safe }},
    datasets: [{
      label: 'Captures',
      data:  {{ chart_data|safe }},
      borderColor: '#198754',
      backgroundColor: 'rgba(25,135,84,.08)',
      tension: 0.4,
      pointBackgroundColor: '#198754',
      pointRadius: 4,
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { display: false } },
    scales: {
      y: { beginAtZero: true, ticks: { stepSize: 1 } }
    }
  }
});

// ‚îÄ‚îÄ Tag rows pour filtre ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const rows = document.querySelectorAll('.capture-row');
  rows.forEach((row, i) => {
    const cells = row.querySelectorAll('td');
    if (cells.length < 4) return;
    const name  = cells[0] ? cells[0].textContent.trim().toLowerCase() : '';
    const level = cells[1] ? parseInt(cells[1].textContent.replace(/\D/g,'')) || 0 : 0;
    let badges  = '';
    if (cells[0].textContent.includes('Premier'))  badges += 'premier ';
    if (cells[0].textContent.includes('Critique')) badges += 'critique ';
    if (cells[5] && cells[5].querySelector('.fa-gem')) badges += 'shiny ';
    row.dataset.name   = name;
    row.dataset.level  = level;
    row.dataset.ts     = rows.length - i;
    row.dataset.badges = badges;
  });
})();

// ‚îÄ‚îÄ Live search & filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const tbody        = document.querySelector('#captureTable tbody');
  if (!tbody) return;
  const rows         = Array.from(tbody.querySelectorAll('.capture-row'));
  const searchInput  = document.getElementById('live-search');
  const badgeSel     = document.getElementById('filter-badge');
  const sortSel      = document.getElementById('filter-sort');
  const clearBtn     = document.getElementById('clear-filters');
  const countLabel   = document.getElementById('filter-count-label');

  function applyFilters() {
    const q     = searchInput.value.toLowerCase().trim();
    const badge = badgeSel.value;
    let visible = [];

    rows.forEach(row => {
      const matchQ = !q     || (row.dataset.name || '').includes(q);
      const matchB = !badge || (row.dataset.badges || '').includes(badge);
      row.style.display = (matchQ && matchB) ? '' : 'none';
      if (matchQ && matchB) visible.push(row);
    });

    // Tri
    const sort = sortSel.value;
    if (sort !== 'date-desc') {
      visible.sort((a, b) => {
        if (sort === 'date-asc')   return a.dataset.ts - b.dataset.ts;
        if (sort === 'level-desc') return b.dataset.level - a.dataset.level;
        if (sort === 'level-asc')  return a.dataset.level - b.dataset.level;
        return 0;
      });
      visible.forEach(r => tbody.appendChild(r));
    }

    const total = rows.length;
    countLabel.textContent = visible.length < total
      ? `${visible.length} / ${total} captures`
      : `${total} captures`;
  }

  searchInput.addEventListener('input',  applyFilters);
  badgeSel.addEventListener('change',    applyFilters);
  sortSel.addEventListener('change',     applyFilters);
  clearBtn.addEventListener('click', () => {
    searchInput.value = '';
    badgeSel.value    = '';
    sortSel.value     = 'date-desc';
    applyFilters();
  });

  applyFilters();
})();
</script>
{% endblock %}