{% extends "base.html" %}
{% load static %} {% load custom_filters %}

{% block title %}<title>Journal de Captures</title>{% endblock title %}

{% block content %}
<div class="container mt-4">
  
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h1>
        <i class="fas fa-book"></i> Journal de Captures
      </h1>
      <p class="text-muted">Historique complet de vos captures</p>
    </div>
  </div>

  <!-- Statistiques -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <i class="fas fa-trophy fa-2x text-warning mb-2"></i>
          <h3>{{ stats.total_captures }}</h3>
          <small class="text-muted">Captures Totales</small>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <i class="fas fa-star fa-2x text-info mb-2"></i>
          <h3>{{ stats.unique_species }}</h3>
          <small class="text-muted">Esp√®ces Uniques</small>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <i class="fas fa-chart-line fa-2x text-success mb-2"></i>
          <h3>{{ stats.success_rate }}%</h3>
          <small class="text-muted">Taux de R√©ussite</small>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <i class="fas fa-fire fa-2x text-danger mb-2"></i>
          <h3>{{ stats.critical_catches }}</h3>
          <small class="text-muted">Captures Critiques</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtres live -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row">
        <div class="col-md-5 mb-2">
          <div class="input-group">
            <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-search"></i></span></div>
            <input type="text" id="live-search" class="form-control" placeholder="Rechercher un Pok√©mon..." autocomplete="off">
          </div>
        </div>
        <div class="col-md-3 mb-2">
          <select id="filter-badge" class="form-control">
            <option value="">Toutes les badges</option>
            <option value="premier">‚≠ê Premier captur√©</option>
            <option value="critique">‚ö° Capture critique</option>
            <option value="shiny">üíé Shiny</option>
          </select>
        </div>
        <div class="col-md-2 mb-2">
          <select id="filter-sort" class="form-control">
            <option value="date-desc">Plus r√©cent</option>
            <option value="date-asc">Plus ancien</option>
            <option value="level-desc">Niveau ‚Üì</option>
            <option value="level-asc">Niveau ‚Üë</option>
          </select>
        </div>
        <div class="col-md-2 mb-2">
          <button id="clear-filters" class="btn btn-light w-100">
            <i class="fas fa-times"></i> R√©initialiser
          </button>
        </div>
      </div>
      <div class="mt-1"><small class="text-muted" id="filter-count-label"></small></div>
    </div>
  </div>

  <!-- Liste des captures -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Captures R√©centes</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="thead-light">
            <tr>
              <th>Pok√©mon</th>
              <th>Niveau</th>
              <th>Ball Utilis√©e</th>
              <th>Date</th>
              <th>Tentatives</th>
              <th>Badges</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in captures %}
            <tr>
              <td>
                <img src="{% static 'img/sprites_gen5/' %}{% if entry.pokemon.is_shiny %}shiny{% else %}normal{% endif %}/{{ entry.pokemon.species.name|lowerPokemonFileNames }}.png"
                     width="40" class="me-2"
                     onerror="this.src='{% static 'img/pokeball.png' %}'">
                <strong>{{ entry.pokemon.species.name }}</strong>
                {% if entry.is_first_catch %}
                <span class="badge bg-warning ms-2">
                  <i class="fas fa-star"></i> Premier
                </span>
                {% endif %}
                {% if entry.is_critical_catch %}
                <span class="badge bg-danger ms-2">
                  <i class="fas fa-bolt"></i> Critique
                </span>
                {% endif %}
              </td>
              <td>Niv. {{ entry.level_at_capture }}</td>
              <td>
                <img src="{% static 'img/pokeballSprites/' %}{{ entry.ball_used.name|lower }}_Sprite.png"
                     width="25" class="me-1"
                     onerror="this.src='{% static 'img/pokeball.png' %}'">
                {{ entry.ball_used.name }}
              </td>
              <td>{{ entry.captured_at|date:"d/m/Y H:i" }}</td>
              <td>
                <span class="badge bg-secondary">
                  {{ entry.attempts_before_success }} essai{{ entry.attempts_before_success|pluralize }}
                </span>
              </td>
              <td>
                {% if entry.is_first_catch %}
                <i class="fas fa-star text-warning" title="Premier captur√©"></i>
                {% endif %}
                {% if entry.is_critical_catch %}
                <i class="fas fa-bolt text-danger" title="Capture critique"></i>
                {% endif %}
                {% if entry.is_shiny %}
                <i class="fas fa-gem text-info" title="Shiny"></i>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">
                Aucune capture pour le moment
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Graphique -->
  <div class="card mt-4">
    <div class="card-header">
      <h5 class="mb-0">√âvolution des Captures</h5>
    </div>
    <div class="card-body">
      <canvas id="capturesChart" height="80"></canvas>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3"></script>
<script>
// Graphique des captures
const ctx = document.getElementById('capturesChart').getContext('2d');
new Chart(ctx, {
  type: 'line',
  data: {
    labels: {{ chart_labels|safe }},
    datasets: [{
      label: 'Captures',
      data: {{ chart_data|safe }},
      borderColor: '#4CAF50',
      backgroundColor: 'rgba(76, 175, 80, 0.1)',
      tension: 0.4
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: {
        display: false
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          stepSize: 1
        }
      }
    }
  }
});

// ‚îÄ‚îÄ Tag rows with data attributes for filtering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const rows = document.querySelectorAll('tbody tr');
  rows.forEach((row, i) => {
    const cells = row.querySelectorAll('td');
    if (cells.length < 4) return;
    const name  = cells[0] ? cells[0].textContent.trim().toLowerCase() : '';
    const level = cells[1] ? parseInt(cells[1].textContent.replace(/\D/g,'')) || 0 : 0;
    const ts    = row.dataset.ts || (rows.length - i); // fallback order
    let badges  = '';
    if (cells[0] && cells[0].textContent.includes('Premier'))  badges += 'premier ';
    if (cells[0] && cells[0].textContent.includes('Critique')) badges += 'critique ';
    if (cells[5] && cells[5].querySelector('.fa-gem'))         badges += 'shiny ';
    row.dataset.name   = name;
    row.dataset.level  = level;
    row.dataset.ts     = ts;
    row.dataset.badges = badges;
  });
})();

// ‚îÄ‚îÄ Live search & filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const tbody       = document.querySelector('tbody');
  if (!tbody) return;
  const rows        = Array.from(tbody.querySelectorAll('tr[data-name]'));
  const searchInput = document.getElementById('live-search');
  const badgeSel    = document.getElementById('filter-badge');
  const sortSel     = document.getElementById('filter-sort');
  const clearBtn    = document.getElementById('clear-filters');
  const countLabel  = document.getElementById('filter-count-label');

  function applyFilters() {
    const q     = searchInput.value.toLowerCase().trim();
    const badge = badgeSel.value;
    let visible = [];

    rows.forEach(row => {
      const name     = (row.dataset.name || '').toLowerCase();
      const badges   = (row.dataset.badges || '');
      const matchQ   = !q || name.includes(q);
      const matchB   = !badge || badges.includes(badge);
      const show     = matchQ && matchB;
      row.style.display = show ? '' : 'none';
      if (show) visible.push(row);
    });

    // Sort
    const sort = sortSel.value;
    if (sort !== 'date-desc') {
      visible.sort((a, b) => {
        if (sort === 'date-asc')   return a.dataset.ts - b.dataset.ts;
        if (sort === 'level-desc') return b.dataset.level - a.dataset.level;
        if (sort === 'level-asc')  return a.dataset.level - b.dataset.level;
        return 0;
      });
      visible.forEach(r => tbody.appendChild(r));
    }

    const total = rows.length;
    countLabel.textContent = visible.length < total
      ? `${visible.length} / ${total} captures`
      : `${total} captures`;
  }

  searchInput.addEventListener('input', applyFilters);
  badgeSel.addEventListener('change', applyFilters);
  sortSel.addEventListener('change', applyFilters);
  clearBtn.addEventListener('click', () => {
    searchInput.value = '';
    badgeSel.value    = '';
    sortSel.value     = 'date-desc';
    applyFilters();
  });

  applyFilters(); // init count
})();

</script>
{% endblock %}