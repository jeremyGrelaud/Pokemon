{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}<title>Carte de Kanto</title>{% endblock %}

{% block content %}
<div class="container-fluid">
  <h1 class="mb-4">
    <i class="fas fa-map"></i> Carte de Kanto
  </h1>

  <!-- Position actuelle -->
  <div class="alert alert-info d-flex align-items-center gap-2">
    <img src="{% static 'img/mapSprites/Kanto/' %}{{ current_zone.name|zone_image_path }}"
         alt="{{ current_zone.name }}"
         style="width:48px;height:36px;object-fit:cover;border-radius:4px;"
         onerror="this.style.display='none';">
    <span>
      <i class="fas fa-map-marker-alt"></i>
      <strong>Position actuelle :</strong> {{ current_zone.name }}
    </span>
  </div>

  <!-- Bouton de retour vers position actuelle -->
  <div class="mb-3 d-flex align-items-center gap-2">
    <button class="btn btn-sm btn-success" onclick="scrollToCurrentZone()">
      <i class="fas fa-crosshairs"></i> Ma position
    </button>
    <small class="text-muted">{{ zones|length }} zone{% if zones|length > 1 %}s{% endif %} disponible{% if zones|length > 1 %}s{% endif %}</small>
  </div>

  <!-- Liste des zones (scrollable) -->
  <div id="zones-container" style="max-height:72vh; overflow-y:auto; padding-right:4px;">
  <div class="row">
    {% for zone_data in zones %}
    <div class="col-md-4 mb-4">
      <div class="card zone-card h-100 {% if zone_data.zone == current_zone %}current-zone{% endif %} {% if not zone_data.accessible %}locked-zone{% endif %}" {% if zone_data.zone == current_zone %}id="current-zone-card"{% endif %}>

        <!-- Image de la zone -->
        <img src="{% static 'img/mapSprites/Kanto/' %}{{ zone_data.zone.name|zone_image_path }}"
             alt="{{ zone_data.zone.name }}"
             class="card-img-top"
             style="height:120px; object-fit:cover;"
             onerror="this.style.display='none';">

        <div class="card-header d-flex align-items-center justify-content-between py-2">
          <h5 class="mb-0 text-truncate">
            {% if zone_data.zone == current_zone %}
              <i class="fas fa-map-marker-alt text-success"></i>
            {% elif zone_data.visited %}
              <i class="fas fa-check text-primary"></i>
            {% else %}
              <i class="fas fa-map-pin"></i>
            {% endif %}
            {{ zone_data.zone.name }}
          </h5>
          <small class="text-muted ml-2 text-nowrap">{{ zone_data.zone.get_zone_type_display }}</small>
        </div>

        <div class="card-body">
          <p class="text-muted small mb-2">{{ zone_data.zone.description|truncatewords:15 }}</p>

          <div class="mb-3">
            <span class="badge badge-secondary">
              <i class="fas fa-signal"></i> Niv. {{ zone_data.zone.recommended_level_min }}-{{ zone_data.zone.recommended_level_max }}
            </span>
            {% if zone_data.zone.has_pokemon_center %}
            <span class="badge badge-info">
              <i class="fas fa-hospital"></i> Centre
            </span>
            {% endif %}
            {% if zone_data.zone.has_shop %}
            <span class="badge badge-warning">
              <i class="fas fa-shopping-cart"></i> Boutique
            </span>
            {% endif %}
          </div>

          {% if zone_data.accessible %}
          <a href="{% url 'zone_detail' zone_data.zone.id %}" class="btn btn-primary btn-sm btn-block">
            <i class="fas fa-eye"></i> Explorer
          </a>
          {% else %}
          <button class="btn btn-secondary btn-sm btn-block" disabled>
            <i class="fas fa-lock"></i> {{ zone_data.reason }}
          </button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>{# /row #}
  </div>{# /zones-container #}
</div>

<style>
/* Scrollbar discrète */
#zones-container::-webkit-scrollbar { width: 6px; }
#zones-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
#zones-container::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 3px; }
#zones-container::-webkit-scrollbar-thumb:hover { background: #6c757d; }

.zone-card {
  transition: all 0.3s ease;
  border: 2px solid #ddd;
}
.zone-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}
.current-zone {
  border-color: #28a745;
  box-shadow: 0 0 0 3px rgba(40,167,69,0.25);
}
.current-zone .card-img-top {
  border-top: 3px solid #28a745;
}
.locked-zone {
  opacity: 0.6;
}
.locked-zone .card-img-top {
  filter: grayscale(80%);
}
</style>

<script>
function scrollToCurrentZone() {
  const card = document.getElementById('current-zone-card');
  const container = document.getElementById('zones-container');
  if (!card || !container) return;

  // Offset du card dans le container
  const cardTop    = card.getBoundingClientRect().top;
  const contTop    = container.getBoundingClientRect().top;
  const scrollTo   = container.scrollTop + (cardTop - contTop) - 20;

  container.scrollTo({ top: scrollTo, behavior: 'smooth' });

  // Petit flash pour attirer l'œil
  card.style.transition = 'box-shadow 0.3s';
  card.style.boxShadow  = '0 0 0 5px rgba(40,167,69,0.6)';
  setTimeout(() => { card.style.boxShadow = ''; }, 1200);
}

// Auto-scroll au chargement
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(scrollToCurrentZone, 300);
});
</script>
{% endblock %}