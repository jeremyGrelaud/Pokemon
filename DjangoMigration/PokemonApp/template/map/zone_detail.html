{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}<title>{{ zone.name }}</title>{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="mb-3">
    <a href="{% url 'map_view' %}" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> Retour à la carte
    </a>
  </div>

  <div class="row">
    <!-- ── Colonne principale ─────────────────────────────────────── -->
    <div class="col-lg-8 col-xl-9">

      <div class="card">
        <!-- Header avec image de zone -->
        <div class="card-header bg-primary text-white p-0 position-relative" style="overflow:hidden; min-height:180px;">
          <img src="{% static 'img/mapSprites/Kanto/' %}{{ zone.name|zone_image_path }}"
              alt="{{ zone.name }}"
              class="w-100"
              style="object-fit:cover; max-height:220px; opacity:0.55;"
              onerror="this.style.display='none';">
          <div class="position-absolute w-100 p-3" style="bottom:0; background: linear-gradient(transparent, rgba(0,0,0,0.6));">
            <h2 class="mb-0 text-white">
              <i class="fas fa-map-marker-alt"></i> {{ zone.name }}
            </h2>
            <p class="mb-0 text-white-50">{{ zone.get_zone_type_display }}</p>
          </div>
        </div>

        <div class="card-body">
          <p>{{ zone.description }}</p>

          <div class="mb-3">
            <span class="badge badge-info">
              Niveau recommandé: {{ zone.recommended_level_min }}-{{ zone.recommended_level_max }}
            </span>
            {% if is_current %}
            <span class="badge badge-success">
              <i class="fas fa-check"></i> Vous êtes ici
            </span>
            {% endif %}
          </div>

          <!-- ══════════════════════════════════════════════════════════════
               ACTIONS — uniquement si le joueur est dans cette zone
          ══════════════════════════════════════════════════════════════════ -->
          {% if is_current %}
          <div class="zone-actions mb-4">

            <!-- ── Hautes Herbes (hero card pleine largeur) ──────────────── -->
            {% if not zone.is_safe_zone and not zone.has_floors %}
            <a href="{% url 'wild_encounter' zone.id %}?type=grass"
               class="action-card action-card--grass action-card--hero">
              <div class="action-card__bg"></div>
              <div class="action-card__inner">
                <div class="action-card__icon-wrap">
                  <img src="{% static 'img/mapSprites/Kanto/Tall_Grass.png' %}"
                       alt="Hautes herbes"
                       class="action-card__img action-card__img--large"
                       onerror="this.style.display='none';">
                </div>
                <div class="action-card__text">
                  <div class="action-card__title">Hautes Herbes</div>
                  <div class="action-card__subtitle">
                    Partez à la rencontre de Pokémon sauvages dans la zone
                  </div>
                </div>
                <div class="action-card__cta">
                  <i class="fas fa-search mr-2"></i>Chercher un Pokémon
                  <i class="fas fa-arrow-right ml-2 action-card__arrow"></i>
                </div>
              </div>
            </a>
            {% endif %}

            <!-- ── Grille des autres actions ─────────────────────────────── -->
            <div class="action-grid mt-3">

              <!-- Centre Pokémon -->
              {% if zone.has_pokemon_center %}
              {% if pokemon_center %}
              <a href="{% url 'PokemonCenterDetailView' pokemon_center.id %}"
                 class="action-card action-card--center {% if team_needs_healing %}action-card--urgent{% endif %}">
              {% else %}
              <a href="{% url 'PokemonCenterListView' %}"
                 class="action-card action-card--center">
              {% endif %}
                <div class="action-card__inner">
                  <div class="action-card__icon-wrap">
                    <img src="{% static 'img/mapSprites/Kanto/pokeCenter.png' %}"
                         alt="Centre Pokémon"
                         class="action-card__img {% if team_needs_healing %}action-card__img--glow-warn{% endif %}"
                         onerror="this.style.display='none';">
                  </div>
                  <div class="action-card__text">
                    <div class="action-card__title">Centre Pokémon</div>
                    {% if team_needs_healing %}
                    <div class="action-card__alert">
                      <i class="fas fa-exclamation-triangle mr-1"></i>Équipe affaiblie !
                    </div>
                    {% endif %}
                    <div class="action-card__subtitle">
                      {% if pokemon_center %}{{ pokemon_center.nurse_name }}{% else %}Soignez votre équipe gratuitement{% endif %}
                    </div>
                  </div>
                  <div class="action-card__cta">
                    <i class="fas fa-heartbeat mr-2"></i>
                    {% if team_needs_healing %}Soigner l'équipe !{% else %}Entrer au centre{% endif %}
                  </div>
                </div>
              </a>
              {% endif %}

              <!-- Pokemart / Boutique -->
              {% if zone.has_shop %}
              {% if zone_shop %}
              <a href="{% url 'ShopDetailView' zone_shop.id %}" class="action-card action-card--shop">
              {% else %}
              <a href="{% url 'ShopListView' %}" class="action-card action-card--shop">
              {% endif %}
                <div class="action-card__inner">
                  <div class="action-card__icon-wrap">
                    <img src="{% static 'img/mapSprites/Kanto/pokeMart.png' %}"
                         alt="Pokemart"
                         class="action-card__img"
                         onerror="this.style.display='none';">
                  </div>
                  <div class="action-card__text">
                    <div class="action-card__title">Pokemart</div>
                    <div class="action-card__subtitle">
                      {% if zone_shop %}{{ zone_shop.name }}{% else %}Achetez objets et équipements{% endif %}
                    </div>
                  </div>
                  <div class="action-card__cta">
                    <i class="fas fa-store mr-2"></i>Entrer dans la boutique
                  </div>
                </div>
              </a>
              {% endif %}

              <!-- Arène / Gym Leader -->
              {% if gym_leader %}
              <a href="{% if gym_leader_defeated %}#{% else %}{% url 'battle_challenge_gym' gym_leader.id %}{% endif %}"
                 class="action-card action-card--gym {% if gym_leader_defeated %}action-card--done{% endif %}"
                 {% if gym_leader_defeated %}style="pointer-events:none;"{% endif %}>
                <div class="action-card__inner">
                  <div class="action-card__icon-wrap">
                    <img src="{% static 'img/trainer_sprites/' %}{{ gym_leader.trainer|trainer_sprite_path }}"
                         alt="{{ gym_leader.trainer.username }}"
                         class="action-card__img action-card__img--trainer {% if gym_leader_defeated %}action-card__img--defeated{% endif %}"
                         onerror="this.style.display='none';">
                  </div>
                  <div class="action-card__text">
                    <div class="action-card__title">Arène Pokémon</div>
                    <div class="action-card__subtitle">
                      <strong>{{ gym_leader.trainer.username }}</strong> — {{ gym_leader.badge_name }}
                    </div>
                    {% if gym_leader_defeated %}
                    <span class="action-card__badge-won">
                      <i class="fas fa-medal mr-1"></i>Badge obtenu
                    </span>
                    {% endif %}
                  </div>
                  <div class="action-card__cta">
                    {% if gym_leader_defeated %}
                    <i class="fas fa-check mr-2"></i>Déjà vaincu
                    {% else %}
                    <i class="fas fa-fist-raised mr-2"></i>Défier l'Arène
                    {% endif %}
                  </div>
                </div>
              </a>
              {% endif %}

            </div>{# /action-grid #}
          </div>{# /zone-actions #}
          {% endif %}

          <!-- ══════════════════════════════════════════════════════════════
               POKÉMON SAUVAGES — box stylisée
          ══════════════════════════════════════════════════════════════════ -->
          {% if wild_spawns and not zone.has_floors %}
          <div class="wild-box mb-4">
            <div class="wild-box__header">
              <i class="fas fa-paw mr-2"></i>Pokémon Sauvages
            </div>
            <div class="wild-box__body">
              {% for spawn in wild_spawns %}
              <div class="wild-row">
                <div class="wild-row__sprite">
                  <img src="{% static 'img/sprites_gen5/normal/' %}{{ spawn.pokemon.name|lowerPokemonFileNames }}.png"
                       alt="{{ spawn.pokemon.name }}"
                       onerror="this.style.display='none';">
                </div>
                <div class="wild-row__info">
                  <span class="wild-row__name">{{ spawn.pokemon.name }}</span>
                  <span class="wild-row__types">
                    <span class="type-chip type-{{ spawn.pokemon.primary_type.name|lower }}">
                      {{ spawn.pokemon.primary_type.name|upper }}
                    </span>
                    {% if spawn.pokemon.secondary_type %}
                    <span class="type-chip type-{{ spawn.pokemon.secondary_type.name|lower }}">
                      {{ spawn.pokemon.secondary_type.name|upper }}
                    </span>
                    {% endif %}
                  </span>
                </div>
                <div class="wild-row__level">
                  Niv. {{ spawn.level_min }}–{{ spawn.level_max }}
                </div>
                <div class="wild-row__rate">
                  <div class="wild-rate-bar">
                    <div class="wild-rate-fill
                      {% if spawn.spawn_rate >= 50 %}wild-rate--high
                      {% elif spawn.spawn_rate >= 20 %}wild-rate--mid
                      {% else %}wild-rate--low{% endif %}"
                      style="width:{{ spawn.spawn_rate }}%"></div>
                  </div>
                  <span class="wild-rate-pct">{{ spawn.spawn_rate }}%</span>
                </div>
                {% if not zone.is_safe_zone and is_current %}
                <div class="wild-row__cta">
                  <i class="fas fa-chevron-right"></i>
                </div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Rencontre Rival -->
          {% if rival_encounter %}
          <div class="card border-danger mb-4">
            <div class="card-header bg-danger text-white py-2 d-flex align-items-center justify-content-between">
              <h5 class="mb-0"><i class="fas fa-user-ninja"></i> Rival — {{ rival_encounter.rival.username }} !</h5>
              <span class="badge badge-light text-danger">COMBAT REQUIS</span>
            </div>
            <div class="card-body">
              {% if rival_encounter.pre_battle_text %}
              <blockquote class="blockquote mb-3">
                <p class="mb-0 font-italic">"{{ rival_encounter.pre_battle_text }}"</p>
                <footer class="blockquote-footer">{{ rival_encounter.rival.username }}</footer>
              </blockquote>
              {% endif %}
              {% if is_current %}
              <a href="{% url 'battle_create_trainer' rival_encounter.rival.id %}" class="btn btn-danger">
                <i class="fas fa-fist-raised"></i> Affronter {{ rival_encounter.rival.username }} !
              </a>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- Dresseurs -->
          {% if trainers %}
          <h4><i class="fas fa-users"></i> Dresseurs</h4>
          <div class="list-group mb-4">
            {% for entry in trainers %}
            {% with npc=entry.npc is_defeated=entry.is_defeated can_rebattle=entry.can_rebattle %}
            {% if is_defeated and not can_rebattle %}
            <div class="list-group-item list-group-item-action disabled" style="opacity:.55;cursor:default;">
              <div class="d-flex align-items-center">
                <img src="{% static 'img/trainer_sprites/' %}{{ npc|trainer_sprite_path }}"
                    alt="{{ npc.get_full_title }}"
                    style="width:48px;height:48px;object-fit:contain;margin-right:12px;flex-shrink:0;filter:grayscale(100%);"
                    onerror="this.style.display='none';">
                <div class="flex-grow-1">
                  <strong>{{ npc.get_full_title }}</strong>
                  {% if npc.is_battle_required %}
                  <span class="badge badge-danger ml-1"><i class="fas fa-exclamation-triangle"></i> Obligatoire</span>
                  {% endif %}
                  <br><small class="text-muted">{{ npc.intro_text|truncatewords:10 }}</small>
                </div>
                <span class="badge badge-secondary align-self-center"><i class="fas fa-check"></i> Vaincu</span>
              </div>
            </div>
            {% elif is_defeated and can_rebattle %}
            <a href="{% url 'battle_create_trainer' npc.id %}" class="list-group-item list-group-item-action">
              <div class="d-flex align-items-center">
                <img src="{% static 'img/trainer_sprites/' %}{{ npc|trainer_sprite_path }}"
                    alt="{{ npc.get_full_title }}"
                    style="width:48px;height:48px;object-fit:contain;margin-right:12px;flex-shrink:0;"
                    onerror="this.style.display='none';">
                <div class="flex-grow-1">
                  <strong>{{ npc.get_full_title }}</strong>
                  {% if npc.is_battle_required %}
                  <span class="badge badge-danger ml-1"><i class="fas fa-exclamation-triangle"></i> Obligatoire</span>
                  {% endif %}
                  <br><small class="text-muted">{{ npc.intro_text|truncatewords:10 }}</small>
                </div>
                <span class="badge badge-warning align-self-center"><i class="fas fa-redo"></i> Revancher</span>
              </div>
            </a>
            {% else %}
            <a href="{% url 'battle_create_trainer' npc.id %}" class="list-group-item list-group-item-action">
              <div class="d-flex align-items-center">
                <img src="{% static 'img/trainer_sprites/' %}{{ npc|trainer_sprite_path }}"
                    alt="{{ npc.get_full_title }}"
                    style="width:48px;height:48px;object-fit:contain;margin-right:12px;flex-shrink:0;"
                    onerror="this.style.display='none';">
                <div class="flex-grow-1">
                  <strong>{{ npc.get_full_title }}</strong>
                  {% if npc.is_battle_required %}
                  <span class="badge badge-warning ml-1"><i class="fas fa-exclamation-triangle"></i> Obligatoire</span>
                  {% endif %}
                  <br><small class="text-muted">{{ npc.intro_text|truncatewords:10 }}</small>
                </div>
                <span class="badge badge-danger align-self-center"><i class="fas fa-fist-raised"></i> Combattre</span>
              </div>
            </a>
            {% endif %}
            {% endwith %}
            {% endfor %}
          </div>
          {% endif %}

          <!-- Dresseurs par étage -->
          {% if floors_data %}
          <h4><i class="fas fa-building"></i> Étages & Dresseurs</h4>
          {% for fd in floors_data %}
          <div class="card mb-3 {% if not fd.accessible %}border-secondary{% endif %}">
            <div class="card-header d-flex align-items-center justify-content-between py-2
                        {% if fd.accessible %}bg-dark text-white{% else %}bg-secondary text-white{% endif %}">
              <span>
                <i class="fas fa-layer-group mr-1"></i>
                {% if fd.floor.floor_number == 0 %}Rez-de-chaussée
                {% elif fd.floor.floor_number > 0 %}Étage {{ fd.floor.floor_number }}
                {% else %}Sous-sol {{ fd.floor.floor_number|stringformat:"d"|slice:"1:" }}
                {% endif %}
                {% if fd.floor.name %} — {{ fd.floor.name }}{% endif %}
              </span>
              {% if not fd.accessible %}
              <span class="badge badge-light text-dark"><i class="fas fa-lock mr-1"></i>{{ fd.reason }}</span>
              {% elif is_current %}
              <a href="{% url 'floor_detail' zone.id fd.floor.floor_number %}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-arrow-right"></i> Explorer
              </a>
              {% endif %}
            </div>
            {% if fd.accessible %}
            <div class="card-body p-2">
              {% if fd.trainers %}
              <div class="list-group list-group-flush">
                {% for entry in fd.trainers %}
                {% with npc=entry.npc is_defeated=entry.is_defeated can_rebattle=entry.can_rebattle %}
                {% if is_defeated and not can_rebattle %}
                <div class="list-group-item disabled py-2 px-3" style="opacity:.55;">
                  <div class="d-flex align-items-center">
                    <img src="{% static 'img/trainer_sprites/' %}{{ npc|trainer_sprite_path }}"
                         style="width:40px;height:40px;object-fit:contain;margin-right:10px;flex-shrink:0;filter:grayscale(100%);"
                         onerror="this.style.display='none';">
                    <div class="flex-grow-1"><strong>{{ npc.get_full_title }}</strong><br><small class="text-muted">{{ npc.intro_text|truncatewords:8 }}</small></div>
                    <span class="badge badge-secondary"><i class="fas fa-check"></i> Vaincu</span>
                  </div>
                </div>
                {% elif is_defeated and can_rebattle %}
                <a href="{% url 'battle_create_trainer' npc.id %}" class="list-group-item list-group-item-action py-2 px-3">
                  <div class="d-flex align-items-center">
                    <img src="{% static 'img/trainer_sprites/' %}{{ npc|trainer_sprite_path }}"
                         style="width:40px;height:40px;object-fit:contain;margin-right:10px;flex-shrink:0;"
                         onerror="this.style.display='none';">
                    <div class="flex-grow-1"><strong>{{ npc.get_full_title }}</strong><br><small class="text-muted">{{ npc.intro_text|truncatewords:8 }}</small></div>
                    <span class="badge badge-warning"><i class="fas fa-redo"></i> Revancher</span>
                  </div>
                </a>
                {% else %}
                <a href="{% url 'battle_create_trainer' npc.id %}" class="list-group-item list-group-item-action py-2 px-3">
                  <div class="d-flex align-items-center">
                    <img src="{% static 'img/trainer_sprites/' %}{{ npc|trainer_sprite_path }}"
                         style="width:40px;height:40px;object-fit:contain;margin-right:10px;flex-shrink:0;"
                         onerror="this.style.display='none';">
                    <div class="flex-grow-1"><strong>{{ npc.get_full_title }}</strong><br><small class="text-muted">{{ npc.intro_text|truncatewords:8 }}</small></div>
                    <span class="badge badge-danger"><i class="fas fa-fist-raised"></i> Combattre</span>
                  </div>
                </a>
                {% endif %}
                {% endwith %}
                {% endfor %}
              </div>
              {% else %}
              <p class="text-muted small mb-0 p-2"><i class="fas fa-info-circle"></i> Aucun dresseur à cet étage.</p>
              {% endif %}
            </div>
            {% endif %}
          </div>
          {% endfor %}
          {% endif %}

          <!-- Dresseurs non assignés (fallback) -->
          {% if unassigned_trainers %}
          <div class="alert alert-warning py-2 px-3 mb-3" style="font-size:.85rem;">
            <i class="fas fa-exclamation-triangle"></i>
            Ces dresseurs ne sont pas encore assignés à un étage précis.
            Re-exécutez <code>initNPCTrainersComplete</code> pour corriger leurs locations.
          </div>
          <div class="list-group mb-4">
            {% for entry in unassigned_trainers %}
            {% with npc=entry.npc is_defeated=entry.is_defeated can_rebattle=entry.can_rebattle %}
            {% if is_defeated and not can_rebattle %}
            <div class="list-group-item disabled py-2 px-3" style="opacity:.55;">
              <div class="d-flex align-items-center">
                <img src="{% static 'img/trainer_sprites/' %}{{ npc|trainer_sprite_path }}"
                     style="width:40px;height:40px;object-fit:contain;margin-right:10px;flex-shrink:0;filter:grayscale(100%);"
                     onerror="this.style.display='none';">
                <div class="flex-grow-1"><strong>{{ npc.get_full_title }}</strong></div>
                <span class="badge badge-secondary"><i class="fas fa-check"></i> Vaincu</span>
              </div>
            </div>
            {% else %}
            <a href="{% url 'battle_create_trainer' npc.id %}" class="list-group-item list-group-item-action py-2 px-3">
              <div class="d-flex align-items-center">
                <img src="{% static 'img/trainer_sprites/' %}{{ npc|trainer_sprite_path }}"
                     style="width:40px;height:40px;object-fit:contain;margin-right:10px;flex-shrink:0;"
                     onerror="this.style.display='none';">
                <div class="flex-grow-1"><strong>{{ npc.get_full_title }}</strong></div>
                <span class="badge badge-danger"><i class="fas fa-fist-raised"></i> Combattre</span>
              </div>
            </a>
            {% endif %}
            {% endwith %}
            {% endfor %}
          </div>
          {% endif %}

        </div>{# /card-body #}
      </div>{# /card #}
    </div>{# /col principal #}

    <!-- ── Colonne minimap ─────────────────────────────────────────── -->
    <div class="col-lg-4 col-xl-3 mt-3 mt-lg-0">
      <div class="zone-minimap-panel">
        <div class="card shadow-sm">
          <div class="card-header py-2 text-center">
            <strong><i class="fas fa-map-marked-alt"></i> Position sur la carte</strong>
          </div>
          <div class="card-body p-2 text-center">
            {% with minimap=zone.name|zone_minimap_path %}
            <img src="{% static 'img/mapSprites/Kanto/' %}{{ minimap }}"
                 alt="Localisation {{ zone.name }}"
                 class="img-fluid minimap-gif">
            {% endwith %}
            <p class="text-muted small mt-2 mb-0">
              <i class="fas fa-map-marker-alt text-danger"></i>
              <strong>{{ zone.name }}</strong>
            </p>
          </div>

          {% if active_quests %}
          <div class="card-header py-2 text-center">
            <strong><i class="fas fa-scroll text-warning"></i> Quêtes en cours</strong>
          </div>
          <div class="p-2">
            {% for progress in active_quests %}
            <div class="d-flex align-items-start mb-2">
              <span style="width:8px;height:8px;border-radius:50%;background:#f6c23e;flex-shrink:0;margin-top:5px;margin-right:8px;display:inline-block;"></span>
              <div>
                <div class="font-weight-bold" style="font-size:.8rem;">{{ progress.quest.title }}</div>
                {% if progress.quest.objective_text %}
                <div class="text-muted" style="font-size:.72rem;">{{ progress.quest.objective_text }}</div>
                {% endif %}
              </div>
            </div>
            {% endfor %}
            <a href="{% url 'quest_log' %}" class="btn btn-outline-warning btn-block btn-sm mt-1">
              Journal complet
            </a>
          </div>
          {% endif %}

          <div class="card-header py-2 text-center">
            <strong><i class="fas fa-route p-2"></i> Zones Adjacentes</strong>
          </div>
          <div class="row p-2">
            {% for conn in connections %}
            <div class="col-md-6 mb-3">
              <div class="card">
                <img src="{% static 'img/mapSprites/Kanto/' %}{{ conn.to_zone.name|zone_image_path }}"
                    alt="{{ conn.to_zone.name }}"
                    class="card-img-top"
                    style="height:80px; object-fit:cover; opacity:0.75;"
                    onerror="this.style.display='none';">
                <div class="card-body py-2">
                  <h6 class="mb-1">{{ conn.to_zone.name }}</h6>
                  {% if is_current %}
                  <a href="{% url 'travel_to_zone' conn.to_zone.id %}" class="btn btn-sm btn-primary">
                    <i class="fas fa-arrow-right"></i> Voyager
                  </a>
                  {% else %}
                  <small class="text-muted">Revenez ici pour voyager</small>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>

        </div>
      </div>
    </div>{# /col minimap #}

  </div>{# /row #}
</div>{# /container-fluid #}

{% if zone.music %}
<div id="zone-bgm-player" class="zone-bgm-widget" title="Musique de zone">
  <button id="bgm-toggle" class="bgm-btn" aria-label="Lecture / Pause">
    <i class="fas fa-music" id="bgm-icon"></i>
  </button>
  <div class="bgm-info">
    <span id="bgm-zone-name" class="bgm-zone-name">{{ zone.name }}</span>
    <div class="bgm-progress-wrap">
      <div id="bgm-progress-bar" class="bgm-progress-bar"></div>
    </div>
  </div>
  <input id="bgm-volume" type="range" min="0" max="100" value="30"
         class="bgm-volume" title="Volume" aria-label="Volume">
</div>
{% endif %}

{% endblock %}

{% block css %}
  {{ block.super }}
  <link href="{% static 'css/zone-detail.css'%}" rel="stylesheet" />
{% endblock css %}

{% block js %}
{{ block.super }}
{% if zone.music %}
<script>
(function() {
  const TRACK = '{% static "sounds/bgm/kanto/" %}{{ zone.music }}.mp3';
  const STORAGE_KEY_VOL = 'zoneBgmVolume';
  const widget   = document.getElementById('zone-bgm-player');
  const toggleBtn= document.getElementById('bgm-toggle');
  const icon     = document.getElementById('bgm-icon');
  const progress = document.getElementById('bgm-progress-bar');
  const volumeEl = document.getElementById('bgm-volume');
  let audio = null, playing = false;
  const savedVol = parseFloat(localStorage.getItem(STORAGE_KEY_VOL) ?? '30');
  volumeEl.value = savedVol;
  function buildAudio() {
    if (audio) audio.pause();
    audio = new Audio(TRACK);
    audio.loop = true;
    audio.volume = volumeEl.value / 100;
    audio.addEventListener('timeupdate', () => {
      if (audio.duration) progress.style.width = (audio.currentTime / audio.duration * 100) + '%';
    });
    audio.addEventListener('error', () => { widget.style.display = 'none'; });
  }
  function play() {
    if (!audio) buildAudio();
    audio.play().then(() => {
      playing = true; icon.className = 'fas fa-pause';
      toggleBtn.classList.remove('paused'); widget.classList.remove('bgm-idle');
    }).catch(() => {});
  }
  function pause() {
    if (audio) audio.pause();
    playing = false; icon.className = 'fas fa-music';
    toggleBtn.classList.add('paused'); widget.classList.add('bgm-idle');
  }
  toggleBtn.addEventListener('click', () => playing ? pause() : play());
  volumeEl.addEventListener('input', () => {
    const vol = volumeEl.value / 100;
    if (audio) audio.volume = vol;
    localStorage.setItem(STORAGE_KEY_VOL, volumeEl.value);
  });
  buildAudio(); widget.classList.add('bgm-idle'); play();
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && audio) audio.volume = Math.min(audio.volume, 0.1);
    else if (!document.hidden && audio && playing) audio.volume = volumeEl.value / 100;
  });
})();
</script>
{% endif %}
{% endblock js %}