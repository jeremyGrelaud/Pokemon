{% extends "base.html" %}
{% load static %}
{% block css %}
{{ block.super }}
<link href="{% static 'css/move-detail.css' %}" rel="stylesheet" />
{% endblock css %}
{% load custom_filters %}

{% block title %}<title>{{ move.name }} — Capacité</title>{% endblock %}

{% block content %}

{# ─── Breadcrumb + bouton retour ──────────────────────────────────────────── #}
<div class="d-flex align-items-center justify-content-between mb-3 move-breadcrumb">
  <div>
    <a href="{% url 'PokemonMoveOverView' %}"><i class="fas fa-bolt"></i> Capacités</a>
    <span>›</span>
    <strong>{{ move.name }}</strong>
  </div>
  <a href="{% url 'PokemonMoveOverView' %}" class="btn btn-sm btn-outline-secondary">
    <i class="fas fa-arrow-left me-1"></i>Retour à la liste
  </a>
</div>

<div class="row g-4">

  {# ─── Carte principale ──────────────────────────────────────────────────── #}
  <div class="col-lg-5">
    <div class="card shadow move-main-card h-100">
      <div class="card-body p-0">

        {# Bandeau coloré selon le type #}
        <div class="move-banner move-banner-type-{{ move.type.name|lower }} d-flex align-items-center justify-content-between px-4 py-3">
          <div>
            <div class="move-banner-name">{{ move.name }}</div>
            <small style="opacity:.75;font-size:.78rem;letter-spacing:.3px;">
              {{ move.get_category_display }} — {{ move.type.name|capfirst }}
            </small>
          </div>
          <span class="badge badge-type-{{ move.type.name|lower }} move-banner-badge">
            {{ move.type.name|upper }}
          </span>
        </div>

        {# Corps #}
        <div class="px-4 py-3">

          {# Catégorie #}
          <div class="move-info-row border-bottom pb-2 mb-2">
            <span class="move-label">Catégorie</span>
            <span class="move-value d-flex align-items-center" style="gap:8px;">
              <img src="{% static 'img/movesTypesSprites/' %}move-{{ move.category }}.png"
                   alt="{{ move.category }}"
                   style="width:28px;height:28px;object-fit:contain;">
              <strong>{{ move.get_category_display }}</strong>
            </span>
          </div>

          {# Bulles de stats #}
          <div class="row text-center my-4">
            <div class="col-4">
              <div class="stat-bubble {% if move.power and move.power > 0 %}stat-bubble-power{% else %}stat-bubble-none{% endif %}">
                {% if move.power and move.power > 0 %}{{ move.power }}{% else %}—{% endif %}
              </div>
              <small class="text-muted d-block mt-2 fw-semibold" style="font-size:.7rem;letter-spacing:.5px;text-transform:uppercase;">Puissance</small>
            </div>
            <div class="col-4">
              <div class="stat-bubble stat-bubble-acc">
                {% if move.accuracy %}{{ move.accuracy }}{% else %}∞{% endif %}
              </div>
              <small class="text-muted d-block mt-2 fw-semibold" style="font-size:.7rem;letter-spacing:.5px;text-transform:uppercase;">
                Précision{% if move.accuracy %}%{% endif %}
              </small>
            </div>
            <div class="col-4">
              <div class="stat-bubble stat-bubble-pp">{{ move.pp }}</div>
              <small class="text-muted d-block mt-2 fw-semibold" style="font-size:.7rem;letter-spacing:.5px;text-transform:uppercase;">PP</small>
            </div>
          </div>

          {# Infos complémentaires #}
          <div class="border-top pt-3">

            {% if move.priority != 0 %}
            <div class="move-info-row">
              <span class="move-label">Priorité</span>
              <span class="move-value">
                {% if move.priority > 0 %}
                  <span class="badge bg-success fw-bold px-3">+{{ move.priority }}</span>
                {% else %}
                  <span class="badge bg-danger fw-bold px-3">{{ move.priority }}</span>
                {% endif %}
              </span>
            </div>
            {% endif %}

            {% if move.max_pp and move.max_pp != move.pp %}
            <div class="move-info-row">
              <span class="move-label">PP Maximum</span>
              <span class="move-value fw-bold">{{ move.max_pp }}</span>
            </div>
            {% endif %}

            {# Nombre d'apprenants #}
            <div class="move-info-row">
              <span class="move-label">Pokémon apprenants</span>
              <span class="move-value">
                <span class="badge bg-secondary text-white px-3">{{ learners|length }}</span>
              </span>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  {# ─── Colonne droite ────────────────────────────────────────────────────── #}
  <div class="col-lg-7 d-flex flex-column gap-3">

    {# Effets & statut #}
    {% if move.effect or move.inflicts_status or move.effect_chance %}
    <div class="card shadow">
      <div class="card-header py-2">
        <h6 class="mb-0 fw-bold text-secondary">
          <i class="fas fa-magic me-1"></i> Effets
        </h6>
      </div>
      <div class="card-body">

        {% if move.inflicts_status %}
        <div class="d-flex align-items-center gap-3 mb-3">
          <span class="move-label">Statut infligé</span>
          <span class="badge bg-danger px-3 py-2" style="font-size:.82rem;border-radius:20px;">
            <i class="fas fa-skull-crossbones me-1"></i>{{ move.inflicts_status|upper }}
          </span>
          {% if move.effect_chance %}
          <span class="text-muted small">({{ move.effect_chance }}% de chance)</span>
          {% endif %}
        </div>
        {% endif %}

        {% if move.effect %}
        <div class="effect-box {% if move.inflicts_status %}mt-1{% endif %}">
          <i class="fas fa-info-circle text-info me-2"></i>{{ move.effect }}
        </div>
        {% endif %}

        {% if move.effect_chance and not move.inflicts_status %}
        <div class="move-info-row mt-3">
          <span class="move-label">Chance d'effet</span>
          <span class="d-flex align-items-center gap-2">
            <div class="effect-chance-bar">
              <div class="effect-chance-fill" style="width:{{ move.effect_chance }}%;"></div>
            </div>
            <strong>{{ move.effect_chance }}%</strong>
          </span>
        </div>
        {% endif %}

      </div>
    </div>
    {% endif %}

    {# Modificateurs de stats #}
    {% if move.stat_changes %}
    <div class="card shadow">
      <div class="card-header py-2">
        <h6 class="mb-0 fw-bold text-secondary">
          <i class="fas fa-chart-line me-1"></i> Modificateurs de stats
        </h6>
      </div>
      <div class="card-body py-2">
        {% for stat, val in move.stat_changes.items %}
        <div class="d-flex align-items-center justify-content-between py-2 {% if not forloop.last %}border-bottom{% endif %}">
          <span class="text-capitalize fw-medium">{{ stat|title }}</span>
          {% if val > 0 %}
          <span class="badge bg-success px-3 py-2" style="border-radius:20px;">
            <i class="fas fa-arrow-up me-1"></i>+{{ val }}
          </span>
          {% else %}
          <span class="badge bg-danger px-3 py-2" style="border-radius:20px;">
            <i class="fas fa-arrow-down me-1"></i>{{ val }}
          </span>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {# Pokémon apprenants #}
    <div class="card shadow flex-grow-1">
      <div class="card-header py-2 d-flex align-items-center justify-content-between">
        <h6 class="mb-0 fw-bold text-secondary">
          <i class="fas fa-list me-1"></i> Pokémon apprenant cette capacité
        </h6>
        <span class="badge bg-secondary text-white">{{ learners|length }}</span>
      </div>
      <div class="card-body">
        {% if learners %}

        {# Tri : niveau 1 (départ) d'abord, puis par niveau #}
        <div class="d-flex flex-wrap" style="gap:6px;">
          {% for lm in learners %}
          <a href="{% url 'PokemonDetailView' lm.pokemon.id %}"
             class="learner-chip badge-type-{{ lm.pokemon.primary_type.name|lower }}"
             title="{{ lm.pokemon.name }} — appris au niveau {{ lm.level_learned }}">
            <img src="{% static 'img/sprites_gen5/normal/' %}{{ lm.pokemon.name|lowerPokemonFileNames }}.png"
                 alt="{{ lm.pokemon.name }}"
                 style="width:30px;height:30px;object-fit:contain;"
                 onerror="this.style.display='none'">
            <span>{{ lm.pokemon.name }}</span>
            <small class="learner-lv">Niv.{{ lm.level_learned }}</small>
          </a>
          {% endfor %}
        </div>

        {# Résumé rapide #}
        <div class="mt-3 pt-2 border-top d-flex gap-3" style="font-size:.78rem;color:#aaa;">
          <span><i class="fas fa-layer-group me-1"></i>{{ learners|length }} Pokémon</span>
          {% with first=learners.0 %}
          {% if first %}
          <span><i class="fas fa-sort-numeric-up me-1"></i>Niveau min : {{ first.level_learned }}</span>
          {% endif %}
          {% endwith %}
        </div>

        {% else %}
        <div class="text-center py-4">
          <i class="fas fa-ghost fa-2x text-muted mb-2 d-block"></i>
          <p class="text-muted small mb-0">Aucun Pokémon n'apprend cette capacité.</p>
        </div>
        {% endif %}
      </div>
    </div>

  </div>{# /col-lg-7 #}
</div>{# /row #}

{% endblock content %}