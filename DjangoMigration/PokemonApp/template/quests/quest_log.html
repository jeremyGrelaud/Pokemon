{% extends "base.html" %}
{% load static %}
{% block css %}
{{ block.super }}
<link href="{% static 'css/quest-log.css' %}" rel="stylesheet" />
{% endblock css %}

{% block title %}<title>Journal de Quêtes</title>{% endblock %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0">
    <i class="fas fa-scroll text-warning me-2"></i>Journal de Quêtes
  </h1>
  <div class="d-flex gap-2">
    <span class="badge bg-primary px-3 py-2">{{ active_count }} en cours</span>
    <span class="badge bg-success px-3 py-2">{{ completed_count }} terminée{% if completed_count != 1 %}s{% endif %}</span>
  </div>
</div>

<div class="row">

  {# ── Quêtes en cours ─────────────────────────────────────────────────────── #}
  <div class="col-lg-8 mb-4">
    <div class="card shadow">
      <div class="card-header py-3 d-flex align-items-center justify-content-between">
        <h6 class="m-0 fw-bold text-primary">
          <i class="fas fa-tasks me-2"></i>En cours
        </h6>
        <span class="badge bg-primary">{{ log.active|length }}</span>
      </div>
      <div class="card-body p-0">
        {% if log.active %}
          {% for progress in log.active %}
          <div class="quest-item quest-active d-flex align-items-start p-3 border-bottom">
            <div class="quest-icon me-3 flex-shrink-0">
              <i class="fas {{ progress.quest.icon }} fa-lg text-warning"></i>
            </div>
            <div class="flex-grow-1">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <strong class="quest-title">{{ progress.quest.title }}</strong>
                {% if progress.quest.quest_type == 'main' %}
                  <span class="badge bg-warning text-dark ms-1">{{ progress.quest.get_quest_type_display }}</span>
                {% elif progress.quest.quest_type == 'rival' %}
                  <span class="badge bg-danger ms-1">{{ progress.quest.get_quest_type_display }}</span>
                {% else %}
                  <span class="badge bg-secondary ms-1">{{ progress.quest.get_quest_type_display }}</span>
                {% endif %}
              </div>
              <p class="text-muted small mb-1 mt-1">{{ progress.quest.description }}</p>
              {% if progress.quest.objective_text %}
              <div class="objective-box mt-2">
                <i class="fas fa-map-pin text-primary me-1"></i>
                <strong>Objectif :</strong> {{ progress.quest.objective_text }}
              </div>
              {% endif %}
              {# Récompenses #}
              {% if progress.quest.reward_item or progress.quest.reward_money %}
              <div class="mt-2 d-flex align-items-center flex-wrap gap-2">
                <small class="text-muted">Récompenses :</small>
                {% if progress.quest.reward_money %}
                <span class="badge bg-light border text-dark">
                  <i class="fas fa-coins text-warning me-1"></i>{{ progress.quest.reward_money }}₽
                </span>
                {% endif %}
                {% if progress.quest.reward_item %}
                <span class="badge bg-light border text-dark">
                  <i class="fas fa-box text-info me-1"></i>{{ progress.quest.reward_item.name }}
                </span>
                {% endif %}
              </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="text-center text-muted py-5">
            <i class="fas fa-check-double fa-2x mb-3 text-success d-block"></i>
            <p class="mb-0">Aucune quête en cours.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  {# ── Sidebar : terminées + verrouillées ──────────────────────────────────── #}
  <div class="col-lg-4">

    {# Terminées #}
    <div class="card shadow mb-4">
      <div class="card-header py-2 d-flex align-items-center justify-content-between">
        <h6 class="m-0 fw-bold text-success">
          <i class="fas fa-check-circle me-1"></i>Terminées
        </h6>
        <span class="badge bg-success">{{ log.completed|length }}</span>
      </div>
      <div class="card-body p-0">
        {% for progress in log.completed %}
        <div class="d-flex align-items-center p-2 border-bottom quest-done">
          <i class="fas {{ progress.quest.icon }} text-success me-2 flex-shrink-0"></i>
          <div class="flex-grow-1">
            <strong class="small">{{ progress.quest.title }}</strong>
            {% if progress.completed_at %}
            <br><small class="text-muted">{{ progress.completed_at|date:"d/m/Y" }}</small>
            {% endif %}
          </div>
          <i class="fas fa-check text-success ms-2 flex-shrink-0"></i>
        </div>
        {% empty %}
        <p class="text-muted small text-center py-3 mb-0">Aucune quête terminée.</p>
        {% endfor %}
      </div>
    </div>

    {# Verrouillées #}
    {% if log.locked %}
    <div class="card shadow">
      <div class="card-header py-2">
        <h6 class="m-0 fw-bold text-secondary">
          <i class="fas fa-lock me-1"></i>À venir
        </h6>
      </div>
      <div class="card-body p-0">
        {% for progress in log.locked %}
        <div class="d-flex align-items-center p-2 border-bottom quest-locked">
          <i class="fas {{ progress.quest.icon }} text-secondary me-2 flex-shrink-0"></i>
          <small class="text-muted">{{ progress.quest.title }}</small>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>
</div>

{% endblock %}