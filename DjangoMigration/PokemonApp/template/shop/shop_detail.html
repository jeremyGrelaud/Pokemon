{% extends "base.html" %}
{% load static %} {% load custom_filters %}

{% block title %}
<title>{{ shop.name }} - Boutique</title>
{% endblock title %}

{% block content %}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'home' %}">Dashboard</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ShopListView' %}">Boutiques</a></li>
    <li class="breadcrumb-item active">{{ shop.name }}</li>
  </ol>
</nav>

<!-- Navigation -->
<div class="mb-3 d-flex gap-2 flex-wrap">
  <a href="{% url 'ShopListView' %}" class="btn btn-secondary btn-sm">
    <i class="fas fa-arrow-left me-1"></i>Retour aux boutiques
  </a>
  {% if current_zone %}
  <a href="{% url 'zone_detail' current_zone.id %}" class="btn btn-primary btn-sm">
    <i class="fas fa-map-marker-alt me-1"></i>Retour à {{ current_zone.name }}
  </a>
  {% endif %}
</div>

<!-- Header boutique -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-lg border-0 shop-header-card">
      <div class="card-body text-white py-4">
        <div class="row align-items-center">
          <div class="col-md-8 d-flex align-items-center gap-3">
            <img src="{% static 'img/mapSprites/Kanto/pokeMart.png' %}"
                 alt="{{ shop.name }}"
                 style="width:80px; height:80px; object-fit:contain; flex-shrink:0;">
            <div>
              <h2 class="mb-1 fw-bold">{{ shop.name }}</h2>
              <p class="mb-1 text-white-50">
                <i class="fas fa-map-marker-alt me-1"></i>{{ shop.location }}
              </p>
              <span class="badge bg-light text-dark">{{ shop.get_shop_type_display }}</span>
            </div>
          </div>
          <div class="col-md-4 text-center mt-3 mt-md-0">
            <div class="p-3 bg-white bg-opacity-15 rounded">
              <h3 class="mb-1 fw-bold money-display">
                <i class="fas fa-coins text-warning me-1"></i>{{ trainer.money }}₽
              </h3>
              <small class="text-white-50">Votre argent</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Message du vendeur -->
{% if shop.shopkeeper_greeting %}
<div class="alert alert-info d-flex align-items-center mb-4"
     style="border-left: 4px solid #0dcaf0;">
  <i class="fas fa-user-tie fa-2x me-3 text-info flex-shrink-0"></i>
  <div>
    <strong>Vendeur :</strong>
    <p class="mb-0 mt-1">"{{ shop.shopkeeper_greeting }}"</p>
  </div>
</div>
{% endif %}

<!-- Onglets -->
<ul class="nav nav-tabs nav-fill mb-4" id="shopTabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="buy-tab" data-bs-toggle="tab" href="#buy" role="tab">
      <i class="fas fa-shopping-cart me-1"></i>Acheter
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="sell-tab" data-bs-toggle="tab" href="#sell" role="tab">
      <i class="fas fa-hand-holding-usd me-1"></i>Vendre
    </a>
  </li>
</ul>

<div class="tab-content" id="shopTabsContent">

  <!-- ═══ ONGLET ACHETER ═══════════════════════════════════════════════════ -->
  <div class="tab-pane fade show active" id="buy" role="tabpanel">

    {% if featured_items %}
    <div class="mb-4">
      <h5 class="mb-3 fw-bold">
        <i class="fas fa-star text-warning me-2"></i>Articles Vedettes
      </h5>
      <div class="row">
        {% for inventory_item in featured_items %}
        {% include 'shop/item_card.html' with inventory_item=inventory_item mode='buy' %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% if new_items %}
    <div class="mb-4">
      <h5 class="mb-3 fw-bold">
        <i class="fas fa-sparkles text-info me-2"></i>Nouveautés
      </h5>
      <div class="row">
        {% for inventory_item in new_items %}
        {% include 'shop/item_card.html' with inventory_item=inventory_item mode='buy' %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% if regular_items %}
    <div class="mb-4">
      <h5 class="mb-3 fw-bold">
        <i class="fas fa-boxes me-2"></i>Tous les Articles
      </h5>
      <div class="row">
        {% for inventory_item in regular_items %}
        {% include 'shop/item_card.html' with inventory_item=inventory_item mode='buy' %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% if not featured_items and not new_items and not regular_items %}
    <div class="text-center py-5">
      <i class="fas fa-box-open fa-4x text-muted mb-3 d-block"></i>
      <h4 class="text-muted">Aucun article disponible</h4>
      <p class="text-muted mb-0">Revenez plus tard ou obtenez plus de badges !</p>
    </div>
    {% endif %}
  </div>

  <!-- ═══ ONGLET VENDRE ════════════════════════════════════════════════════ -->
  <div class="tab-pane fade" id="sell" role="tabpanel">
    {% if can_sell %}
    <div class="alert alert-warning mb-4">
      <i class="fas fa-info-circle me-2"></i>
      <strong>Info :</strong> Vous pouvez vendre vos objets à 50% de leur prix d'achat.
    </div>

    <div class="row">
      {% for trainer_inv in player_inventory %}
      <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
        <div class="card item-sell-card h-100 shadow-sm">
          <div class="card-body">

            <!-- Sprite -->
            <div class="text-center mb-2">
              {% with sprite=trainer_inv.item|item_sprite_path %}
                {% if sprite %}
                  <img src="{% static 'img/items_sprites/' %}{{ sprite }}"
                       alt="{{ trainer_inv.item.name }}"
                       style="width:64px; height:64px; object-fit:contain;"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                  <span style="display:none;">
                    {% if trainer_inv.item.item_type == 'potion' %}<i class="fas fa-flask fa-3x text-danger"></i>
                    {% elif trainer_inv.item.item_type == 'pokeball' %}<i class="fas fa-circle fa-3x text-primary"></i>
                    {% elif trainer_inv.item.item_type == 'evolution' %}<i class="fas fa-gem fa-3x text-success"></i>
                    {% elif trainer_inv.item.item_type == 'status' %}<i class="fas fa-plus-circle fa-3x text-info"></i>
                    {% else %}<i class="fas fa-box fa-3x text-secondary"></i>{% endif %}
                  </span>
                {% else %}
                  {% if trainer_inv.item.item_type == 'potion' %}<i class="fas fa-flask fa-3x text-danger"></i>
                  {% elif trainer_inv.item.item_type == 'pokeball' %}<i class="fas fa-circle fa-3x text-primary"></i>
                  {% elif trainer_inv.item.item_type == 'evolution' %}<i class="fas fa-gem fa-3x text-success"></i>
                  {% elif trainer_inv.item.item_type == 'status' %}<i class="fas fa-plus-circle fa-3x text-info"></i>
                  {% else %}<i class="fas fa-box fa-3x text-secondary"></i>{% endif %}
                {% endif %}
              {% endwith %}
            </div>

            <h6 class="text-center fw-bold mb-2">{{ trainer_inv.item.name }}</h6>

            <div class="text-center mb-2">
              <span class="badge bg-secondary">{{ trainer_inv.item.get_item_type_display }}</span>
              <span class="badge bg-info text-dark">x{{ trainer_inv.quantity }}</span>
            </div>

            <p class="small text-muted text-center mb-3">
              {{ trainer_inv.item.description|truncatewords:10 }}
            </p>

            <!-- Prix de vente -->
            <div class="text-center mb-3">
              <h5 class="text-success mb-0">
                <i class="fas fa-coins me-1"></i>{{ trainer_inv.item.price|floatformat:0|mul:0.5|floatformat:0 }}₽
              </h5>
              <small class="text-muted">Prix de vente unitaire</small>
            </div>

            <!-- Quantité — BS5 : form-group → mb-3 -->
            <div class="mb-3">
              <label class="form-label small fw-semibold">Quantité :</label>
              <input type="number"
                     class="form-control form-control-sm sell-quantity"
                     min="1"
                     max="{{ trainer_inv.quantity }}"
                     value="1"
                     data-inventory-id="{{ trainer_inv.id }}">
            </div>

            <!-- Bouton vendre — BS5 : btn-block → d-grid -->
            <div class="d-grid">
              <button class="btn btn-success btn-sm btn-sell"
                      data-inventory-id="{{ trainer_inv.id }}"
                      data-item-name="{{ trainer_inv.item.name }}"
                      data-unit-price="{{ trainer_inv.item.price|floatformat:0|mul:0.5|floatformat:0 }}">
                <i class="fas fa-hand-holding-usd me-1"></i>Vendre
              </button>
            </div>

          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    {% else %}
    <div class="text-center py-5">
      <i class="fas fa-shopping-bag fa-4x text-muted mb-3 d-block"></i>
      <h4 class="text-muted">Inventaire vide</h4>
      <p class="text-muted mb-0">Vous n'avez aucun objet à vendre pour le moment.</p>
    </div>
    {% endif %}
  </div>

</div>

<!-- Bouton retour -->
<div class="mt-4 mb-4">
  <a href="{% url 'ShopListView' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-1"></i>Retour aux Boutiques
  </a>
</div>

<!-- Toast Container -->
<div id="toast-container" style="position:fixed; top:20px; right:20px; z-index:9999;"></div>

{% endblock content %}

{% block css %}
{{ block.super }}
<style>
/* ── Header boutique ─────────────────────────────────────────────────────── */
.shop-header-card {
  background: linear-gradient(135deg, #4a5568 0%, #553c9a 60%, #6b46c1 100%);
}

/* ── Cards articles (vente) ──────────────────────────────────────────────── */
.item-sell-card {
  border-left: 4px solid transparent;
  transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
}
.item-sell-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(0,0,0,.12) !important;
  border-left-color: #6b46c1;
}

/* ── Onglets ─────────────────────────────────────────────────────────────── */
.nav-tabs .nav-link {
  font-weight: 500;
  color: #553c9a;
}
.nav-tabs .nav-link.active {
  background-color: #553c9a;
  color: white;
  border-color: #553c9a;
}

/* ── Affichage argent ────────────────────────────────────────────────────── */
.money-display { font-size: 1.3rem; }
</style>
{% endblock %}

{% block js %}
{{ block.super }}
<script>
function getCookie(name) {
  let val = null;
  if (document.cookie && document.cookie !== '') {
    document.cookie.split(';').forEach(c => {
      const t = c.trim();
      if (t.startsWith(name + '=')) val = decodeURIComponent(t.slice(name.length + 1));
    });
  }
  return val;
}
const csrftoken = getCookie('csrftoken');

/* ── Achat ────────────────────────────────────────────────────────────────── */
function buyItem(shopInventoryId, itemName, unitPrice) {
  const quantityInput = document.querySelector(`.buy-quantity[data-shop-inventory-id="${shopInventoryId}"]`);
  const quantity = parseInt(quantityInput?.value) || 1;
  const totalCost = unitPrice * quantity;
  if (!confirm(`Acheter ${quantity}× ${itemName} pour ${totalCost}₽ ?`)) return;

  const btn = document.querySelector(`.btn-buy[data-shop-inventory-id="${shopInventoryId}"]`);
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Achat…';

  fetch('/api/shop/buy/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
    body: JSON.stringify({ shop_inventory_id: shopInventoryId, quantity })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      showToast(data.message, 'success');
      const newMoney = data.new_balance.toLocaleString('fr-FR') + '₽';
      document.querySelectorAll('.money-display').forEach(el => {
        el.innerHTML = `<i class="fas fa-coins text-warning me-1"></i>${newMoney}`;
      });
      if (quantityInput) quantityInput.value = 1;
      const totalEl = document.querySelector(`.total-price[data-shop-inventory-id="${shopInventoryId}"]`);
      if (totalEl) totalEl.textContent = unitPrice + '₽';
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-shopping-cart me-1"></i>Acheter';
    } else {
      showToast(data.error, 'error');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-shopping-cart me-1"></i>Acheter';
    }
  })
  .catch(() => {
    showToast("Erreur lors de l'achat", 'error');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-shopping-cart me-1"></i>Acheter';
  });
}

/* ── Vente ────────────────────────────────────────────────────────────────── */
document.addEventListener('click', e => {
  const btn = e.target.closest('.btn-sell');
  if (!btn) return;

  const id = btn.dataset.inventoryId;
  const itemName  = btn.dataset.itemName;
  const unitPrice = parseInt(btn.dataset.unitPrice);
  const qtyInput  = document.querySelector(`.sell-quantity[data-inventory-id="${id}"]`);
  const quantity  = parseInt(qtyInput?.value) || 1;
  const totalEarned = unitPrice * quantity;

  if (!confirm(`Vendre ${quantity}× ${itemName} pour ${totalEarned}₽ ?`)) return;

  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Vente…';

  fetch('/api/shop/sell/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
    body: JSON.stringify({ trainer_inventory_id: id, quantity })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      showToast(data.message, 'success');
      const newMoney = data.new_balance.toLocaleString('fr-FR') + '₽';
      document.querySelectorAll('.money-display').forEach(el => {
        el.innerHTML = `<i class="fas fa-coins text-warning me-1"></i>${newMoney}`;
      });
      const card = btn.closest('.col-lg-3, .col-md-4, .col-sm-6');
      const qtyBadge = card?.querySelector('.bg-info');
      const newQty = (parseInt(qtyBadge?.textContent?.replace('x','')) || 0) - quantity;
      if (newQty <= 0) {
        card?.style && (card.style.transition = 'opacity .3s');
        card?.style && (card.style.opacity = '0');
        setTimeout(() => card?.remove(), 300);
      } else {
        if (qtyBadge) qtyBadge.textContent = 'x' + newQty;
        if (qtyInput) { qtyInput.max = newQty; qtyInput.value = 1; }
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-hand-holding-usd me-1"></i>Vendre';
      }
    } else {
      showToast(data.error, 'error');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-hand-holding-usd me-1"></i>Vendre';
    }
  })
  .catch(() => {
    showToast('Erreur lors de la vente', 'error');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-hand-holding-usd me-1"></i>Vendre';
  });
});

/* ── Mise à jour prix total (achat) ───────────────────────────────────────── */
document.addEventListener('input', e => {
  const input = e.target.closest('.buy-quantity');
  if (!input) return;
  const id    = input.dataset.shopInventoryId;
  const price = parseInt(input.dataset.unitPrice);
  const qty   = parseInt(input.value) || 1;
  const el    = document.querySelector(`.total-price[data-shop-inventory-id="${id}"]`);
  if (el) el.textContent = (price * qty) + '₽';
});
</script>
{% endblock %}