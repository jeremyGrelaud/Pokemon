{% extends "base.html" %}
{% load static %} {% load custom_filters %}

{% block title %}
<title>{{ shop.name }} - Boutique</title>
{% endblock title %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'home' %}">Dashboard</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ShopListView' %}">Boutiques</a></li>
    <li class="breadcrumb-item active">{{ shop.name }}</li>
  </ol>
</nav>

<!-- Shop Header -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-lg border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      <div class="card-body text-white">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h1 class="display-4 mb-2">
              <img src="{% static 'img/mapSprites/Kanto/pokeMart.png' %}" 
               alt="{{ battle.player_pokemon.species.name }}"
               style="width: 120px; height: 120px;">
               {{ shop.name }}
            </h1>
            <p class="lead mb-2">{{ shop.location }}</p>
            <p class="mb-0">
              <span class="badge badge-light text-dark p-2">
                {{ shop.get_shop_type_display }}
              </span>
            </p>
          </div>
          <div class="col-md-4 text-center">
            <div class="p-3 bg-white bg-opacity-25 rounded text-dark">
              <h2 class="mb-2">
                <i class="fas fa-coins text-warning"></i> {{ trainer.money }}₽
              </h2>
              <p class="mb-0 small">Votre argent</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Shopkeeper Greeting -->
{% if shop.shopkeeper_greeting %}
<div class="row mb-4">
  <div class="col-12">
    <div class="alert alert-info border-left-info">
      <div class="d-flex align-items-center">
        <i class="fas fa-user-tie fa-3x mr-3"></i>
        <div>
          <strong>Vendeur :</strong>
          <p class="mb-0 mt-1">"{{ shop.shopkeeper_greeting }}"</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Tabs Navigation -->
<ul class="nav nav-tabs nav-fill mb-4" id="shopTabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="buy-tab" data-toggle="tab" href="#buy" role="tab">
      <i class="fas fa-shopping-cart"></i> Acheter
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="sell-tab" data-toggle="tab" href="#sell" role="tab">
      <i class="fas fa-hand-holding-usd"></i> Vendre
    </a>
  </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="shopTabsContent">
  
  <!-- BUY TAB -->
  <div class="tab-pane fade show active" id="buy" role="tabpanel">
    
    <!-- Featured Items -->
    {% if featured_items %}
    <div class="mb-4">
      <h4 class="mb-3">
        <i class="fas fa-star text-warning"></i> Articles Vedettes
      </h4>
      <div class="row">
        {% for inventory_item in featured_items %}
        {% include 'shop/item_card.html' with inventory_item=inventory_item mode='buy' %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- New Items -->
    {% if new_items %}
    <div class="mb-4">
      <h4 class="mb-3">
        <i class="fas fa-sparkles text-info"></i> Nouveautés
      </h4>
      <div class="row">
        {% for inventory_item in new_items %}
        {% include 'shop/item_card.html' with inventory_item=inventory_item mode='buy' %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Regular Items -->
    {% if regular_items %}
    <div class="mb-4">
      <h4 class="mb-3">
        <i class="fas fa-boxes"></i> Tous les Articles
      </h4>
      <div class="row">
        {% for inventory_item in regular_items %}
        {% include 'shop/item_card.html' with inventory_item=inventory_item mode='buy' %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% if not featured_items and not new_items and not regular_items %}
    <div class="text-center py-5">
      <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
      <h4 class="text-muted">Aucun article disponible</h4>
      <p class="text-muted">Revenez plus tard ou obtenez plus de badges !</p>
    </div>
    {% endif %}
  </div>

  <!-- SELL TAB -->
  <div class="tab-pane fade" id="sell" role="tabpanel">
    {% if can_sell %}
    <div class="alert alert-warning mb-4">
      <i class="fas fa-info-circle"></i>
      <strong>Info :</strong> Vous pouvez vendre vos objets à 50% de leur prix d'achat.
    </div>

    <div class="row">
      {% for trainer_inv in player_inventory %}
      <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
        <div class="card item-card h-100 shadow-sm">
          <div class="card-body">
            <div class="text-center mb-2">
              {% with sprite=trainer_inv.item|item_sprite_path %}
                {% if sprite %}
                  <img src="{% static 'img/items_sprites/' %}{{ sprite }}"
                      alt="{{ trainer_inv.item.name }}"
                      style="width: 64px; height: 64px; object-fit: contain; "
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                  <!-- Fallback FontAwesome si image introuvable -->
                  <span style="display:none;">
                    {% if trainer_inv.item.item_type == 'potion' %}<i class="fas fa-flask fa-4x text-danger"></i>
                    {% elif trainer_inv.item.item_type == 'pokeball' %}<i class="fas fa-circle fa-4x text-primary"></i>
                    {% elif trainer_inv.item.item_type == 'evolution' %}<i class="fas fa-gem fa-4x text-success"></i>
                    {% elif trainer_inv.item.item_type == 'status' %}<i class="fas fa-plus-circle fa-4x text-info"></i>
                    {% else %}<i class="fas fa-box fa-4x text-secondary"></i>{% endif %}
                  </span>
                {% else %}
                  {% if trainer_inv.item.item_type == 'potion' %}<i class="fas fa-flask fa-4x text-danger"></i>
                  {% elif trainer_inv.item.item_type == 'pokeball' %}<i class="fas fa-circle fa-4x text-primary"></i>
                  {% elif trainer_inv.item.item_type == 'evolution' %}<i class="fas fa-gem fa-4x text-success"></i>
                  {% elif trainer_inv.item.item_type == 'status' %}<i class="fas fa-plus-circle fa-4x text-info"></i>
                  {% else %}<i class="fas fa-box fa-4x text-secondary"></i>{% endif %}
                {% endif %}
              {% endwith %}
            </div>
            <h6 class="text-center mb-2">{{ trainer_inv.item.name }}</h6>
            
            <div class="text-center mb-2">
              <span class="badge badge-secondary">{{ trainer_inv.item.get_item_type_display }}</span>
              <span class="badge badge-info">x{{ trainer_inv.quantity }}</span>
            </div>

            <p class="small text-muted text-center mb-3">
              {{ trainer_inv.item.description|truncatewords:10 }}
            </p>

            <!-- Sell Price -->
            <div class="text-center mb-3">
              <h5 class="text-success mb-0">
                <i class="fas fa-coins"></i> {{ trainer_inv.item.price|floatformat:0|mul:0.5|floatformat:0 }}₽
              </h5>
              <small class="text-muted">Prix de vente unitaire</small>
            </div>

            <!-- Quantity Selector -->
            <div class="form-group mb-3">
              <label class="small">Quantité :</label>
              <input type="number" 
                     class="form-control form-control-sm sell-quantity" 
                     min="1" 
                     max="{{ trainer_inv.quantity }}" 
                     value="1"
                     data-inventory-id="{{ trainer_inv.id }}">
            </div>

            <!-- Sell Button -->
            <button class="btn btn-success btn-block btn-sm btn-sell" 
                    data-inventory-id="{{ trainer_inv.id }}"
                    data-item-name="{{ trainer_inv.item.name }}"
                    data-unit-price="{{ trainer_inv.item.price|floatformat:0|mul:0.5|floatformat:0 }}">
              <i class="fas fa-hand-holding-usd"></i> Vendre
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
      <i class="fas fa-shopping-bag fa-4x text-muted mb-3"></i>
      <h4 class="text-muted">Inventaire vide</h4>
      <p class="text-muted">Vous n'avez aucun objet à vendre pour le moment.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Back Button -->
<div class="mt-4 mb-4">
  <a href="{% url 'ShopListView' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Retour aux Boutiques
  </a>
</div>

<!-- Toast Container -->
<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

{% endblock content %}

{% block js %}
{{ block.super }}

<!-- CSRF Token -->
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Buy Item Function
function buyItem(shopInventoryId, itemName, unitPrice) {
  const quantityInput = $(`.buy-quantity[data-shop-inventory-id="${shopInventoryId}"]`);
  const quantity = parseInt(quantityInput.val()) || 1;
  const totalCost = unitPrice * quantity;
  
  // Confirmation
  if (!confirm(`Acheter ${quantity}x ${itemName} pour ${totalCost}₽ ?`)) {
    return;
  }
  
  // Disable button during request
  const btn = $(`.btn-buy[data-shop-inventory-id="${shopInventoryId}"]`);
  btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Achat...');
  
  fetch('/api/shop/buy/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify({
      shop_inventory_id: shopInventoryId,
      quantity: quantity
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast(data.message, 'success');
      
      // Update money display
      $('.money-display').text(data.new_balance + '₽');
      
      // Reset quantity
      quantityInput.val(1);
      
      // Reload page after 1 second
      setTimeout(() => location.reload(), 1500);
    } else {
      showToast(data.error, 'error');
      btn.prop('disabled', false).html('<i class="fas fa-shopping-cart"></i> Acheter');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Erreur lors de l\'achat', 'error');
    btn.prop('disabled', false).html('<i class="fas fa-shopping-cart"></i> Acheter');
  });
}

// Sell Item Function
$(document).on('click', '.btn-sell', function() {
  const trainerInventoryId = $(this).data('inventory-id');
  const itemName = $(this).data('item-name');
  const unitPrice = parseInt($(this).data('unit-price'));
  const quantityInput = $(`.sell-quantity[data-inventory-id="${trainerInventoryId}"]`);
  const quantity = parseInt(quantityInput.val()) || 1;
  const totalEarned = unitPrice * quantity;
  
  // Confirmation
  if (!confirm(`Vendre ${quantity}x ${itemName} pour ${totalEarned}₽ ?`)) {
    return;
  }
  
  // Disable button
  const btn = $(this);
  btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Vente...');
  
  fetch('/api/shop/sell/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify({
      trainer_inventory_id: trainerInventoryId,
      quantity: quantity
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast(data.message, 'success');
      
      // Update money display
      $('.money-display').text(data.new_balance + '₽');
      
      // Reload page
      setTimeout(() => location.reload(), 1500);
    } else {
      showToast(data.error, 'error');
      btn.prop('disabled', false).html('<i class="fas fa-hand-holding-usd"></i> Vendre');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Erreur lors de la vente', 'error');
    btn.prop('disabled', false).html('<i class="fas fa-hand-holding-usd"></i> Vendre');
  });
});

// Update total price when quantity changes
$(document).on('input', '.buy-quantity', function() {
  const shopInventoryId = $(this).data('shop-inventory-id');
  const unitPrice = parseInt($(this).data('unit-price'));
  const quantity = parseInt($(this).val()) || 1;
  const total = unitPrice * quantity;
  
  $(`.total-price[data-shop-inventory-id="${shopInventoryId}"]`).text(total + '₽');
});

// Animation
$(document).ready(function() {
  $('.item-card').each(function(index) {
    $(this).css('opacity', 0);
    $(this).delay(index * 50).animate({opacity: 1}, 300);
  });
});
</script>

<style>
.item-card {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border-left: 4px solid transparent;
}

.item-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 5px 20px rgba(0,0,0,0.15) !important;
  border-left-color: #667eea;
}

.badge-discount {
  position: absolute;
  top: 10px;
  right: 10px;
  background: #dc3545;
  color: white;
  padding: 5px 10px;
  border-radius: 20px;
  font-weight: bold;
}

.badge-locked {
  background: #6c757d;
  color: white;
}

.money-display {
  font-size: 1.2rem;
  font-weight: bold;
}

.toast {
  min-width: 250px;
  margin-bottom: 10px;
}

.nav-tabs .nav-link {
  font-weight: 500;
  color: #667eea;
}

.nav-tabs .nav-link.active {
  background-color: #667eea;
  color: white;
  border-color: #667eea;
}

.border-left-info {
  border-left: 4px solid #17a2b8;
}
</style>
{% endblock js %}