{% extends "base.html" %}
{% load static %} {% load custom_filters %}

{% block title %}
<title>Mon √âquipe - Pok√©mon Gen 1</title>
{% endblock title %}

{% block content %}
<!-- Header -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0 text-gray-800">
    <i class="fas fa-users text-success"></i> Mon √âquipe
  </h1>
  <div class="d-flex align-items-center gap-2">
    <span class="badge bg-primary p-2">
      <i class="fas fa-medal"></i> {{ trainer.badges }} badge{% if trainer.badges != 1 %}s{% endif %}
    </span>
    <span class="badge bg-warning p-2">
      <i class="fas fa-coins"></i> {{ trainer.money }}‚ÇΩ
    </span>
  </div>
</div>

<!-- Notification inline -->
<div id="team-alert" class="alert d-none mb-3" role="alert"></div>

<!-- ‚ïê‚ïê‚ïê √âQUIPE ACTIVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex align-items-center justify-content-between">
    <h6 class="m-0 fw-bold text-primary">
      <i class="fas fa-star"></i> √âquipe Active
      <span class="badge bg-light ms-1" id="team-count">{{ team|length }}/6</span>
    </h6>
    <small class="text-muted">
      <i class="fas fa-grip-vertical"></i> Glisser-d√©poser pour r√©ordonner
    </small>
  </div>
  <div class="card-body">
    {% if team %}
    <div id="team-sortable" class="row">
      {% for pokemon in team %}
      <div class="col-md-6 col-lg-4 mb-3 team-slot" data-id="{{ pokemon.id }}">
        <div class="card pokemon-card h-100 border-success">
          <!-- Drag handle -->
          <div class="drag-handle card-header py-1 px-2 d-flex align-items-center justify-content-between bg-light">
            <i class="fas fa-grip-horizontal text-muted"></i>
            <small class="text-muted position-badge">#{{ forloop.counter }}</small>
          </div>

          <div class="card-body pt-2 pb-1">
            <div class="d-flex align-items-center mb-2">
              <img src="{% static 'img/sprites_gen5/' %}{% if pokemon.is_shiny %}shiny{% else %}normal{% endif %}/{{ pokemon.species.name|lowerPokemonFileNames }}.png"
                   alt="{{ pokemon.species.name }}"
                   class="pokemon-sprite-sm me-3"
                   onerror="this.src='{% static 'img/pokeball.png' %}'">
              <div class="flex-grow-1 min-w-0">
                <h6 class="mb-0 text-truncate">
                  {% if pokemon.nickname %}
                    <strong>{{ pokemon.nickname }}</strong>
                    <small class="text-muted">({{ pokemon.species.name }})</small>
                  {% else %}
                    <strong>{{ pokemon.species.name }}</strong>
                  {% endif %}
                </h6>
                <span class="badge bg-secondary">Niv. {{ pokemon.level }}</span>
                <span class="badge badge-type-{{ pokemon.species.primary_type.name|lower }}">{{ pokemon.species.primary_type.name }}</span>
                {% if pokemon.species.secondary_type %}
                <span class="badge badge-type-{{ pokemon.species.secondary_type.name|lower }}">{{ pokemon.species.secondary_type.name }}</span>
                {% endif %}
              </div>
            </div>

            <!-- HP bar -->
            <div class="mb-2">
              <div class="d-flex justify-content-between" style="font-size:.75rem;">
                <span>HP</span>
                <strong>{{ pokemon.current_hp }}/{{ pokemon.max_hp }}</strong>
              </div>
              <div class="hp-bar">
                {% widthratio pokemon.current_hp pokemon.max_hp 100 as hp_pct %}
                {% with hp_int=hp_pct|default:0|add:0 %}
                <div class="hp-bar-fill {% if hp_int > 50 %}hp-high{% elif hp_int > 20 %}hp-medium{% else %}hp-low{% endif %}"
                     style="width:{{ hp_pct }}%"></div>
                {% endwith %}
              </div>
            </div>

            <!-- Mini stats -->
            <div class="row text-center small text-muted mb-1">
              <div class="col-4">{{ pokemon.attack }}<br><span style="font-size:.65rem">ATK</span></div>
              <div class="col-4">{{ pokemon.defense }}<br><span style="font-size:.65rem">DEF</span></div>
              <div class="col-4">{{ pokemon.speed }}<br><span style="font-size:.65rem">SPD</span></div>
            </div>

            <!-- Statut -->
            {% if pokemon.status_condition %}
            <div class="text-center mb-1">
              <span class="badge bg-danger">{{ pokemon.get_status_condition_display }}</span>
            </div>
            {% endif %}

            <!-- Moves actifs -->
            <div class="mb-2">
              <div class="moves-mini-grid">
                {% for mi in pokemon.pokemonmoveinstance_set.all %}
                <div class="move-mini-chip badge-type-{{ mi.move.type.name|lower }}">
                  <span class="move-mini-name">{{ mi.move.name }}</span>
                  <span class="move-mini-pp {% if mi.current_pp == 0 %}pp-empty{% elif mi.current_pp <= mi.move.pp|divisibleby:3 %}pp-low{% endif %}">{{ mi.current_pp }}/{{ mi.move.pp }}</span>
                </div>
                {% empty %}
                <span class="text-muted small">Aucune capacit√©</span>
                {% endfor %}
              </div>
            </div>

            <!-- XP bar -->
            <div>
              <div class="d-flex justify-content-between" style="font-size:.7rem;color:#6c757d;">
                <span>EXP</span>
                <span>{{ pokemon.exp_current_level }} / {{ pokemon.exp_to_next_level }}</span>
              </div>
              <div class="progress" style="height:5px;">
                {% widthratio pokemon.current_exp pokemon.exp_for_next_level 100 as exp_pct %}
                <div class="progress-bar bg-info" style="width:{{ pokemon.exp_percent  }}%"></div>
              </div>
            </div>
          </div>

          <div class="card-footer py-2">
            <div class="btn-group btn-group-sm w-100 mb-1">
              <a href="{% url 'PokemonDetailView' pokemon.species.id %}"
                 class="btn btn-outline-primary">
                <i class="fas fa-info-circle"></i> D√©tails
              </a>
              <button class="btn btn-outline-secondary manage-moves-btn"
                      data-id="{{ pokemon.id }}"
                      data-name="{{ pokemon.nickname|default:pokemon.species.name }}">
                <i class="fas fa-bolt"></i> Capacit√©s
              </button>
              <button class="btn btn-outline-info stats-btn"
                      data-id="{{ pokemon.id }}"
                      data-name="{{ pokemon.nickname|default:pokemon.species.name }}"
                      data-level="{{ pokemon.level }}"
                      data-nature="{{ pokemon.nature }}"
                      data-iv-hp="{{ pokemon.iv_hp }}"
                      data-iv-atk="{{ pokemon.iv_attack }}"
                      data-iv-def="{{ pokemon.iv_defense }}"
                      data-iv-spa="{{ pokemon.iv_special_attack }}"
                      data-iv-spd="{{ pokemon.iv_special_defense }}"
                      data-iv-spe="{{ pokemon.iv_speed }}"
                      data-ev-hp="{{ pokemon.ev_hp }}"
                      data-ev-atk="{{ pokemon.ev_attack }}"
                      data-ev-def="{{ pokemon.ev_defense }}"
                      data-ev-spa="{{ pokemon.ev_special_attack }}"
                      data-ev-spd="{{ pokemon.ev_special_defense }}"
                      data-ev-spe="{{ pokemon.ev_speed }}"
                      data-stat-hp="{{ pokemon.max_hp }}"
                      data-stat-atk="{{ pokemon.attack }}"
                      data-stat-def="{{ pokemon.defense }}"
                      data-stat-spa="{{ pokemon.special_attack }}"
                      data-stat-spd="{{ pokemon.special_defense }}"
                      data-stat-spe="{{ pokemon.speed }}"
                      data-base-hp="{{ pokemon.species.base_hp }}"
                      data-base-atk="{{ pokemon.species.base_attack }}"
                      data-base-def="{{ pokemon.species.base_defense }}"
                      data-base-spa="{{ pokemon.species.base_special_attack }}"
                      data-base-spd="{{ pokemon.species.base_special_defense }}"
                      data-base-spe="{{ pokemon.species.base_speed }}"
                      data-shiny="{{ pokemon.is_shiny|yesno:'1,0' }}"
                      data-species="{{ pokemon.species.name|lowerPokemonFileNames }}">
                <i class="fas fa-chart-bar"></i> Stats
              </button>
            </div>
            <button class="btn btn-outline-warning btn-sm w-100 send-to-pc-btn"
                    data-id="{{ pokemon.id }}"
                    data-name="{{ pokemon.nickname|default:pokemon.species.name }}"
                    {% if team|length <= 1 %}disabled title="Dernier Pok√©mon de l'√©quipe"{% endif %}>
              <i class="fas fa-database"></i> Envoyer au PC
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5 text-muted">
      <i class="fas fa-users fa-3x mb-3 d-block"></i>
      Aucun Pok√©mon dans l'√©quipe. Ajoutez-en depuis le PC ci-dessous.
    </div>
    {% endif %}
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PC STORAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex align-items-center justify-content-between">
    <h6 class="m-0 fw-bold text-info">
      <i class="fas fa-database"></i> PC ‚Äî R√©serve
      <span class="badge bg-light ms-1" id="pc-count">{{ pc_pokemon|length }}</span>
    </h6>
    {% if pc_pokemon %}
    <small class="text-muted">Cliquez sur un Pok√©mon pour l'ajouter √† l'√©quipe</small>
    {% endif %}
  </div>
  <div class="card-body">
    {% if pc_pokemon %}
    <div id="pc-grid" class="row">
      {% for pokemon in pc_pokemon %}
      <div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-3 pc-slot" id="pc-slot-{{ pokemon.id }}">
        <div class="card pc-card text-center h-100 {% if team|length >= 6 %}pc-card-disabled{% endif %}"
             data-id="{{ pokemon.id }}"
             data-name="{{ pokemon.nickname|default:pokemon.species.name }}">
          <div class="card-body p-2">
            <img src="{% static 'img/sprites_gen5/' %}{% if pokemon.is_shiny %}shiny{% else %}normal{% endif %}/{{ pokemon.species.name|lowerPokemonFileNames }}.png"
                 alt="{{ pokemon.species.name }}"
                 class="pokemon-sprite-pc"
                 onerror="this.src='{% static 'img/pokeball.png' %}'">
            <div class="mt-1 text-truncate" style="font-size:.8rem;font-weight:600;">
              {{ pokemon.nickname|default:pokemon.species.name }}
            </div>
            <small class="text-muted d-block">Niv. {{ pokemon.level }}</small>
            {% if pokemon.status_condition %}
            <span class="badge bg-danger" style="font-size:.6rem;">{{ pokemon.status_condition }}</span>
            {% endif %}
          </div>
          <div class="card-footer p-1" style="font-size:.7rem;">
            <i class="fas fa-plus-circle text-success"></i> √âquipe
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-4 text-muted">
      <i class="fas fa-database fa-2x mb-2 d-block"></i>
      Le PC est vide.
    </div>
    {% endif %}
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê INVENTAIRE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 fw-bold text-primary">
      <i class="fas fa-shopping-bag"></i> Inventaire
    </h6>
  </div>
  <div class="card-body">
    {% if inventory %}
    <div class="table-responsive">
      <table class="table table-sm table-hover">
        <thead><tr><th>Objet</th><th>Type</th><th>Qt√©</th><th>Description</th></tr></thead>
        <tbody>
          {% for inv_item in inventory %}
          <tr>
            <td>
              {% with path=inv_item.item|item_sprite_path %}
              {% if path %}
              <img src="{% static 'img/items_sprites/' %}{{ path }}"
                   alt="{{ inv_item.item.name }}"
                   style="width:20px;height:20px;object-fit:contain;margin-right:4px;"
                   onerror="this.style.display='none'">
              {% endif %}
              {% endwith %}
              <strong>{{ inv_item.item.name }}</strong>
            </td>
            <td><span class="badge bg-secondary">{{ inv_item.item.get_item_type_display }}</span></td>
            <td><span class="badge bg-primary">x{{ inv_item.quantity }}</span></td>
            <td><small class="text-muted">{{ inv_item.item.description|truncatewords:10 }}</small></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-center text-muted mb-0">Votre inventaire est vide.</p>
    {% endif %}
  </div>
</div>

<a href="{% url 'home' %}" class="btn btn-secondary mb-4">
  <i class="fas fa-arrow-left"></i> Retour au Dashboard
</a>

<!-- ‚ïê‚ïê‚ïê MODAL GESTION DES CAPACIT√âS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal fade" id="moves-modal" tabindex="-1" role="dialog" data-backdrop="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header" style="background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;">
        <h5 class="modal-title">
          <i class="fas fa-bolt text-warning"></i>
          Capacit√©s de <strong id="modal-pokemon-name">‚Äî</strong>
        </h5>
        <button type="button" class="btn-close text-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-0">
        <div class="row g-0" style="min-height:420px;">

          <!-- ‚îÄ‚îÄ DECK ACTIF (gauche) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
          <div class="col-md-5 border-right" style="background:#f8f9fa;">
            <div class="p-3 border-bottom" style="background:linear-gradient(135deg,#1a1a2e,#16213e);">
              <h6 class="mb-0 fw-bold text-white">
                <i class="fas fa-shield-alt text-success"></i> Deck actif
                <small class="fw-normal ms-1" style="opacity:.7;">(max 4)</small>
              </h6>
              <small style="opacity:.55;color:#fff;font-size:.72rem;">
                <i class="fas fa-grip-vertical me-1"></i>Glisser pour r√©ordonner les slots
              </small>
            </div>
            <div class="p-3" id="active-moves-list">
              <div class="text-center text-muted py-4">
                <i class="fas fa-spinner fa-spin"></i> Chargement...
              </div>
            </div>
          </div>

          <!-- ‚îÄ‚îÄ FL√àCHE s√©parateur ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
          <div class="col-md-2 d-flex flex-column align-items-center justify-content-center"
               style="background:#f0f4ff; border-right:1px solid #dee2e6;">
            <div class="text-center px-2">
              <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;margin:0 auto 8px;">
                <i class="fas fa-exchange-alt fa-lg text-white"></i>
              </div>
              <p class="small text-muted mb-0" id="modal-middle-hint" style="font-size:.72rem;line-height:1.3;">Cliquez sur un move apprenable pour l'ajouter ou le substituer</p>
            </div>
          </div>

          <!-- ‚îÄ‚îÄ MOVES APPRENABLES (droite) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
          <div class="col-md-5" style="background:#fff;">
            <div class="p-3 border-bottom" style="background:linear-gradient(135deg,#0f3460,#16213e);">
              <h6 class="mb-0 fw-bold text-white">
                <i class="fas fa-book text-info"></i> Moves apprenables
                <small class="fw-normal ms-1" style="opacity:.7;">(jusqu'au niveau actuel)</small>
              </h6>
              <small style="opacity:.55;color:#fff;font-size:.72rem;">
                <i class="fas fa-mouse-pointer me-1"></i>Cliquez pour s√©lectionner
              </small>
            </div>
            <div class="p-3" id="learnable-moves-list">
              <div class="text-center text-muted py-4">
                <i class="fas fa-spinner fa-spin"></i> Chargement...
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Sous-modal de confirmation de swap (inline) -->
      <div id="swap-confirm-panel" class="d-none border-top p-3" style="background:linear-gradient(135deg,#fff8e1,#fff3cd);">
        <p class="mb-2 fw-bold text-center">
          <i class="fas fa-exchange-alt text-warning"></i>
          Remplacer <strong id="swap-remove-name" class="text-danger"></strong>
          par <strong id="swap-add-name" class="text-success"></strong> ?
        </p>
        <div class="d-flex justify-content-center gap-2">
          <button class="btn btn-success btn-sm px-4" id="swap-confirm-btn">
            <i class="fas fa-check"></i> Confirmer
          </button>
          <button class="btn btn-outline-secondary btn-sm px-3" onclick="cancelSwap()">
            <i class="fas fa-times"></i> Annuler
          </button>
        </div>
      </div>

      <div class="modal-footer">
        <small class="text-muted me-auto" id="modal-status-msg"></small>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê MODAL IV / EV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal fade" id="stats-modal" tabindex="-1" role="dialog" data-backdrop="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content border-0 shadow-lg" style="border-radius:16px;overflow:hidden;">

      <div class="modal-header py-3 px-4" style="background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;">
        <div class="d-flex align-items-center" style="gap:12px;">
          <img id="smodal-sprite" src="" alt="" style="width:56px;height:56px;object-fit:contain;">
          <div>
            <h5 class="modal-title mb-0" id="smodal-title">‚Äî</h5>
            <small id="smodal-subtitle" style="opacity:.75;"></small>
          </div>
        </div>
        <button type="button" class="btn-close text-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-0">
        <ul class="nav nav-tabs nav-justified mb-0" style="background:#f8f9fa;">
          <li class="nav-item">
            <a class="nav-link active fw-bold" data-bs-toggle="tab" href="#tab-ivev">
              <i class="fas fa-dna text-primary"></i> IV / EV
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link fw-bold" data-bs-toggle="tab" href="#tab-radar">
              <i class="fas fa-chart-area text-success"></i> Radar
            </a>
          </li>
        </ul>

        <div class="tab-content">

          <!-- ‚îÄ‚îÄ IV / EV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
          <div class="tab-pane fade show active p-4" id="tab-ivev">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span style="font-size:.85rem;">
                <i class="fas fa-coins text-warning"></i> <strong>EVs totaux :</strong>
                <span id="smodal-ev-total" class="fw-bold">‚Äî</span> / 510
              </span>
              <span style="font-size:.85rem;">
                <i class="fas fa-fingerprint text-info"></i> <strong>IVs moy. :</strong>
                <span id="smodal-iv-avg" class="fw-bold">‚Äî</span> / 31
              </span>
            </div>
            <div class="progress mb-4" style="height:6px;">
              <div id="smodal-ev-bar" class="progress-bar bg-success" style="width:0%;transition:width .6s;"></div>
            </div>

            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead>
                  <tr style="font-size:.72rem;text-transform:uppercase;letter-spacing:.05em;color:#6c757d;">
                    <th style="width:80px;">Stat</th>
                    <th class="text-center" style="width:48px;">Val.</th>
                    <th>IV <small style="font-weight:400;">(0‚Äì31)</small></th>
                    <th>EV <small style="font-weight:400;">(0‚Äì252)</small></th>
                  </tr>
                </thead>
                <tbody id="smodal-stats-body"></tbody>
              </table>
            </div>

            <div class="mt-3 p-2 rounded" style="background:#f0f4ff;font-size:.82rem;">
              <i class="fas fa-leaf text-success"></i>
              <strong>Nature :</strong>
              <span id="smodal-nature" class="fw-bold"></span>
              <span id="smodal-nature-effect" class="text-muted ms-2"></span>
            </div>
          </div>

          <!-- ‚îÄ‚îÄ Radar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
          <div class="tab-pane fade p-4" id="tab-radar">
            <div class="d-flex justify-content-center">
              <canvas id="smodal-radar" width="340" height="340"></canvas>
            </div>
            <p class="text-center text-muted mt-2" style="font-size:.75rem;">
              Stats actuelles (bleu) ¬∑ Maximum possible au niveau actuel (gris)
            </p>
          </div>

        </div>
      </div>

      <div class="modal-footer py-2">
        <small class="text-muted me-auto">
          <i class="fas fa-info-circle"></i> IV = valeurs individuelles ¬∑ EV = points d'effort
        </small>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fermer</button>
      </div>

    </div>
  </div>
</div>

{% endblock content %}

{% block css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/my-team.css' %}">
{% endblock css %}

{% block js %}
{{ block.super }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"  crossorigin="anonymous"></script>
<script>
const CSRF     = '{{ csrf_token }}';
const TEAM_MAX = 6;

// ‚îÄ‚îÄ Utilitaires ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAlert(msg, type = 'success') {
  const el = document.getElementById('team-alert');
  el.className = `alert alert-${type} mb-3`;
  el.innerHTML = msg;
  el.classList.remove('d-none');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.add('d-none'), 3500);
}

function post(url, body) {
  return fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
    body: JSON.stringify(body)
  }).then(r => r.json());
}

function getTeamCount() { return document.querySelectorAll('#team-sortable .team-slot').length; }
function getPCCount()   { return document.querySelectorAll('#pc-grid .pc-slot').length; }

function syncUI() {
  const tc = getTeamCount();
  const pc = getPCCount();

  document.getElementById('team-count').textContent = `${tc}/6`;
  document.getElementById('pc-count').textContent   = pc;

  document.querySelectorAll('.send-to-pc-btn').forEach(btn => {
    btn.disabled = (tc <= 1);
    btn.title    = (tc <= 1) ? "Dernier Pok√©mon de l'√©quipe" : '';
  });

  document.querySelectorAll('.pc-card').forEach(card => {
    card.classList.toggle('pc-card-disabled', tc >= TEAM_MAX);
  });

  document.querySelectorAll('#team-sortable .position-badge').forEach((el, i) => {
    el.textContent = `#${i + 1}`;
  });
}

// ‚îÄ‚îÄ Drag & Drop ‚Äî R√©ordonnement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const teamContainer = document.getElementById('team-sortable');
if (teamContainer) {
  Sortable.create(teamContainer, {
    handle: '.drag-handle',
    animation: 150,
    ghostClass: 'sortable-ghost',
    chosenClass: 'sortable-chosen',
    onEnd() {
      const order = [...teamContainer.querySelectorAll('.team-slot')]
        .map(el => parseInt(el.dataset.id));
      syncUI();
      post('/api/reorder-party/', { order }).then(data => {
        if (!data.success) showAlert('Erreur r√©ordonnement : ' + data.error, 'danger');
      });
    }
  });
}

// ‚îÄ‚îÄ Envoyer au PC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.send-to-pc-btn');
  if (!btn || btn.disabled) return;

  const id   = parseInt(btn.dataset.id);
  const name = btn.dataset.name;

  btn.disabled = true;

  post('/api/send-to-pc/', { pokemon_id: id }).then(data => {
    if (data.success) {
      document.querySelector(`#team-sortable .team-slot[data-id="${id}"]`)?.remove();
      showAlert(`<i class="fas fa-database"></i> ${name} envoy√© au PC.`, 'info');
      syncUI();
      setTimeout(() => location.reload(), 1000);
    } else {
      showAlert('Erreur : ' + data.error, 'danger');
      btn.disabled = false;
    }
  }).catch(() => { showAlert('Erreur r√©seau.', 'danger'); btn.disabled = false; });
});

// ‚îÄ‚îÄ Ajouter depuis le PC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('click', function(e) {
  const card = e.target.closest('.pc-card');
  if (!card || card.classList.contains('pc-card-disabled')) return;

  const id   = parseInt(card.dataset.id);
  const name = card.dataset.name;

  if (getTeamCount() >= TEAM_MAX) {
    showAlert('√âquipe compl√®te (6/6) ‚Äî envoyez d\'abord un Pok√©mon au PC.', 'warning');
    return;
  }

  card.style.opacity        = '.45';
  card.style.pointerEvents  = 'none';

  post('/api/add-to-party/', { pokemon_id: id }).then(data => {
    if (data.success) {
      showAlert(`<i class="fas fa-star"></i> ${name} rejoint l'√©quipe !`, 'success');
      setTimeout(() => location.reload(), 800);
    } else {
      showAlert('Erreur : ' + data.error, 'danger');
      card.style.opacity       = '';
      card.style.pointerEvents = '';
    }
  }).catch(() => {
    showAlert('Erreur r√©seau.', 'danger');
    card.style.opacity       = '';
    card.style.pointerEvents = '';
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GESTION DES CAPACIT√âS (modal)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let currentPokemonId   = null;
let pendingAddMoveId   = null;
let pendingAddMoveName = '';
let currentMovesData   = [];

// Ouvrir le modal
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.manage-moves-btn');
  if (!btn) return;

  currentPokemonId = parseInt(btn.dataset.id);
  const name       = btn.dataset.name;

  document.getElementById('modal-pokemon-name').textContent = name;
  document.getElementById('modal-status-msg').textContent   = '';
  cancelSwap();

  new bootstrap.Modal(document.getElementById('moves-modal')).show();
  loadMovesModal(currentPokemonId);
});

function loadMovesModal(pokemonId) {
  document.getElementById('active-moves-list').innerHTML   = '<div class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin"></i></div>';
  document.getElementById('learnable-moves-list').innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin"></i></div>';

  fetch(`/api/pokemon/moves/?pokemon_id=${pokemonId}`)
    .then(r => r.json())
    .then(data => {
      if (!data.success) {
        showModalStatus('Erreur : ' + data.error, 'danger');
        return;
      }
      currentMovesData = data.moves;
      renderActiveMoves(data.moves);
      renderLearnableMoves(data.learnable);
      // Mettre √† jour le hint central selon l'√©tat du deck
      const hint = document.getElementById('modal-middle-hint');
      if (hint) {
        hint.textContent = data.moves.length < 4
          ? 'Cliquez sur un move apprenable pour l\'ajouter directement'
          : 'Cliquez sur un move apprenable, puis choisissez lequel remplacer';
      }
    })
    .catch(() => showModalStatus('Erreur r√©seau.', 'danger'));
}

function categorySprite(cat) {
  const map = { physical: 'move-physical', special: 'move-special', status: 'move-status' };
  const file = map[cat] || 'move-status';
  return `<img src="/static/img/movesTypesSprites/${file}.png" alt="${cat}"
              style="width:20px;height:20px;object-fit:contain;vertical-align:middle;margin-right:3px;"
              title="${cat}">`;
}

let moveSortable = null;

function renderActiveMoves(moves) {
  const container = document.getElementById('active-moves-list');
  if (!moves.length) {
    container.innerHTML = '<p class="text-muted text-center small py-3">Aucune capacit√© active.</p>';
    return;
  }

  const deckFull = moves.length >= 4;
  const slotIcons = ['1','2','3','4'];

  container.innerHTML = moves.map((m, idx) => {
    const ppPct    = Math.round((m.current_pp / m.pp) * 100);
    const ppClass  = ppPct === 0 ? 'pp-bar-empty' : ppPct <= 33 ? 'pp-bar-low' : ppPct <= 66 ? 'pp-bar-mid' : 'pp-bar-full';
    return `
      <div class="move-card-full badge-type-${m.type.toLowerCase()} mb-2 move-active-item"
           data-move-id="${m.id}" data-move-name="${m.name}" data-index="${idx}">
        <div class="d-flex align-items-center gap-2 mb-1">
          <span class="move-drag-handle" title="Glisser pour r√©ordonner"><i class="fas fa-grip-vertical"></i></span>
          <span class="move-slot-badge">${slotIcons[idx] || (idx+1)}</span>
          <span class="move-card-name flex-grow-1">${m.name}</span>
          <span class="move-type-pill">${m.type.toUpperCase()}</span>
        </div>
        <div class="d-flex justify-content-between align-items-center small text-muted mb-1" style="padding-left:2rem;">
          <span>${categorySprite(m.category)}${m.category}</span>
          <span>${m.power ? 'üí• ' + m.power : '‚Äî'}</span>
          <span>üéØ ${m.accuracy}%</span>
        </div>
        <div class="d-flex align-items-center gap-1" style="padding-left:2rem;">
          <small class="text-muted me-1" style="white-space:nowrap;">PP</small>
          <div class="pp-bar-track flex-grow-1">
            <div class="pp-bar-fill ${ppClass}" style="width:${ppPct}%"></div>
          </div>
          <small class="ms-1 fw-bold ${m.current_pp === 0 ? 'text-danger' : ''}">${m.current_pp}/${m.pp}</small>
        </div>
        ${(pendingAddMoveId && deckFull) ? `<button class="btn btn-danger btn-sm mt-2 choose-remove-btn w-100"
          data-remove-id="${m.id}" data-remove-name="${m.name}">
          <i class="fas fa-trash-alt"></i> Remplacer par ${pendingAddMoveName}
        </button>` : ''}
      </div>
    `;
  }).join('');

  // Initialiser / r√©initialiser le Sortable
  if (moveSortable) { moveSortable.destroy(); moveSortable = null; }
  moveSortable = Sortable.create(container, {
    handle: '.move-drag-handle',
    animation: 120,
    ghostClass: 'move-sort-ghost',
    chosenClass: 'move-sort-chosen',
    onEnd() {
      const slotIcons2 = ['1','2','3','4'];
      const items = [...container.querySelectorAll('.move-active-item')];
      const newOrder = items.map(el => parseInt(el.dataset.moveId));
      const moveMap = {};
      currentMovesData.forEach(m => { moveMap[m.id] = m; });
      currentMovesData = newOrder.map(id => moveMap[id]).filter(Boolean);
      items.forEach((el, i) => {
        el.dataset.index = i;
        const slotBadge = el.querySelector('.move-slot-badge');
        if (slotBadge) slotBadge.textContent = slotIcons2[i] || (i+1);
      });
      updateCardMoves(currentPokemonId, currentMovesData);

      // Persister l'ordre en base
      post('/api/pokemon/reorder-moves/', {
        pokemon_id: currentPokemonId,
        order: newOrder
      }).then(data => {
        if (data.success) {
          showModalStatus('‚úÖ Ordre sauvegard√©', 'success');
          currentMovesData = data.moves;
        } else {
          showModalStatus('Erreur r√©ordonnement : ' + data.error, 'danger');
          // Recharger pour revenir √† l'√©tat serveur en cas d'erreur
          loadMovesModal(currentPokemonId);
        }
      }).catch(() => {
        showModalStatus('Erreur r√©seau.', 'danger');
        loadMovesModal(currentPokemonId);
      });
    }
  });
}

function renderLearnableMoves(learnable) {
  const container = document.getElementById('learnable-moves-list');
  if (!learnable.length) {
    container.innerHTML = '<p class="text-muted text-center small py-3">Tous les moves disponibles sont d√©j√† dans le deck.</p>';
    return;
  }

  container.innerHTML = learnable.map(m => {
    return `
      <div class="move-card-full move-learnable badge-type-${m.type.toLowerCase()} mb-2"
           data-move-id="${m.id}" data-move-name="${m.name}"
           onclick="selectLearnableMove(${m.id}, '${m.name.replace(/'/g, "\\'")}')">
        <div class="d-flex justify-content-between align-items-start mb-1">
          <span class="move-card-name">${m.name}</span>
          <span class="move-type-pill">${m.type.toUpperCase()}</span>
        </div>
        <div class="d-flex justify-content-between small text-muted">
          <span>${categorySprite(m.category)}${m.category}</span>
          <span>${m.power ? 'üí• ' + m.power : '‚Äî'}</span>
          <span>üéØ ${m.accuracy}%</span>
          <span class="text-info">Niv. ${m.level_learned}</span>
        </div>
        <div class="mt-1 small text-muted">PP max : <strong>${m.pp}</strong></div>
      </div>
    `;
  }).join('');
}

function selectLearnableMove(moveId, moveName) {
  pendingAddMoveId   = moveId;
  pendingAddMoveName = moveName;

  // Mettre en √©vidence la s√©lection
  document.querySelectorAll('.move-learnable').forEach(el => {
    el.classList.toggle('move-learnable-selected', parseInt(el.dataset.moveId) === moveId);
  });

  const deckFull = currentMovesData.length >= 4;

  if (!deckFull) {
    // Ajout direct : afficher confirmation sans choisir de move √† supprimer
    document.getElementById('swap-remove-name').textContent = '‚Äî';
    document.getElementById('swap-add-name').textContent    = moveName;
    document.getElementById('swap-confirm-panel').classList.remove('d-none');

    // Mettre √† jour le libell√© du panneau de confirmation
    const panel = document.getElementById('swap-confirm-panel');
    panel.querySelector('p').innerHTML = `
      <i class="fas fa-plus-circle text-success"></i>
      Ajouter <strong class="text-success">${moveName}</strong> au deck ?
    `;

    document.getElementById('swap-confirm-btn').onclick = () => confirmSwap(null, moveId);

  } else {
    // Deck plein : r√©-afficher les moves actifs avec les boutons "Remplacer"
    renderActiveMoves(currentMovesData);
    document.getElementById('swap-add-name').textContent = moveName;
    document.getElementById('swap-confirm-panel').classList.add('d-none');

    // Binder les boutons "Remplacer"
    document.querySelectorAll('.choose-remove-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const removeId   = parseInt(this.dataset.removeId);
        const removeName = this.dataset.removeName;

        const panel = document.getElementById('swap-confirm-panel');
        panel.querySelector('p').innerHTML = `
          <i class="fas fa-exchange-alt text-warning"></i>
          Remplacer <strong class="text-danger">${removeName}</strong>
          par <strong class="text-success">${moveName}</strong> ?
        `;
        document.getElementById('swap-confirm-panel').classList.remove('d-none');
        document.getElementById('swap-confirm-btn').onclick = () => confirmSwap(removeId, moveId);
      });
    });
  }
}

function cancelSwap() {
  pendingAddMoveId   = null;
  pendingAddMoveName = '';
  const panel = document.getElementById('swap-confirm-panel');
  if (panel) {
    panel.classList.add('d-none');
    // R√©initialiser le libell√© par d√©faut
    panel.querySelector('p').innerHTML = `
      <i class="fas fa-exchange-alt text-warning"></i>
      Remplacer <strong id="swap-remove-name" class="text-danger"></strong>
      par <strong id="swap-add-name" class="text-success"></strong> ?
    `;
  }
  document.querySelectorAll('.move-learnable-selected').forEach(el => el.classList.remove('move-learnable-selected'));
  if (currentMovesData.length) renderActiveMoves(currentMovesData);
}

function confirmSwap(removeId, addId) {
  document.getElementById('swap-confirm-btn').disabled = true;
  document.getElementById('modal-status-msg').textContent = '';

  post('/api/pokemon/swap-move/', {
    pokemon_id:     currentPokemonId,
    remove_move_id: removeId,
    add_move_id:    addId
  }).then(data => {
    document.getElementById('swap-confirm-btn').disabled = false;
    if (data.success) {
      showModalStatus('‚úÖ Capacit√© mise √† jour !', 'success');
      currentMovesData = data.moves;
      pendingAddMoveId   = null;
      pendingAddMoveName = '';
      // R√©initialiser le panneau de confirmation (restaurer les IDs d√©truits par innerHTML)
      const panelAfter = document.getElementById('swap-confirm-panel');
      panelAfter.classList.add('d-none');
      panelAfter.querySelector('p').innerHTML = `
        <i class="fas fa-exchange-alt text-warning"></i>
        Remplacer <strong id="swap-remove-name" class="text-danger"></strong>
        par <strong id="swap-add-name" class="text-success"></strong> ?
      `;
      document.querySelectorAll('.move-learnable-selected').forEach(el => el.classList.remove('move-learnable-selected'));
      // Recharger les deux colonnes
      loadMovesModal(currentPokemonId);
      // Mettre √† jour les chips sur la card √©quipe
      updateCardMoves(currentPokemonId, data.moves);
    } else {
      showModalStatus('Erreur : ' + data.error, 'danger');
    }
  }).catch(() => {
    document.getElementById('swap-confirm-btn').disabled = false;
    showModalStatus('Erreur r√©seau.', 'danger');
  });
}

function showModalStatus(msg, type) {
  const el = document.getElementById('modal-status-msg');
  el.textContent  = msg;
  el.style.color  = type === 'success' ? '#28a745' : '#dc3545';
}

// Mettre √† jour les chips de moves dans la card √©quipe sans reload
function updateCardMoves(pokemonId, moves) {
  const slot = document.querySelector(`.team-slot[data-id="${pokemonId}"]`);
  if (!slot) return;
  const grid = slot.querySelector('.moves-mini-grid');
  if (!grid) return;

  grid.innerHTML = moves.map(m => {
    const ppPct   = Math.round((m.current_pp / m.pp) * 100);
    const ppClass = m.current_pp === 0 ? 'pp-empty' : ppPct <= 33 ? 'pp-low' : '';
    return `<div class="move-mini-chip badge-type-${m.type.toLowerCase()}">
      <span class="move-mini-name">${m.name}</span>
      <span class="move-mini-pp ${ppClass}">${m.current_pp}/${m.pp}</span>
    </div>`;
  }).join('');
}


// ‚îÄ‚îÄ Modal Stats IV/EV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const NATURE_EFFECTS = {
  Hardy:{},Docile:{},Serious:{},Bashful:{},Quirky:{},
  Lonely:{up:'attack',down:'defense'},Brave:{up:'attack',down:'speed'},
  Adamant:{up:'attack',down:'special_attack'},Naughty:{up:'attack',down:'special_defense'},
  Bold:{up:'defense',down:'attack'},Relaxed:{up:'defense',down:'speed'},
  Impish:{up:'defense',down:'special_attack'},Lax:{up:'defense',down:'special_defense'},
  Timid:{up:'speed',down:'attack'},Hasty:{up:'speed',down:'defense'},
  Jolly:{up:'speed',down:'special_attack'},Naive:{up:'speed',down:'special_defense'},
  Modest:{up:'special_attack',down:'attack'},Mild:{up:'special_attack',down:'defense'},
  Quiet:{up:'special_attack',down:'speed'},Rash:{up:'special_attack',down:'special_defense'},
  Calm:{up:'special_defense',down:'attack'},Gentle:{up:'special_defense',down:'defense'},
  Sassy:{up:'special_defense',down:'speed'},Careful:{up:'special_defense',down:'special_attack'},
};
const NATURE_FR = {
  attack:'ATK', defense:'DEF', special_attack:'SpA', special_defense:'SpD', speed:'VIT'
};

const STAT_ROWS = [
  { key:'hp',  label:'PV',  natKey:'hp'              },
  { key:'atk', label:'ATK', natKey:'attack'          },
  { key:'def', label:'DEF', natKey:'defense'         },
  { key:'spa', label:'SpA', natKey:'special_attack'  },
  { key:'spd', label:'SpD', natKey:'special_defense' },
  { key:'spe', label:'VIT', natKey:'speed'           },
];

/**
 * Formule Gen 3 pour la stat max au niveau L :
 *   HP  : floor((2*base + 31 + floor(252/4)) * L / 100) + L + 10
 *   Autre: floor((floor((2*base + 31 + 63) * L / 100) + 5) * 1.1)  (nature +10%)
 */
function calcMaxStat(base, level, isHp, natMult) {
  const inner = Math.floor((2 * base + 31 + 63) * level / 100);
  if (isHp) return inner + level + 10;
  return Math.floor((inner + 5) * natMult);
}

document.addEventListener('click', function(e) {
  const btn = e.target.closest('.stats-btn');
  if (!btn) return;

  const d = btn.dataset;
  const level  = parseInt(d.level);
  const nature = d.nature || 'Hardy';
  const nat    = NATURE_EFFECTS[nature] || {};

  const ivs   = { hp:+d.ivHp,  atk:+d.ivAtk,  def:+d.ivDef,  spa:+d.ivSpa,  spd:+d.ivSpd,  spe:+d.ivSpe  };
  const evs   = { hp:+d.evHp,  atk:+d.evAtk,  def:+d.evDef,  spa:+d.evSpa,  spd:+d.evSpd,  spe:+d.evSpe  };
  const stats = { hp:+d.statHp,atk:+d.statAtk, def:+d.statDef,spa:+d.statSpa,spd:+d.statSpd,spe:+d.statSpe};
  const bases = { hp:+d.baseHp,atk:+d.baseAtk, def:+d.baseDef,spa:+d.baseSpa,spd:+d.baseSpd,spe:+d.baseSpe};

  // Sprite
  const folder = d.shiny === '1' ? 'shiny' : 'normal';
  document.getElementById('smodal-sprite').src = `/static/img/sprites_gen5/${folder}/${d.species}.png`;
  document.getElementById('smodal-title').textContent    = d.name;
  document.getElementById('smodal-subtitle').textContent = `Niv. ${level} ¬∑ Nature ${nature}`;

  // Total EV
  const evTotal = Object.values(evs).reduce((a,b)=>a+b, 0);
  document.getElementById('smodal-ev-total').textContent = evTotal;
  const evBar = document.getElementById('smodal-ev-bar');
  evBar.style.width = Math.min(100, (evTotal/510)*100) + '%';
  evBar.className = 'progress-bar ' + (evTotal >= 500 ? 'bg-danger' : evTotal >= 400 ? 'bg-warning' : 'bg-success');

  // Moyenne IV
  const ivAvg = (Object.values(ivs).reduce((a,b)=>a+b,0) / 6).toFixed(1);
  document.getElementById('smodal-iv-avg').textContent = ivAvg;

  // Nature
  document.getElementById('smodal-nature').textContent = nature;
  document.getElementById('smodal-nature-effect').innerHTML = nat.up
    ? `<span style="color:#27ae60">‚ñ≤ ${NATURE_FR[nat.up]}</span> / <span style="color:#e74c3c">‚ñº ${NATURE_FR[nat.down]}</span>`
    : '(neutre)';

  // Tableau IV/EV
  const tbody = document.getElementById('smodal-stats-body');
  tbody.innerHTML = '';
  STAT_ROWS.forEach(row => {
    const iv  = ivs[row.key];
    const ev  = evs[row.key];
    const val = stats[row.key];
    const ivPct = Math.round((iv / 31)  * 100);
    const evPct = Math.round((ev / 252) * 100);

    // Couleur de la barre IV selon la qualit√© (neutre ‚Üí vert progressif)
    const ivBarColor = iv === 31 ? '#f59e0b'   // max : or
                     : iv >= 28  ? '#22c55e'   // excellent : vert
                     : iv >= 20  ? '#3b82f6'   // bon : bleu
                     : iv >= 10  ? '#94a3b8'   // moyen : gris ardoise
                     :             '#ef4444';  // faible : rouge

    // √âtoiles IV
    const ivStars = iv === 31 ? '<span style="color:#f59e0b;font-size:.8rem;">‚òÖ‚òÖ‚òÖ</span>'
                  : iv >= 28  ? '<span style="color:#22c55e;font-size:.8rem;">‚òÖ‚òÖ</span>'
                  : iv >= 20  ? '<span style="color:#3b82f6;font-size:.8rem;">‚òÖ</span>' : '';

    const isUp   = nat.up   === row.natKey;
    const isDown = nat.down === row.natKey;
    const lblCls = isUp ? 'text-success fw-bold' : isDown ? 'text-danger' : '';

    tbody.innerHTML += `
      <tr>
        <td>
          <strong class="${lblCls}">${row.label}</strong>
          ${isUp   ? '<small class="text-success ms-1" style="font-size:.75rem;">‚ñ≤</small>' : ''}
          ${isDown ? '<small class="text-danger ms-1"  style="font-size:.75rem;">‚ñº</small>' : ''}
        </td>
        <td class="text-center fw-bold ${lblCls}">${val}</td>
        <td>
          <div class="d-flex align-items-center" style="gap:6px;">
            <span style="min-width:22px;font-weight:700;">${iv}</span>
            ${ivStars}
            <div style="flex:1;height:6px;background:#e9ecef;border-radius:3px;overflow:hidden;min-width:60px;">
              <div style="height:100%;width:${ivPct}%;background:${ivBarColor};border-radius:3px;transition:width .4s;"></div>
            </div>
          </div>
        </td>
        <td>
          <div class="d-flex align-items-center" style="gap:6px;">
            <span style="min-width:26px;font-weight:700;">${ev}</span>
            <div style="flex:1;height:6px;background:#e9ecef;border-radius:3px;overflow:hidden;min-width:60px;">
              <div style="height:100%;width:${evPct}%;background:#6366f1;border-radius:3px;transition:width .4s;"></div>
            </div>
          </div>
        </td>
      </tr>`;
  });

  // Radar avec max r√©els calcul√©s depuis les stats de base
  drawRadar(stats, bases, level, nat);

  new bootstrap.Modal(document.getElementById('stats-modal')).show();
});

function drawRadar(stats, bases, level, nat) {
  const canvas = document.getElementById('smodal-radar');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);

  const cx = W / 2, cy = H / 2;
  const R  = Math.min(W, H) * 0.36;
  const labels  = ['PV',  'ATK', 'DEF', 'SpA',  'SpD',  'VIT'];
  const statKeys = ['hp', 'atk', 'def', 'spa',  'spd',  'spe'];
  const baseKeys = ['hp', 'atk', 'def', 'spa',  'spd',  'spe'];
  const isHp    = [true, false, false, false, false, false];
  const N = labels.length;

  // Calculer les max r√©els pour chaque stat (IV=31, EV=252, nature +10%)
  const natKeys = { atk:'attack', def:'defense', spa:'special_attack', spd:'special_defense', spe:'speed' };
  const maxVals = statKeys.map((k, i) => {
    const natMult = (nat.up && natKeys[k] === nat.up) ? 1.1
                  : (nat.down && natKeys[k] === nat.down) ? 0.9 : 1.0;
    return calcMaxStat(bases[baseKeys[i]], level, isHp[i], natMult);
  });

  const vals = statKeys.map(k => stats[k] || 0);
  const angle = i => (i * 2 * Math.PI / N) - Math.PI / 2;

  // Grille de fond (cerles concentriques)
  [0.25, 0.5, 0.75, 1].forEach(frac => {
    ctx.beginPath();
    for (let i = 0; i < N; i++) {
      const a = angle(i);
      const x = cx + Math.cos(a) * R * frac;
      const y = cy + Math.sin(a) * R * frac;
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.closePath();
    ctx.strokeStyle = frac === 1 ? 'rgba(0,0,0,.15)' : 'rgba(0,0,0,.07)';
    ctx.lineWidth = frac === 1 ? 1.5 : 1;
    ctx.stroke();
  });

  // Axes
  for (let i = 0; i < N; i++) {
    const a = angle(i);
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + Math.cos(a) * R, cy + Math.sin(a) * R);
    ctx.strokeStyle = 'rgba(0,0,0,.1)';
    ctx.lineWidth = 1;
    ctx.stroke();
  }

  // Zone max (gris clair)
  ctx.beginPath();
  for (let i = 0; i < N; i++) {
    const a = angle(i);
    const x = cx + Math.cos(a) * R;
    const y = cy + Math.sin(a) * R;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.closePath();
  ctx.fillStyle   = 'rgba(180,180,180,.18)';
  ctx.strokeStyle = 'rgba(150,150,150,.4)';
  ctx.lineWidth   = 1;
  ctx.fill();
  ctx.stroke();

  // Zone stats actuelles
  ctx.beginPath();
  vals.forEach((v, i) => {
    const frac = Math.min(1, v / maxVals[i]);
    const a = angle(i);
    const x = cx + Math.cos(a) * R * frac;
    const y = cy + Math.sin(a) * R * frac;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.closePath();
  ctx.fillStyle   = 'rgba(52,152,219,.3)';
  ctx.strokeStyle = 'rgba(41,128,185,.9)';
  ctx.lineWidth   = 2;
  ctx.fill();
  ctx.stroke();

  // Points
  vals.forEach((v, i) => {
    const frac = Math.min(1, v / maxVals[i]);
    const a = angle(i);
    ctx.beginPath();
    ctx.arc(cx + Math.cos(a) * R * frac, cy + Math.sin(a) * R * frac, 4, 0, 2 * Math.PI);
    ctx.fillStyle = '#2980b9';
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 1.5;
    ctx.stroke();
  });

  // Labels avec valeur actuelle et max
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  labels.forEach((label, i) => {
    const a    = angle(i);
    const dist = R + 22;
    const lx   = cx + Math.cos(a) * dist;
    const ly   = cy + Math.sin(a) * dist;
    ctx.font      = 'bold 11px sans-serif';
    ctx.fillStyle = '#2c3e50';
    ctx.fillText(label, lx, ly);
    ctx.font      = '9px sans-serif';
    ctx.fillStyle = '#7f8c8d';
    ctx.fillText(`${vals[i]}/${maxVals[i]}`, lx, ly + 13);
  });
}

syncUI();
</script>

{% endblock js %}