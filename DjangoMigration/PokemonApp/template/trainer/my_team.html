{% extends "base.html" %}
{% load static %} {% load custom_filters %}

{% block title %}
<title>Mon Ã‰quipe - PokÃ©mon Gen 1</title>
{% endblock title %}

{% block content %}
<!-- Header -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0 text-gray-800">
    <i class="fas fa-users text-success"></i> Mon Ã‰quipe
  </h1>
  <div class="d-flex align-items-center gap-2">
    <span class="badge badge-primary p-2">
      <i class="fas fa-medal"></i> {{ trainer.badges }} badge{% if trainer.badges != 1 %}s{% endif %}
    </span>
    <span class="badge badge-warning p-2">
      <i class="fas fa-coins"></i> {{ trainer.money }}â‚½
    </span>
  </div>
</div>

<!-- Notification inline -->
<div id="team-alert" class="alert d-none mb-3" role="alert"></div>

<!-- â•â•â• Ã‰QUIPE ACTIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex align-items-center justify-content-between">
    <h6 class="m-0 font-weight-bold text-primary">
      <i class="fas fa-star"></i> Ã‰quipe Active
      <span class="badge badge-light ml-1" id="team-count">{{ team|length }}/6</span>
    </h6>
    <small class="text-muted">
      <i class="fas fa-grip-vertical"></i> Glisser-dÃ©poser pour rÃ©ordonner
    </small>
  </div>
  <div class="card-body">
    {% if team %}
    <div id="team-sortable" class="row">
      {% for pokemon in team %}
      <div class="col-md-6 col-lg-4 mb-3 team-slot" data-id="{{ pokemon.id }}">
        <div class="card pokemon-card h-100 border-success">
          <!-- Drag handle -->
          <div class="drag-handle card-header py-1 px-2 d-flex align-items-center justify-content-between bg-light">
            <i class="fas fa-grip-horizontal text-muted"></i>
            <small class="text-muted position-badge">#{{ forloop.counter }}</small>
          </div>

          <div class="card-body pt-2 pb-1">
            <div class="d-flex align-items-center mb-2">
              <img src="{% static 'img/sprites_gen5/' %}{% if pokemon.is_shiny %}shiny{% else %}normal{% endif %}/{{ pokemon.species.name|lowerPokemonFileNames }}.png"
                   alt="{{ pokemon.species.name }}"
                   class="pokemon-sprite-sm mr-3"
                   onerror="this.src='{% static 'img/pokeball.png' %}'">
              <div class="flex-grow-1 min-w-0">
                <h6 class="mb-0 text-truncate">
                  {% if pokemon.nickname %}
                    <strong>{{ pokemon.nickname }}</strong>
                    <small class="text-muted">({{ pokemon.species.name }})</small>
                  {% else %}
                    <strong>{{ pokemon.species.name }}</strong>
                  {% endif %}
                </h6>
                <span class="badge badge-secondary">Niv. {{ pokemon.level }}</span>
                <span class="badge badge-type-{{ pokemon.species.primary_type.name|lower }}">{{ pokemon.species.primary_type.name }}</span>
                {% if pokemon.species.secondary_type %}
                <span class="badge badge-type-{{ pokemon.species.secondary_type.name|lower }}">{{ pokemon.species.secondary_type.name }}</span>
                {% endif %}
              </div>
            </div>

            <!-- HP bar -->
            <div class="mb-2">
              <div class="d-flex justify-content-between" style="font-size:.75rem;">
                <span>HP</span>
                <strong>{{ pokemon.current_hp }}/{{ pokemon.max_hp }}</strong>
              </div>
              <div class="hp-bar">
                {% widthratio pokemon.current_hp pokemon.max_hp 100 as hp_pct %}
                {% with hp_int=hp_pct|default:0|add:0 %}
                <div class="hp-bar-fill {% if hp_int > 50 %}hp-high{% elif hp_int > 20 %}hp-medium{% else %}hp-low{% endif %}"
                     style="width:{{ hp_pct }}%"></div>
                {% endwith %}
              </div>
            </div>

            <!-- Mini stats -->
            <div class="row text-center small text-muted mb-1">
              <div class="col-4">{{ pokemon.attack }}<br><span style="font-size:.65rem">ATK</span></div>
              <div class="col-4">{{ pokemon.defense }}<br><span style="font-size:.65rem">DEF</span></div>
              <div class="col-4">{{ pokemon.speed }}<br><span style="font-size:.65rem">SPD</span></div>
            </div>

            <!-- Statut -->
            {% if pokemon.status_condition %}
            <div class="text-center mb-1">
              <span class="badge badge-danger">{{ pokemon.get_status_condition_display }}</span>
            </div>
            {% endif %}

            <!-- Moves actifs -->
            <div class="mb-2">
              <div class="moves-mini-grid">
                {% for mi in pokemon.pokemonmoveinstance_set.all %}
                <div class="move-mini-chip type-bg-{{ mi.move.type.name|lower }}">
                  <span class="move-mini-name">{{ mi.move.name }}</span>
                  <span class="move-mini-pp {% if mi.current_pp == 0 %}pp-empty{% elif mi.current_pp <= mi.move.pp|divisibleby:3 %}pp-low{% endif %}">{{ mi.current_pp }}/{{ mi.move.pp }}</span>
                </div>
                {% empty %}
                <span class="text-muted small">Aucune capacitÃ©</span>
                {% endfor %}
              </div>
            </div>

            <!-- XP bar -->
            <div>
              <div class="d-flex justify-content-between" style="font-size:.7rem;color:#6c757d;">
                <span>EXP</span>
                <span>{{ pokemon.current_exp }}/{{ pokemon.exp_for_next_level }}</span>
              </div>
              <div class="progress" style="height:5px;">
                {% widthratio pokemon.current_exp pokemon.exp_for_next_level 100 as exp_pct %}
                <div class="progress-bar bg-info" style="width:{{ exp_pct }}%"></div>
              </div>
            </div>
          </div>

          <div class="card-footer py-2">
            <div class="btn-group btn-group-sm w-100 mb-1">
              <a href="{% url 'PokemonDetailView' pokemon.species.id %}"
                 class="btn btn-outline-primary">
                <i class="fas fa-info-circle"></i> DÃ©tails
              </a>
              <button class="btn btn-outline-secondary manage-moves-btn"
                      data-id="{{ pokemon.id }}"
                      data-name="{{ pokemon.nickname|default:pokemon.species.name }}">
                <i class="fas fa-bolt"></i> CapacitÃ©s
              </button>
            </div>
            <button class="btn btn-outline-warning btn-sm w-100 send-to-pc-btn"
                    data-id="{{ pokemon.id }}"
                    data-name="{{ pokemon.nickname|default:pokemon.species.name }}"
                    {% if team|length <= 1 %}disabled title="Dernier PokÃ©mon de l'Ã©quipe"{% endif %}>
              <i class="fas fa-database"></i> Envoyer au PC
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5 text-muted">
      <i class="fas fa-users fa-3x mb-3 d-block"></i>
      Aucun PokÃ©mon dans l'Ã©quipe. Ajoutez-en depuis le PC ci-dessous.
    </div>
    {% endif %}
  </div>
</div>

<!-- â•â•â• PC STORAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex align-items-center justify-content-between">
    <h6 class="m-0 font-weight-bold text-info">
      <i class="fas fa-database"></i> PC â€” RÃ©serve
      <span class="badge badge-light ml-1" id="pc-count">{{ pc_pokemon|length }}</span>
    </h6>
    {% if pc_pokemon %}
    <small class="text-muted">Cliquez sur un PokÃ©mon pour l'ajouter Ã  l'Ã©quipe</small>
    {% endif %}
  </div>
  <div class="card-body">
    {% if pc_pokemon %}
    <div id="pc-grid" class="row">
      {% for pokemon in pc_pokemon %}
      <div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-3 pc-slot" id="pc-slot-{{ pokemon.id }}">
        <div class="card pc-card text-center h-100 {% if team|length >= 6 %}pc-card-disabled{% endif %}"
             data-id="{{ pokemon.id }}"
             data-name="{{ pokemon.nickname|default:pokemon.species.name }}">
          <div class="card-body p-2">
            <img src="{% static 'img/sprites_gen5/' %}{% if pokemon.is_shiny %}shiny{% else %}normal{% endif %}/{{ pokemon.species.name|lowerPokemonFileNames }}.png"
                 alt="{{ pokemon.species.name }}"
                 class="pokemon-sprite-pc"
                 onerror="this.src='{% static 'img/pokeball.png' %}'">
            <div class="mt-1 text-truncate" style="font-size:.8rem;font-weight:600;">
              {{ pokemon.nickname|default:pokemon.species.name }}
            </div>
            <small class="text-muted d-block">Niv. {{ pokemon.level }}</small>
            {% if pokemon.status_condition %}
            <span class="badge badge-danger" style="font-size:.6rem;">{{ pokemon.status_condition }}</span>
            {% endif %}
          </div>
          <div class="card-footer p-1" style="font-size:.7rem;">
            <i class="fas fa-plus-circle text-success"></i> Ã‰quipe
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-4 text-muted">
      <i class="fas fa-database fa-2x mb-2 d-block"></i>
      Le PC est vide.
    </div>
    {% endif %}
  </div>
</div>

<!-- â•â•â• INVENTAIRE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-primary">
      <i class="fas fa-shopping-bag"></i> Inventaire
    </h6>
  </div>
  <div class="card-body">
    {% if inventory %}
    <div class="table-responsive">
      <table class="table table-sm table-hover">
        <thead><tr><th>Objet</th><th>Type</th><th>QtÃ©</th><th>Description</th></tr></thead>
        <tbody>
          {% for inv_item in inventory %}
          <tr>
            <td>
              {% with path=inv_item.item|item_sprite_path %}
              {% if path %}
              <img src="{% static 'img/items_sprites/' %}{{ path }}"
                   alt="{{ inv_item.item.name }}"
                   style="width:20px;height:20px;object-fit:contain;margin-right:4px;"
                   onerror="this.style.display='none'">
              {% endif %}
              {% endwith %}
              <strong>{{ inv_item.item.name }}</strong>
            </td>
            <td><span class="badge badge-secondary">{{ inv_item.item.get_item_type_display }}</span></td>
            <td><span class="badge badge-primary">x{{ inv_item.quantity }}</span></td>
            <td><small class="text-muted">{{ inv_item.item.description|truncatewords:10 }}</small></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-center text-muted mb-0">Votre inventaire est vide.</p>
    {% endif %}
  </div>
</div>

<a href="{% url 'home' %}" class="btn btn-secondary mb-4">
  <i class="fas fa-arrow-left"></i> Retour au Dashboard
</a>

<!-- â•â•â• MODAL GESTION DES CAPACITÃ‰S â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal fade" id="moves-modal" tabindex="-1" role="dialog" data-backdrop="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header" style="background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;">
        <h5 class="modal-title">
          <i class="fas fa-bolt text-warning"></i>
          CapacitÃ©s de <strong id="modal-pokemon-name">â€”</strong>
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body p-0">
        <div class="row no-gutters" style="min-height:420px;">

          <!-- â”€â”€ DECK ACTIF (gauche) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
          <div class="col-md-5 border-right" style="background:#f8f9fa;">
            <div class="p-3 border-bottom" style="background:#e9ecef;">
              <h6 class="mb-0 font-weight-bold">
                <i class="fas fa-shield-alt text-success"></i> Deck actif
                <small class="text-muted font-weight-normal ml-1">(max 4)</small>
              </h6>
            </div>
            <div class="p-3" id="active-moves-list">
              <div class="text-center text-muted py-4">
                <i class="fas fa-spinner fa-spin"></i> Chargement...
              </div>
            </div>
          </div>

          <!-- â”€â”€ FLÃˆCHE sÃ©parateur â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
          <div class="col-md-2 d-flex flex-column align-items-center justify-content-center"
               style="background:#f0f4ff; border-right:1px solid #dee2e6;">
            <div class="text-center text-muted px-2">
              <i class="fas fa-exchange-alt fa-2x mb-2 text-primary"></i>
              <p class="small mb-0">Cliquez sur un move apprenable pour choisir lequel remplacer</p>
            </div>
          </div>

          <!-- â”€â”€ MOVES APPRENABLES (droite) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
          <div class="col-md-5" style="background:#fff;">
            <div class="p-3 border-bottom" style="background:#e9ecef;">
              <h6 class="mb-0 font-weight-bold">
                <i class="fas fa-book text-info"></i> Moves apprenables
                <small class="text-muted font-weight-normal ml-1">(jusqu'au niveau actuel)</small>
              </h6>
            </div>
            <div class="p-3" id="learnable-moves-list">
              <div class="text-center text-muted py-4">
                <i class="fas fa-spinner fa-spin"></i> Chargement...
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Sous-modal de confirmation de swap (inline) -->
      <div id="swap-confirm-panel" class="d-none border-top p-3" style="background:#fff8e1;">
        <p class="mb-2 font-weight-bold text-center">
          <i class="fas fa-exchange-alt text-warning"></i>
          Remplacer <strong id="swap-remove-name" class="text-danger"></strong>
          par <strong id="swap-add-name" class="text-success"></strong> ?
        </p>
        <div class="d-flex justify-content-center gap-2">
          <button class="btn btn-success btn-sm" id="swap-confirm-btn">
            <i class="fas fa-check"></i> Confirmer
          </button>
          <button class="btn btn-secondary btn-sm" onclick="cancelSwap()">
            <i class="fas fa-times"></i> Annuler
          </button>
        </div>
      </div>

      <div class="modal-footer">
        <small class="text-muted mr-auto" id="modal-status-msg"></small>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block js %}
{{ block.super }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"  crossorigin="anonymous"></script>
<script>
const CSRF     = '{{ csrf_token }}';
const TEAM_MAX = 6;

// â”€â”€ Utilitaires â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAlert(msg, type = 'success') {
  const el = document.getElementById('team-alert');
  el.className = `alert alert-${type} mb-3`;
  el.innerHTML = msg;
  el.classList.remove('d-none');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.add('d-none'), 3500);
}

function post(url, body) {
  return fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
    body: JSON.stringify(body)
  }).then(r => r.json());
}

function getTeamCount() { return document.querySelectorAll('#team-sortable .team-slot').length; }
function getPCCount()   { return document.querySelectorAll('#pc-grid .pc-slot').length; }

function syncUI() {
  const tc = getTeamCount();
  const pc = getPCCount();

  document.getElementById('team-count').textContent = `${tc}/6`;
  document.getElementById('pc-count').textContent   = pc;

  document.querySelectorAll('.send-to-pc-btn').forEach(btn => {
    btn.disabled = (tc <= 1);
    btn.title    = (tc <= 1) ? "Dernier PokÃ©mon de l'Ã©quipe" : '';
  });

  document.querySelectorAll('.pc-card').forEach(card => {
    card.classList.toggle('pc-card-disabled', tc >= TEAM_MAX);
  });

  document.querySelectorAll('#team-sortable .position-badge').forEach((el, i) => {
    el.textContent = `#${i + 1}`;
  });
}

// â”€â”€ Drag & Drop â€” RÃ©ordonnement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const teamContainer = document.getElementById('team-sortable');
if (teamContainer) {
  Sortable.create(teamContainer, {
    handle: '.drag-handle',
    animation: 150,
    ghostClass: 'sortable-ghost',
    chosenClass: 'sortable-chosen',
    onEnd() {
      const order = [...teamContainer.querySelectorAll('.team-slot')]
        .map(el => parseInt(el.dataset.id));
      syncUI();
      post('/api/reorder-party/', { order }).then(data => {
        if (!data.success) showAlert('Erreur rÃ©ordonnement : ' + data.error, 'danger');
      });
    }
  });
}

// â”€â”€ Envoyer au PC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.send-to-pc-btn');
  if (!btn || btn.disabled) return;

  const id   = parseInt(btn.dataset.id);
  const name = btn.dataset.name;
  if (!confirm(`Envoyer ${name} au PC ?`)) return;

  btn.disabled = true;

  post('/api/send-to-pc/', { pokemon_id: id }).then(data => {
    if (data.success) {
      document.querySelector(`#team-sortable .team-slot[data-id="${id}"]`)?.remove();
      showAlert(`<i class="fas fa-database"></i> ${name} envoyÃ© au PC.`, 'info');
      syncUI();
      setTimeout(() => location.reload(), 1000);
    } else {
      showAlert('Erreur : ' + data.error, 'danger');
      btn.disabled = false;
    }
  }).catch(() => { showAlert('Erreur rÃ©seau.', 'danger'); btn.disabled = false; });
});

// â”€â”€ Ajouter depuis le PC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('click', function(e) {
  const card = e.target.closest('.pc-card');
  if (!card || card.classList.contains('pc-card-disabled')) return;

  const id   = parseInt(card.dataset.id);
  const name = card.dataset.name;

  if (getTeamCount() >= TEAM_MAX) {
    showAlert('Ã‰quipe complÃ¨te (6/6) â€” envoyez d\'abord un PokÃ©mon au PC.', 'warning');
    return;
  }

  card.style.opacity        = '.45';
  card.style.pointerEvents  = 'none';

  post('/api/add-to-party/', { pokemon_id: id }).then(data => {
    if (data.success) {
      showAlert(`<i class="fas fa-star"></i> ${name} rejoint l'Ã©quipe !`, 'success');
      setTimeout(() => location.reload(), 800);
    } else {
      showAlert('Erreur : ' + data.error, 'danger');
      card.style.opacity       = '';
      card.style.pointerEvents = '';
    }
  }).catch(() => {
    showAlert('Erreur rÃ©seau.', 'danger');
    card.style.opacity       = '';
    card.style.pointerEvents = '';
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTION DES CAPACITÃ‰S (modal)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentPokemonId   = null;
let pendingAddMoveId   = null;
let pendingAddMoveName = '';
let currentMovesData   = [];

// Ouvrir le modal
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.manage-moves-btn');
  if (!btn) return;

  currentPokemonId = parseInt(btn.dataset.id);
  const name       = btn.dataset.name;

  document.getElementById('modal-pokemon-name').textContent = name;
  document.getElementById('modal-status-msg').textContent   = '';
  cancelSwap();

  $('#moves-modal').modal('show');
  loadMovesModal(currentPokemonId);
});

function loadMovesModal(pokemonId) {
  document.getElementById('active-moves-list').innerHTML   = '<div class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin"></i></div>';
  document.getElementById('learnable-moves-list').innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin"></i></div>';

  fetch(`/api/pokemon/moves/?pokemon_id=${pokemonId}`)
    .then(r => r.json())
    .then(data => {
      if (!data.success) {
        showModalStatus('Erreur : ' + data.error, 'danger');
        return;
      }
      currentMovesData = data.moves;
      renderActiveMoves(data.moves);
      renderLearnableMoves(data.learnable);
    })
    .catch(() => showModalStatus('Erreur rÃ©seau.', 'danger'));
}

function renderActiveMoves(moves) {
  const container = document.getElementById('active-moves-list');
  if (!moves.length) {
    container.innerHTML = '<p class="text-muted text-center small py-3">Aucune capacitÃ© active.</p>';
    return;
  }

  container.innerHTML = moves.map(m => {
    const ppPct    = Math.round((m.current_pp / m.pp) * 100);
    const ppClass  = ppPct === 0 ? 'pp-bar-empty' : ppPct <= 33 ? 'pp-bar-low' : ppPct <= 66 ? 'pp-bar-mid' : 'pp-bar-full';
    const catIcon  = m.category === 'physical' ? 'âš”ï¸' : m.category === 'special' ? 'âœ¨' : 'ğŸ”µ';
    return `
      <div class="move-card-full type-bg-${m.type.toLowerCase()} mb-2" data-move-id="${m.id}" data-move-name="${m.name}">
        <div class="d-flex justify-content-between align-items-start mb-1">
          <span class="move-card-name">${m.name}</span>
          <span class="move-type-pill">${m.type.toUpperCase()}</span>
        </div>
        <div class="d-flex justify-content-between align-items-center small text-muted mb-1">
          <span>${catIcon} ${m.category}</span>
          <span>${m.power ? 'ğŸ’¥ ' + m.power : 'â€”'}</span>
          <span>ğŸ¯ ${m.accuracy}%</span>
        </div>
        <div class="d-flex align-items-center gap-1">
          <small class="text-muted mr-1" style="white-space:nowrap;">PP</small>
          <div class="pp-bar-track flex-grow-1">
            <div class="pp-bar-fill ${ppClass}" style="width:${ppPct}%"></div>
          </div>
          <small class="ml-1 font-weight-bold ${m.current_pp === 0 ? 'text-danger' : ''}">${m.current_pp}/${m.pp}</small>
        </div>
        ${pendingAddMoveId ? `<button class="btn btn-danger btn-sm btn-block mt-2 choose-remove-btn" data-remove-id="${m.id}" data-remove-name="${m.name}">
          <i class="fas fa-trash-alt"></i> Remplacer par ${pendingAddMoveName}
        </button>` : ''}
      </div>
    `;
  }).join('');
}

function renderLearnableMoves(learnable) {
  const container = document.getElementById('learnable-moves-list');
  if (!learnable.length) {
    container.innerHTML = '<p class="text-muted text-center small py-3">Tous les moves disponibles sont dÃ©jÃ  dans le deck.</p>';
    return;
  }

  container.innerHTML = learnable.map(m => {
    const catIcon = m.category === 'physical' ? 'âš”ï¸' : m.category === 'special' ? 'âœ¨' : 'ğŸ”µ';
    return `
      <div class="move-card-full move-learnable type-bg-${m.type.toLowerCase()} mb-2"
           data-move-id="${m.id}" data-move-name="${m.name}"
           onclick="selectLearnableMove(${m.id}, '${m.name.replace(/'/g, "\\'")}')">
        <div class="d-flex justify-content-between align-items-start mb-1">
          <span class="move-card-name">${m.name}</span>
          <span class="move-type-pill">${m.type.toUpperCase()}</span>
        </div>
        <div class="d-flex justify-content-between small text-muted">
          <span>${catIcon} ${m.category}</span>
          <span>${m.power ? 'ğŸ’¥ ' + m.power : 'â€”'}</span>
          <span>ğŸ¯ ${m.accuracy}%</span>
          <span class="text-info">Niv. ${m.level_learned}</span>
        </div>
        <div class="mt-1 small text-muted">PP max : <strong>${m.pp}</strong></div>
      </div>
    `;
  }).join('');
}

function selectLearnableMove(moveId, moveName) {
  pendingAddMoveId   = moveId;
  pendingAddMoveName = moveName;

  // Mettre en Ã©vidence la sÃ©lection
  document.querySelectorAll('.move-learnable').forEach(el => {
    el.classList.toggle('move-learnable-selected', parseInt(el.dataset.moveId) === moveId);
  });

  // RÃ©-afficher les moves actifs avec les boutons "Remplacer"
  renderActiveMoves(currentMovesData);

  // Afficher le panneau de confirmation
  document.getElementById('swap-add-name').textContent = moveName;
  document.getElementById('swap-confirm-panel').classList.add('d-none'); // masquÃ© tant qu'on n'a pas cliquÃ© "remplacer"

  // Binder les boutons "Remplacer"
  document.querySelectorAll('.choose-remove-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const removeId   = parseInt(this.dataset.removeId);
      const removeName = this.dataset.removeName;
      document.getElementById('swap-remove-name').textContent = removeName;
      document.getElementById('swap-add-name').textContent   = moveName;
      document.getElementById('swap-confirm-panel').classList.remove('d-none');

      document.getElementById('swap-confirm-btn').onclick = () => confirmSwap(removeId, moveId);
    });
  });
}

function cancelSwap() {
  pendingAddMoveId   = null;
  pendingAddMoveName = '';
  document.getElementById('swap-confirm-panel')?.classList.add('d-none');
  document.querySelectorAll('.move-learnable-selected').forEach(el => el.classList.remove('move-learnable-selected'));
  if (currentMovesData.length) renderActiveMoves(currentMovesData);
}

function confirmSwap(removeId, addId) {
  document.getElementById('swap-confirm-btn').disabled = true;
  document.getElementById('modal-status-msg').textContent = '';

  post('/api/pokemon/swap-move/', {
    pokemon_id:     currentPokemonId,
    remove_move_id: removeId,
    add_move_id:    addId
  }).then(data => {
    document.getElementById('swap-confirm-btn').disabled = false;
    if (data.success) {
      showModalStatus('âœ… CapacitÃ© mise Ã  jour !', 'success');
      currentMovesData = data.moves;
      pendingAddMoveId   = null;
      pendingAddMoveName = '';
      document.getElementById('swap-confirm-panel').classList.add('d-none');
      // Recharger les deux colonnes
      loadMovesModal(currentPokemonId);
      // Mettre Ã  jour les chips sur la card Ã©quipe
      updateCardMoves(currentPokemonId, data.moves);
    } else {
      showModalStatus('Erreur : ' + data.error, 'danger');
    }
  }).catch(() => {
    document.getElementById('swap-confirm-btn').disabled = false;
    showModalStatus('Erreur rÃ©seau.', 'danger');
  });
}

function showModalStatus(msg, type) {
  const el = document.getElementById('modal-status-msg');
  el.textContent  = msg;
  el.style.color  = type === 'success' ? '#28a745' : '#dc3545';
}

// Mettre Ã  jour les chips de moves dans la card Ã©quipe sans reload
function updateCardMoves(pokemonId, moves) {
  const slot = document.querySelector(`.team-slot[data-id="${pokemonId}"]`);
  if (!slot) return;
  const grid = slot.querySelector('.moves-mini-grid');
  if (!grid) return;

  grid.innerHTML = moves.map(m => {
    const ppPct   = Math.round((m.current_pp / m.pp) * 100);
    const ppClass = m.current_pp === 0 ? 'pp-empty' : ppPct <= 33 ? 'pp-low' : '';
    return `<div class="move-mini-chip type-bg-${m.type.toLowerCase()}">
      <span class="move-mini-name">${m.name}</span>
      <span class="move-mini-pp ${ppClass}">${m.current_pp}/${m.pp}</span>
    </div>`;
  }).join('');
}

syncUI();
</script>

<style>
/* â”€â”€ Sprites â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pokemon-sprite-sm { width:64px; height:64px; object-fit:contain; flex-shrink:0; }
.pokemon-sprite-pc { width:56px; height:56px; object-fit:contain; }

/* â”€â”€ Cards Ã©quipe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pokemon-card       { transition:transform .2s,box-shadow .2s; }
.pokemon-card:hover { transform:translateY(-3px); box-shadow:0 6px 14px rgba(0,0,0,.15); }

.drag-handle        { cursor:grab; user-select:none; }
.drag-handle:active { cursor:grabbing; }
.sortable-ghost     { opacity:.3; }
.sortable-chosen    { box-shadow:0 0 0 3px #28a745!important; border-radius:.35rem; }

/* â”€â”€ Cards PC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pc-card {
  cursor:pointer;
  transition:transform .15s,box-shadow .15s,border-color .15s;
  border:2px solid transparent;
}
.pc-card:hover:not(.pc-card-disabled) {
  transform:translateY(-3px);
  box-shadow:0 4px 12px rgba(40,167,69,.4);
  border-color:#28a745;
}
.pc-card-disabled { opacity:.4; cursor:not-allowed; }

/* â”€â”€ HP bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hp-bar      { width:100%; height:8px; background:#e9ecef; border-radius:4px; overflow:hidden; }
.hp-bar-fill { height:100%; transition:width .3s; }
.hp-high     { background:#28a745; }
.hp-medium   { background:#ffc107; }
.hp-low      { background:#dc3545; }

/* â”€â”€ Moves mini chips (sur les cards) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.moves-mini-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4px;
}
.move-mini-chip {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: .68rem;
  color: #fff;
  background: #6c757d;
  min-width: 0;
}
.move-mini-name {
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
  min-width: 0;
}
.move-mini-pp {
  font-size: .62rem;
  margin-left: 4px;
  white-space: nowrap;
  opacity: .9;
  flex-shrink: 0;
}
.move-mini-pp.pp-low   { color: #ff6b35; font-weight: 700; }
.move-mini-pp.pp-empty { color: #ff0000; font-weight: 700; }

/* â”€â”€ Move cards (dans le modal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.move-card-full {
  border-radius: 8px;
  padding: 8px 10px;
  background: #6c757d;
  color: #fff;
  transition: transform .15s, box-shadow .15s;
}
.move-learnable {
  cursor: pointer;
  border: 2px solid transparent;
}
.move-learnable:hover {
  transform: translateX(3px);
  box-shadow: 0 3px 8px rgba(0,0,0,.2);
}
.move-learnable-selected {
  border-color: #ffc107 !important;
  box-shadow: 0 0 0 3px rgba(255,193,7,.4) !important;
}
.move-card-name { font-weight: 700; font-size: .9rem; }
.move-type-pill {
  font-size: .65rem;
  font-weight: 700;
  background: rgba(255,255,255,.25);
  border-radius: 20px;
  padding: 1px 7px;
  white-space: nowrap;
}

/* â”€â”€ PP bar (dans le modal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pp-bar-track { height: 6px; background: rgba(255,255,255,.3); border-radius: 3px; overflow: hidden; min-width: 40px; }
.pp-bar-fill  { height: 100%; border-radius: 3px; transition: width .3s; }
.pp-bar-full  { background: #28a745; }
.pp-bar-mid   { background: #ffc107; }
.pp-bar-low   { background: #fd7e14; }
.pp-bar-empty { background: #dc3545; }

/* â”€â”€ Couleurs de type (fond des move cards) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.type-bg-normal   { background: #a8a77a; }
.type-bg-fire     { background: #ee8130; }
.type-bg-water    { background: #6390f0; }
.type-bg-electric { background: #f7d02c; color: #333 !important; }
.type-bg-grass    { background: #7ac74c; }
.type-bg-ice      { background: #96d9d6; color: #333 !important; }
.type-bg-fighting { background: #c22e28; }
.type-bg-poison   { background: #a33ea1; }
.type-bg-ground   { background: #e2bf65; color: #333 !important; }
.type-bg-flying   { background: #a98ff3; }
.type-bg-psychic  { background: #f95587; }
.type-bg-bug      { background: #a6b91a; }
.type-bg-rock     { background: #b6a136; }
.type-bg-ghost    { background: #735797; }
.type-bg-dragon   { background: #6f35fc; }
.type-bg-dark     { background: #705746; }
.type-bg-steel    { background: #b7b7ce; color: #333 !important; }
.type-bg-fairy    { background: #d685ad; }
</style>
{% endblock js %}